---
title: 'The prognosis of a first seizure or seizure-like events a prospective single-center study'
author: "Version V4"
date: "01/10/2020"
output:
  html_document:
    toc: yes
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
---

```{r Libraries and functions, include=FALSE}
# Libraries 

library(dplyr)
library(ggplot2)
library(tidyr)
library(writexl)
library(emmeans)
library(tidyr)
library(lubridate)
library(car)
library(knitr)
library(randomForest)
library(ROCR)
library(NPL) # from https://github.com/EricMenetre/NPL -> Follow instruction on the README regarding installation
library(survival)
library(survminer)
library(car)

# functions

## Function to calculate percentages
pct.fun <- function(sub_sample, full_sample) {
  pct <- round((sub_sample * 100)/full_sample,2)
  return(paste(pct,"%", sep = ""))
}
pct.fun_n <- function(sub_sample, full_sample) {
  pct <- round((sub_sample * 100)/full_sample,2)
  return(pct)
}

# Function to create an output to report results from an lm model in the text
report_mainef_lm <- function(model){
  anova_table <- anova(model)
  
  effects <- paste("F(", anova_table$Df,") = ", round(anova_table$`F value`,2), " p = ", sep = "")
  names_eff <- rownames(anova_table)
  output <- data.frame(names_eff, effects)
  output$p <- round(anova_table$`Pr(>F)`,3)
  output$p <- ifelse(output$p == 0.000, "<0.001", output$p)
  output <-output[1:(nrow(output)-1),]
  output$effects <- paste(output$effects, output$p, sep = "")
  output$p <- NULL
  return(output)
}

# Function to create a text output for a chi2 model
report_chi <- function(chi_model){
  if(chi_model$p.value < 0.001){
    return(paste("X2 = ",round(chi_model$statistic,2), "; p<0.001", sep = ""))
  } else {
    return(paste( "X2 = ",round(chi_model$statistic,2), "; p = ", round(chi_model$p.value,3), sep = ""))
  }
  
}

# Function to create a text output for a emmeans model
report_emmeans <- function(mod_emmeans){
  post_hoc <- mod_emmeans
  if(colnames(post_hoc)[5] == "t.ratio"){
    output <- data.frame(post_hoc$contrast)
    output$report <- paste("t(", post_hoc$df,") = ", round(post_hoc$t.ratio,2), "; p ", sep = "")
    output$p <- post_hoc$p.value
    output$p <- ifelse(post_hoc$p.value < 0.001, "<0.001", paste("= ",round(post_hoc$p.value,3)))
    output$report <- paste(output$report, output$p)
    output$p <- NULL
    return(output)
    } else if(colnames(post_hoc[5]) == "z.ratio"){
    output <- data.frame(post_hoc$contrast)
    output$report <- paste("z = ", round(post_hoc$z.ratio,2), "; p", sep = "")
    output$p <- post_hoc$p.value
    output$p <- ifelse(post_hoc$p.value < 0.001, "<0.001", paste("= ", round(post_hoc$p.value,3), sep = ""))
    output$report <- paste(output$report, output$p)
    output$p <- NULL
    return(output)
    } else{
    print("Unknown format, only results from z and t distributions are available")
  }
  
}

# Function to convert numbers to words --> 1 -> one
number_to_word <- function(number){
  if(number == 0){
    return("zero")
  } else if(number == 1){
    return("one")
  }else if(number == 2){
    return("two")
  } else if(number == 3){
    return("three")
  } else if(number == 4){
    return("four")
  } else if(number == 5){
    return("five")
  } else if(number == 6){
    return("six")
  } else if(number == 7){
    return("seven")
  } else if(number == 8){
    return("eight")
  } else if(number == 9){
    return("nine")
  } else if(number == 10){
    return("ten")
  } else if(number > 10 | number < 0){
    return(number)
  } 
}

# Function to create a text output for a glm model
report_glm <- function(glm_model){
  sum_glm <- summary(glm_model)
  sum_glm <- sum_glm$coefficients
  
  names_eff <- rownames(sum_glm)
  output <- data.frame(names_eff)
  
  output$report <- paste("Z = ", round(sum_glm[,3],2), "; p ", ifelse(round(sum_glm[,4],3) < 0.001, "<0.001", paste("= ", round(sum_glm[,4],3), sep = "")), sep = "")
  output <- output[-1,]
  return(output)
}

# Function to prepare the data to be entered in the first Random Forest model

data_RF_outcome_single_tree <- function(data){
  
  library(dplyr)
  temp <- data%>%
    filter(res.1st.EEG != "aucun" )%>%
    filter(res.1st.EEG != "aucun mais propose" & res.1st.EEG != "aucun mais  propose")%>%
    filter(les.epi != "aucun" & res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
    filter(!is.na(dx.event),
           dx.event != "Unknown")%>%
    filter(type.epi.final == "lesionnelle" | type.epi.final == "non lesionnelle" | type.epi.final == "generalisee idiopathique" | is.na(type.epi.final))%>%
    filter(veille.sommeil != "non documente")%>%
    filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
    mutate(std_eeg = ifelse(res.1st.EEG == "normal", "normal", EEG.result_resume),
           std_eeg = case_when(pointes.1st.EEG == "focale" ~ "focale",
                               pointes.1st.EEG == "diffuse"~ "diffuse",
                               pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" ~ std_eeg))%>%
    mutate(res.dx.final = dx.event)%>%
    mutate(res.dx.final = ifelse(res.dx.final == "Epilepsy", "epilepsy", "non-epileptic"))%>%
    mutate(age = case_when(age >= 16 & age <= 25 ~ "16_25",
                           age > 25 & age <= 35 ~ "26_35",
                           age > 35 & age <= 45 ~ "36_45",
                           age > 45 & age <= 55 ~ "46_55",
                           age > 55 & age <= 65 ~ "56_65",
                           age > 65 & age <= 75 ~ "66_75",
                           age > 75 & age <= 85 ~ "76_85",
                           age > 85 ~ "85_plus"))%>%
    select(age, genre, atcd.famille, std_eeg, les.epi, status.neuro, veille.sommeil, res.dx.final)
  
  temp <- temp%>%
    dplyr::mutate(std_eeg = ifelse(std_eeg == "focale" | std_eeg == "diffuse", "Spikes", "No spikes"),
                  atcd.famille = ifelse(atcd.famille == "epilepsie", "Epilepsy", "other or none"),
                  les.epi = ifelse(les.epi == "lesion epileptogene", "Epileptogenic lesion", "No lesion or probably not epileptogenic"),
                  age = case_when(age == "16_25" | age == "26_35" | age == "36_45" | age == "46_55" ~ "<55",
                                  age == "56_65" | age == "66_75" | age == "76_85" | age == "85_plus" ~ ">55"),
                  status.neuro = ifelse(status.neuro == "anormal", "Abnormal", "Normal or none"),
                  res.dx.final = case_when(res.dx.final == "epilepsy" ~ "Epileptic",
                                           res.dx.final == "non-epileptic" ~ "Non epileptic"))
  
  
  
  
  temp <- as.data.frame(temp)
  
  for (i in 1:ncol(temp)){
    temp[,i] <- factor(temp[,i])
  }
  
  data_RF <<- as.data.frame(temp)
  
  # Division in training and test dataframes
  
  train_index <- sample(nrow(temp), nrow(temp)*0.75)
  data_RF_train <<- temp[train_index,]
  data_RF_test <- temp[-train_index,]
  data_RF_test <<- data_RF_test[,1:ncol(data_RF_test)-1]
  
  labels_final <- temp[,ncol(temp)]
  
  temp_labels_final <- data%>%
    filter(res.1st.EEG != "aucun" )%>%
    filter(res.1st.EEG != "aucun mais propose" & res.1st.EEG != "aucun mais  propose")%>%
    filter(les.epi != "aucun" & res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
    filter(!is.na(dx.event),
           dx.event != "Unknown")%>%
    filter(type.epi.final == "lesionnelle" | type.epi.final == "non lesionnelle" | type.epi.final == "generalisee idiopathique" | is.na(type.epi.final))%>%
    filter(veille.sommeil != "non documente")%>%
    filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
    mutate(std_eeg = ifelse(res.1st.EEG == "normal", "normal", EEG.result_resume),
           std_eeg = case_when(pointes.1st.EEG == "focale" ~ "focale",
                               pointes.1st.EEG == "diffuse"~ "diffuse",
                               pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" ~ std_eeg))%>%
    mutate(res.dx.final = dx.event)%>%
    mutate(res.dx.final = ifelse(res.dx.final == "Epilepsy", "epilepsy", "non-epileptic"))%>%
    mutate(age = case_when(age >= 16 & age <= 25 ~ "16_25",
                           age > 25 & age <= 35 ~ "26_35",
                           age > 35 & age <= 45 ~ "36_45",
                           age > 45 & age <= 55 ~ "46_55",
                           age > 55 & age <= 65 ~ "56_65",
                           age > 65 & age <= 75 ~ "66_75",
                           age > 75 & age <= 85 ~ "76_85",
                           age > 85 ~ "85_plus"))%>%
    select(age, genre,  atcd.famille, std_eeg, les.epi, status.neuro,  veille.sommeil, res.dx.final)
  
  
  labels_final_train_RF <<- labels_final[train_index]
  labels_final_test_RF <<- labels_final[-train_index]
  
  labels_initial_train_RF <<- temp_labels_final[train_index,ncol(temp_labels_final)]
  labels_initial_test_RF <<- temp_labels_final[-train_index,ncol(temp_labels_final)]
  
  labels_initial_global <<- temp$res.dx.initial
  
}

# Function to prepare the data to be entered in the second and third Random Forest models
data_RF_outcome_single_tree_LT <- function(data){
  
  library(dplyr)
  temp <- data%>%
    filter(res.1st.EEG != "aucun" )%>%
    filter(res.1st.EEG != "aucun mais propose" & res.1st.EEG != "aucun mais  propose")%>%
    filter(les.epi != "aucun" & res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
    filter(!is.na(dx.event),
           dx.event != "Unknown")%>%
    filter(type.epi.final == "lesionnelle" | type.epi.final == "non lesionnelle" | type.epi.final == "generalisee idiopathique" | is.na(type.epi.final))%>%
    filter(veille.sommeil != "non documente")%>%
    filter(res.lt.EEG != "aucun")%>%
    filter(res.lt.EEG != "aucun mais propose" & res.lt.EEG != "aucun mais  propose")%>%
    filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
    mutate(std_eeg = ifelse(res.1st.EEG == "normal", "normal", EEG.result_resume),
           std_eeg = case_when(pointes.1st.EEG == "focale" ~ "focale",
                               pointes.1st.EEG == "diffuse"~ "diffuse",
                               pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" ~ std_eeg))%>%
    mutate(lt_eeg = ifelse(res.lt.EEG == "normal", "normal", EEG.lt.result_resume),
           lt_eeg = case_when(pointes.lt.EEG == "focale" ~ "focale",
                               pointes.lt.EEG == "diffuse"~ "diffuse",
                               pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" ~ lt_eeg))%>%
    mutate(res.dx.final = dx.event)%>%
    mutate(res.dx.final = ifelse(res.dx.final == "Epilepsy", "epilepsy", "non-epileptic"))%>%
    mutate(age = case_when(age >= 16 & age <= 25 ~ "16_25",
                           age > 25 & age <= 35 ~ "26_35",
                           age > 35 & age <= 45 ~ "36_45",
                           age > 45 & age <= 55 ~ "46_55",
                           age > 55 & age <= 65 ~ "56_65",
                           age > 65 & age <= 75 ~ "66_75",
                           age > 75 & age <= 85 ~ "76_85",
                           age > 85 ~ "85_plus"))%>%
    select(age, genre,  atcd.famille, std_eeg, lt_eeg, les.epi, status.neuro, veille.sommeil, res.dx.final)
  
  temp <- temp%>%
    dplyr::mutate(std_eeg = ifelse(std_eeg == "focale" | std_eeg == "diffuse", "Spikes", "No spikes"),
                  lt_eeg = ifelse(lt_eeg == "focale" | lt_eeg == "diffuse", "Spikes", "No spikes"),
                  atcd.famille = ifelse(atcd.famille == "epilepsie", "Epilepsy", "other or none"),
                  les.epi = ifelse(les.epi == "lesion epileptogene", "Epileptogenic lesion", "No lesion or probably not epileptogenic"),
                  age = case_when(age == "16_25" | age == "26_35" | age == "36_45" | age == "46_55" ~ "<55",
                                  age == "56_65" | age == "66_75" | age == "76_85" | age == "85_plus" ~ ">55"),
                  status.neuro = ifelse(status.neuro == "anormal", "Abnormal", "Normal or none"),
                  res.dx.final = case_when(res.dx.final == "epilepsy" ~ "Epileptic",
                                           res.dx.final == "non-epileptic" ~ "Non epileptic"))
  
  
  temp <- as.data.frame(temp)
  
  for (i in 1:ncol(temp)){
    temp[,i] <- factor(temp[,i])
  }
  
  data_RF <<- as.data.frame(temp)
  
  # Division in training and test dataframes
  
  train_index <- sample(nrow(temp), nrow(temp)*0.75)
  data_RF_train <<- temp[train_index,]
  data_RF_test <- temp[-train_index,]
  data_RF_test <<- data_RF_test[,1:ncol(data_RF_test)-1]
  
  labels_final <- temp[,ncol(temp)]
  
  temp_labels_final <- data%>%
    filter(res.1st.EEG != "aucun" )%>%
    filter(res.1st.EEG != "aucun mais propose" & res.1st.EEG != "aucun mais  propose")%>%
    filter(les.epi != "aucun" & res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
    filter(!is.na(dx.event),
           dx.event != "Unknown")%>%
    filter(type.epi.final == "lesionnelle" | type.epi.final == "non lesionnelle" | type.epi.final == "generalisee idiopathique" | is.na(type.epi.final))%>%
    filter(veille.sommeil != "non documente")%>%
    filter(res.lt.EEG != "aucun")%>%
    filter(res.lt.EEG != "aucun mais propose" & res.lt.EEG != "aucun mais  propose")%>%
    filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
    mutate(std_eeg = ifelse(res.1st.EEG == "normal", "normal", EEG.result_resume),
           std_eeg = case_when(pointes.1st.EEG == "focale" ~ "focale",
                               pointes.1st.EEG == "diffuse"~ "diffuse",
                               pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" ~ std_eeg))%>%
    mutate(lt_eeg = ifelse(res.lt.EEG == "normal", "normal", EEG.lt.result_resume),
           lt_eeg = case_when(pointes.lt.EEG == "focale" ~ "focale",
                              pointes.lt.EEG == "diffuse"~ "diffuse",
                              pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" ~ lt_eeg))%>%
    mutate(res.dx.final = dx.event)%>%
    mutate(res.dx.final = ifelse(res.dx.final == "Epilepsy", "epilepsy", "non-epileptic"))%>%
    mutate(age = case_when(age >= 16 & age <= 25 ~ "16_25",
                           age > 25 & age <= 35 ~ "26_35",
                           age > 35 & age <= 45 ~ "36_45",
                           age > 45 & age <= 55 ~ "46_55",
                           age > 55 & age <= 65 ~ "56_65",
                           age > 65 & age <= 75 ~ "66_75",
                           age > 75 & age <= 85 ~ "76_85",
                           age > 85 ~ "85_plus"))%>%
    select(age, genre,atcd.famille, std_eeg, lt_eeg, les.epi, status.neuro, veille.sommeil, res.dx.final)
  
  temp_labels_final <- temp_labels_final%>%
    dplyr::mutate(std_eeg = ifelse(std_eeg == "focale" | std_eeg == "diffuse", "Spikes", "No spikes"),
                  lt_eeg = ifelse(lt_eeg == "focale" | lt_eeg == "diffuse", "Spikes", "No spikes"),
                  atcd.famille = ifelse(atcd.famille == "epilepsie", "Epilepsy", "other or none"),
                  les.epi = ifelse(les.epi == "lesion epileptogene", "Epileptogenic lesion", "No lesion or probably not epileptogenic"),
                  age = case_when(age == "16_25" | age == "26_35" | age == "36_45" | age == "46_55" ~ "<55",
                                  age == "56_65" | age == "66_75" | age == "76_85" | age == "85_plus" ~ ">55"),
                  status.neuro = ifelse(status.neuro == "anormal", "Abnormal", "Normal or none"),
                  res.dx.final = case_when(res.dx.final == "epilepsy" ~ "Epileptic",
                                           res.dx.final == "non-epileptic" ~ "Non epileptic"))
  
  labels_final_train_RF <<- labels_final[train_index]
  labels_final_test_RF <<- labels_final[-train_index]
  
  labels_initial_train_RF <<- temp_labels_final[train_index,ncol(temp_labels_final)]
  labels_initial_test_RF <<- temp_labels_final[-train_index,ncol(temp_labels_final)]
  
  labels_initial_global <<- temp$res.dx.initial
  
}

```

```{r data importation, include=FALSE}

##################################################################
##                       DATA IMPORTATION                       ##
##################################################################

library(readxl)
data_full_cleaned <- read_xlsx("data_full_cleaned.xlsx")


data_full_cleaned$date.1st.EEG <- as_date(data_full_cleaned$date.1st.EEG)
data_full_cleaned$date.1st.cs.su <- as_date(data_full_cleaned$date.1st.cs.su)
data_full_cleaned$date.1st.1st.sz <- as_date(data_full_cleaned$date.1st.1st.sz)
data_full_cleaned$date.2nd.1st.sz <- as_date(data_full_cleaned$date.2nd.1st.sz)
data_full_cleaned$date.dern.1st.sz <- as_date(data_full_cleaned$date.dern.1st.sz)
data_full_cleaned$date.lt.EEG <- as_date(data_full_cleaned$date.lt.EEG)
data_full_cleaned$date.1st.1st.sz <- as_date(data_full_cleaned$date.1st.1st.sz)
data_full_cleaned$date.2nd.1st.sz <- as_date(data_full_cleaned$date.2nd.1st.sz)
data_full_cleaned$date.dern.1st.sz <- as_date(data_full_cleaned$date.dern.1st.sz)
data_full_cleaned$date.IRM <- as_date(data_full_cleaned$date.IRM)

```

# Data dictionary

1. **database**: The data acquisition was done in two steps, this variable specifies to which of the steps the data point belongs, type character
2. **ordre**: Order in which the patients were entered in the database, type numeric
3. **code.pat**: code attributed to each patient, type character 
4. **age**: Patient's age, type numeric
5. **genre**: Patient's gender, type character
6. **atcd.enfance**: Relevant medical history of the patient during his childhood, type character
7. **atcd.famille**: Relevant medical history of the patient's close family, type character
8. **date.1st.EEG**: Date of the first standard EEG after the index event, type Date (lubridate)
9. **res.1st.EEG**: Result of the first EEG (normal, abnormal, none, none but proposed), type character
10. **pointes.1st.EEG**: Presence of epileptic spikes on the standard EEG (focal, generalised, NA), type character
11. **slow.1st.EEG**: Presence of a slowing or non-epileptic abnormalities on the standard EEG (focal, generalised, NA), type character
12. **tt.1st.EEG**: Drugs active during the standard EEG that could have reduce the spike detection (none, BZD, AED, antidepressant, neuroleptics, other, none/other, NA), type character
13. **res.lt.EEG**: Result of the first long-term EEG (normal, abnormal, none, none but proposed), type character
14. **pointes.lt.EEG**: Presence of epileptic spikes on the LT EEG (focal, generalised, NA), type character
15. **slow.lt.EEG**: Presence of a slowing or non-epileptic abnormalities on the LT EEG (focal, generalised, NA), type character
16. **tt.lt.EEG**: Drugs active during the LT EEG that could have reduce the spike detection (none, BZD, AED, antidepressant, neuroleptics, other, none/other, NA), type character
17. **normal.1st.lt.EEG**: Combination of the normality information of the standard and LT EEG, type character
18. **date.CT**: Date of the realisation of the first CT after the index event, type Date(lubridate)
19. **res.CT**: Result of the brain CT (normal, abnormal, none, none but proposed). abnromal CT contain all types of abnormalities: epileptogenic or not, type character
20. **les.CT**: Type of abnormalities (dementia, vascular, tumor, malformation, unknown, none, NA), type = character
21. **res.IRM**: Result of the brain MRI (normal, abnormal, none, none but proposed). abnromal MRI contain all types of abnormalities: epileptogenic or not, type character
22. **date.IRM**: date of the first MRI after first event, type Date (lubridate)
23.**les.IRM**: Type of abnormalities (dementia, vascular, tumor, malformation, unknown, none, NA), type = character
24. **les.epi**: Combined information of CT and MRI specifying if the lesion is epileptogenic, non-epileptogenic, suspicious, or normal
25. **date.1st.cs.su**: Date of the first consultation to the emergency department (ED) after the index event, type POSIXct
26. **date.1st.cs.epi**: Date of the first consultation in the epileptology unit of the HUG, type POSIXct
27. **dx.final**: Final diagnosis (Acute symptomatic seizure (crise provoquee), unknown, cardiovascular origin, psychogenic, other, epilepsy (crise epilepsie) vaso-vagal syncopes, cardiac origin, cardiac) retained after 2 years follow-up (for patients for whom the follow-up information was available), type character
28. **type.epi.final**: For patients with dx.final == crise epilepsie, specification of the epilepsy type (NA, non-lesional, idiopathic generalised (IGE), unknown), type character
29. **dx.final.margitta**: Correction of the diagnosis a posteriori by MS, type character
30. **cat.dx.final**: To be removed, type logical
31. **resident**: to understand why patients were lost in follow-up, infromation of where the patients are living (TRUE = Geneva's area, FALSE = other canton or country), type logical
32. **veille.sommeil**: Did the event happened during sleep or wake time, type character 
33. **status.neuro**: Results of the neuro status (normal, abnormal, none, none but proposed), type character
34. **commentaire**: Brief description of the cases in french, type character
35. **n.ret.SU**: Number of times a patient came back to the ED for a relapse, type numeric
36. **n.recidives.rapp**: Number of reported relapses in consultations, type numeric
37. **n.tot.recidives**: Number of total relapses combining reported and ED consultations, type numeric
38. **type.resident**: Description if the patient lives in another canton, country, had the first seizure while traveling..., type character
39. **SBB.1**: Number of seizures before the index event (1 = first seizure, 2 = one seizure before the index event, 3 = more than one seizure before the index event), type = numeric
40. **SBB.2**: Trajectory of the patients after the ED (1 = hospitalisation, 2 = ambulatory cares or lost, 4 = hospitalisation but with an admission in the intensive care unit before), type = numeric
41.  **SBB.3**: Trajectory of patients after the ED (1 = hospitalisation in epileptology, 2 = hospitalisation in neurology, 3 = hospitalised in the intensive care unit and lost, 4 = hospitalised in neurosurgery, 5 = hospitalised in psychiatry, 6 = hospitalised in another service, 7 = specialised ambulatory cares, 8 = followed outside the hospital or lost), type numeric
42. **SBB.4**: Long term follow-up information for patients with SBB.3 = 7 (1 = other specialised follow-up, 2 = epileptology, 3 = neurology, 4 = neurosurgery, 5 = psychatry), type = numeric
43. **SBB.5**: Trajectory of patients followed-up in epileptology 
  1. follow-up of 12 to 24 months
  2. follow-up by a private neurologist after a 3 months follow-up in the epileptology unit
  3. follow-up by the neurology service after a 3 months follow-up in the epileptology unit
  4. follow-up of 3 to 6 months in the epileptology unit and then stop because not needed
  5. follow-up of 3 to 6 months in the epileptology unit and then followed-up by a private neurologist
  6. follow-up of 6 to 12 months in the epileptology unit and then follow-up not needed anymore
  7. follow-up of 6 to 12 months in the epileptology unit and then followed-up by a private neurologist
  8. follow-up of 6 to 12 months in the epileptology unit and then followed-up by another service
  9. follow-up of 3 to 6 months in the epileptology unit and then followed-up by another service
  10. follow-up by the neurosurgery service after a 3 months follow-up in the epileptology unit
  11. follow-up by another service after a 3 months follow-up in the epileptology unit
  12. 3 months follow-up in the epileptology unit and then lost
  13. 3 months follow-up in the epileptology unit and then follow-up not needed anymore
  14. follow-up of 3 to 6 months in the epileptology unit and then patient lost 
  15. follow-up of 3 to 6 months in the epileptology unit and then follow-up not needed 
  16. follow-up of 6 to 12 months in the epileptology unit and then patient lost 
  17. follow-up of 6 to 12 months in the epileptology unit and then follow-up not needed  
  18. after a follow-up of 12 to 24 months in epileptology, follow-up scheduled
  19. after a follow-up of 12 to 24 months in epileptology, patient lost
  20. after a follow-up of 12 to 24 months in epileptology, follow-up not needed
  21. Follow-up in epileptology at 3 months and then the patient deceased
  22. Follow-up in epileptology at 3 to 6 months and then the patient deceased
  23. Follow-up in epileptology at 6 to 12 months and then the patient deceased
  24. Follow-up in epileptology at 12 to 24 months and then the patient deceased
44. **doute.critere**: Patients for whom the inclusion criteria have been discussed, type logical
45. **date.1st.1st.sz**: Date of the first event event before the index event, type Date (lubridate)
46. **date.2nd.1st.sz**: Date of an eventual second event before the index event, type POSIXct
47. **date.dern.1st.sz**: In case of more than 2 seizures before the index event, date of the last event before the index one, type POSIXct
48. **date.adm.si**: Date of hospitalisation in the intensive care unit, type POSIXct
49. **date.sortie.si**: Date of the end of hospitalisation in the intensive care unit, type Date (lubridate)
50. **date.1st.cs.neuro**: Date of the first consultation in the neurology service, type POSIXct
51. **date.dern.cs.neuro**: Date of the last consultation in the neurology service, type POSIXct
52. **raison_stop_suivi.neuro**: Motive of the interruption of follow-up by the neurology service, type character
53. **date.1st.cs.neurochir**: Date of the first consultation in the neurosurgery service, type POSIXct
54. **date.dern.cs.neurochir**: Date of the last consultation in the neurosurgery service, type POSIXct
55. **raison_stop_suivi.neurochir**: Motive of the interruption of follow-up by the neurosurgery service, type character
56. **date.1st.cs.psy**: Date of the first consultation in the psychiatry service, type POSIXct
57. **date.dern.cs.psy**: Date of the last consultation in the psychiatry service, type POSIXct
58. **raison_stop_suivi.psy**: Motive of the interruption of follow-up by the psychiatry service, type character
59. **date.1st.cs.autre**: Date of the first consultation in another service, type POSIXct
60. **date.dern.cs.autre**: Date of the last consultation in anothers ervice, type POSIXct
61. **raison_stop_suivi.autre**: Motive of the interruption of follow-up by another service, type character
62. **type_suivi.autre**: By which other service the patient was followed-up, type character
63. **date.dern.cs.epi**: Date of the last consultation in the epileptology unit, type POSIXct
64. **date.entree.1st.hospit**: Date of hospitalisation of the patient, type POSIXct
65. **srv.1st.hospit.si_autre**: If SBB.3 = 6, in which service the patient was hospitalised, type character
66. **date.debut.tt**: Date at which the anti-epileptic drug was prescribed, type POSIXct
67. **date.fin.tt**: Date of the end of treatment, type POSIXct
68. **date.dx.final**: Date at which the final diagnosis was announced to the patient, type Date (lubridate)
69. **date.deces**: Date of decease, type POSIXct
70. **cause.deces**: Origin of the death, type character
71. **date.entree.2nd.hospit**: In case of a second hospitalisation after the seizure (seizure --> emergency dept. --> hospitalisation --> 2nd hospitalisation), date of entry in the service, type POSIXct
72. **date.sortie.2nd.hospit**: In case of a second hospitalisation after the first seizure, date of release from the hospital, type POSIXct
73. **srv.2nd.hospit**: Medical service in which the second hospitalisation took place, type character
74. **type.1st.sz**: type of the first seizure (secondary generalized seizures; focals, generalized, acute symptomatic, unknown), type character
75. **type.principal.seizure**: Main type of seizure experienced by a patient, type character
76. **dx.initial**: diagnosis proposed after the first consultation, type character
77. **type.epi.initial**: Epilepsy type proposed after the first consultation, type character
78. **type.autre.initial**: For patients who recieved the diagnosis other, specification of the origin of the episode after the first consultation, type character
79. **type.autre.final**: For patients who recieved the diagnosis other, specification of the origin of the episode after 2 years follow-up, type character
80. **type.cardiovasculaire**: For the patients who recived the diagnosis of cardiovascular origin to their first event, description of the type of cardiovascular disease, type character
81. **date.sortie.1st.hospit**: Date of release after the first hospitalisation, type POSIXct
82. **review.dx**: Patients for whom the diagnosis needed a review, irrelevant column, type logical
83. **AED**: Is the patient under anti-epileptic drug ? type logical
84. **EEG.result_resume**: Summary column groupping the information of the different modalities of pointes.1st.EEG and slow.1st.EEG, type character
85. **EEG.lt.result_resume**: Summary column groupping the information of the different modalities of pointes.lt.EEG and slow.lt.EEG, type character
86. **operated**: Has the patient been operated ? type logical
87. **ATCD_specific**: Description of the medical history before the first event, type character
88. **les.progressive**: For patients who showed a brain lesion, specification if the lesion was progressive or not, type character
89. **type_EGI**: For patients with generalized epilepsy, specification of the type of generalized epilepsy, type character
90. **motif_relapse**: For epileptic patients, verification by a MD if relapses are indeed true relapses, type character
91. **detail_relapse**: For epileptic patients, column indicating the type of relapse, type character
92. **commentaire_relapse**: Text either describing a comment about the relapse, or the date of the first relapse
93. **dx.general**: Reformulation of the column dx.final (Epileptic seizure, non-epileptic event, unknown), type character
94. **dx.event**: Reformulation of the column dx.final (Acute syptomatic seizure, Epilepsy, cardiovascular...), type character
95. **dx.epi**: Reformulation of the column dx.final and type.epi.final (focal vs. generalized), type character
  
# Method

```{r Method 1}

# N pat
tot_pat <- nrow(data_full_cleaned)

# N patients admited in the ED
N_pat_adm_ED <- nrow(data_full_cleaned%>%filter(!is.na(date.1st.cs.su)))

pct_pat_adm_ED <- pct.fun(nrow(data_full_cleaned%>%filter(!is.na(date.1st.cs.su))), nrow(data_full_cleaned%>%filter(!is.na(code.pat))))

```

We reviewed the charts between 3/2010 and 3/2017 of `r tot_pat` patients for whom a first epileptic seizure was suspected.

Most of the patients were admitted in the ED (`r pct_pat_adm_ED`; N = `r N_pat_adm_ED`/`r tot_pat`), the remainder on the ward outside the neurology clinic. 


```{r Method 2}

data_dead <- data_full_cleaned%>%
  dplyr::mutate(alive = ifelse(!is.na(date.deces) | !is.na(cause.deces), "dead", "alive"),
                dx.dicho = ifelse(dx.event == "Epilepsy", "epi", "non-epi"),
                dx.dicho = ifelse(is.na(dx.dicho), "non-epi", dx.dicho))%>%
  dplyr::group_by(alive)%>%
  dplyr::summarise(N = n(),
            mean_age = round(mean(age),2),
            sd_age = round(sd(age),2))

data_resid <- data_full_cleaned%>%
  group_by(resident)%>%
  summarise(N = n())

other_lost <- nrow(data_full_cleaned%>%
  filter(SBB.3 == 3 | SBB.3 == 8)%>%
  filter(resident == TRUE)%>%
  filter(is.na(date.deces)))

tot_lost <- data_dead$N[2]+data_resid$N[1]+other_lost

```

Tracing of the patients was achieved using the information retrieved from the electronical medical records within the Geneva University Hospital for the next two years following the first event. Only patients with a complete work-up were retained, however, some patients were lost (N = `r tot_lost`), either because of death (N = `r data_dead$N[2]`), leaving the area (N = `r data_resid$N[1]`), or without clear motive (N = `r other_lost`). 
 
# Results

```{r diagnostic tree}
##-----------------------------------------------------------------------
##  Creation of the summary tables for each step of the diagnostic tree  
##-----------------------------------------------------------------------

# first step

data_full_cleaned%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))
data_full_cleaned%>% group_by(genre)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))


# second step

data_full_cleaned%>%
  group_by(dx.general)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))
data_full_cleaned%>% group_by(dx.general, genre)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

# Third step 

data_full_cleaned%>%
  group_by(dx.general,dx.event)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

data_full_cleaned%>%
  group_by(dx.general,dx.event, genre)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

# Fourth step 

data_full_cleaned%>%
  group_by(dx.event, dx.epi)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))


data_full_cleaned%>%
  group_by(dx.event, dx.epi, genre)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

# Fifth step 

data_full_cleaned%>%
  filter(type.epi.final == "lesionnelle")%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

data_full_cleaned%>%
  filter(type.epi.final == "non lesionnelle")%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))


data_full_cleaned%>%
  group_by(genre)%>%
  filter(type.epi.final == "lesionnelle")%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

data_full_cleaned%>%
  group_by(genre)%>%
  filter(type.epi.final == "non lesionnelle")%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))
```


```{r Results 1}
# N female patients
N_fem <- nrow(data_full_cleaned[data_full_cleaned$genre == "F",])

# Mean age
M_SD_age <- data_full_cleaned%>%summarise(M_age = round(mean(age),1),
                                          SD_age = round(sd(age),1))
#range age
range_age <- range(data_full_cleaned$age)

# N patients with epileptic seizure
N_epi_sz <- data_full_cleaned%>%
  filter(dx.general == "Epileptic seizure")%>%
  summarise(N_epi_sz = n(),
            pct_epi_sz = pct.fun(N_epi_sz, tot_pat))

# N patients acute symptomatic seizure

tot_epi_sz <- nrow(data_full_cleaned[data_full_cleaned$dx.general == "Epileptic seizure",])

N_acute <- data_full_cleaned%>%
  filter(dx.event == "Acute symptomatic seizure")%>%
   summarise(N_acute = n(),
            pct_acute_tot = pct.fun(N_acute, tot_pat),
            pct_acute_epi = pct.fun(N_acute, tot_epi_sz))

# cause non-epileptic nature
non_epi <- data_full_cleaned%>%
  filter(dx.general == "Non epileptic event")%>%
  summarise(N_non_epi = n(),
            pct_non_epi = pct.fun(N_non_epi, tot_pat))

# N pat_per dx
tot_non_epi <- nrow(data_full_cleaned%>%filter(dx.event != "Epilepsy" | is.na(dx.event)))

N_dx_event <- data_full_cleaned%>%
  group_by(dx.event)%>%
  summarise(N = n(),
            pct_tot = pct.fun(N,tot_pat),
            pct_non_epi = pct.fun(N,tot_non_epi))

# Types of Other diagnoses 

table_1<- data_full_cleaned%>%group_by(type.autre.final)%>%summarise(N = n())%>%arrange(desc(N))%>%filter(!is.na(N))

# Not the first event
tot_pat <- nrow(data_full_cleaned%>%filter(!is.na(code.pat)))
N_not_first_event <- nrow(data_full_cleaned%>%filter(SBB.1 > 1))
pct_not_first_event <- pct.fun(nrow(data_full_cleaned%>%filter(SBB.1 > 1)), nrow(data_full_cleaned%>%filter(!is.na(code.pat))))

# N patients admited in the ED
N_pat_adm_ED <- nrow(data_full_cleaned%>%filter(!is.na(date.1st.cs.su)))

pct_pat_adm_ED <- pct.fun(nrow(data_full_cleaned%>%filter(!is.na(date.1st.cs.su))), nrow(data_full_cleaned%>%filter(!is.na(code.pat))))

```

We included `r tot_pat` patients, `r N_fem` women, with a mean age of `r M_SD_age[1]` (SD= `r M_SD_age[2]`) years, ranging from `r range_age[1]` to `r range_age[2]`. In `r pct_not_first_event` (N = `r N_not_first_event`/`r tot_pat`) detailed patient history showed that the index event was not the first one. Most patients were diagnosed with an epileptic event (N = `r N_epi_sz[1]`/`r tot_pat`; `r N_epi_sz[2]`), of which `r N_acute[1]` presented an acute symptomatic seizure (`r N_acute[2]` of the total sample or `r N_acute[3]` of all patients with an epileptic seizure). Non-epileptic events were found in `r non_epi[2]` (`r non_epi[1]`/`r tot_pat`). Sixty-seven patients presented psychogenic non-epileptic seizures (`r N_dx_event$pct_tot[N_dx_event$dx.event == "Psychogenic non epileptic seizure"][1]`), transient ischemic attack in `r N_dx_event$N[N_dx_event$dx.event == "Cardiovascular"][1]` (`r N_dx_event$pct_tot[N_dx_event$dx.event == "Cardiovascular"][1]`), vasovagal syncope in `r N_dx_event$N[N_dx_event$dx.event == "Vaso-vagal and orthostatic syncopes"][1]` (`r N_dx_event$pct_tot[N_dx_event$dx.event == "Vaso-vagal and orthostatic syncopes"][1]`), and true cardiac syncope in `r N_dx_event$N[N_dx_event$dx.event == "Cardiac"][1]` (`r N_dx_event$pct_tot[N_dx_event$dx.event == "Cardiac"][1]`).

In `r N_dx_event$N[N_dx_event$dx.event == "Other"][1]` patients (`r N_dx_event$pct_tot[N_dx_event$dx.event == "Other"][1]`), various other causes were found; table 1 shows the details. 

```{r lost patients}

nrow(data_full_cleaned%>%
       filter(dx.event == "Unknown")%>%
       filter(SBB.3 == 8 | SBB.3 == 3| !is.na(date.deces) | resident == FALSE))

```



`r kable(table_1)`

```{r Anova on Age}
# ANOVA on age:


data_lm_age <- data_full_cleaned%>%
  mutate(more_1_event = ifelse(SBB.1 > 1, "many", "one"))%>%
  mutate(dx_paste = ifelse(dx.event == "Epilepsy", paste(dx.event, type.epi.final),dx.event))%>%
  select(code.pat, age, dx.event, dx.epi,  more_1_event, dx_paste, genre, les.epi)

hist(data_lm_age$age)

model_age <- lm(age ~  dx.event + more_1_event + genre + les.epi, data = data_lm_age)
vif(model_age)

anova(model_age)
post_hocs_age <- emmeans(model_age, list(pairwise ~ dx.event), adjust = "tukey")
post_hocs_age <- as.data.frame(post_hocs_age$`pairwise differences of dx.event`)
post_hocs_age <- report_results(post_hocs_age, method = "emmeans")

res_mod_age <- report_results(model_age, "mainef_anova")

# age cardiac
age_card_psy <- data_full_cleaned%>%
   group_by(dx.general,dx.event)%>%
   summarise(N = n(), age.pat = mean(age), sd = sd(age))%>%
  filter(dx.event == "Cardiac" | dx.event == "Psychogenic non epileptic seizure")

```


Not surprisingly, epileptic patients were older than cardiovascular and cardiac ones (`r post_hocs_age[14,2]`;`r post_hocs_age[9,2]`; see appendix X for the main effects of the model) while the vasovagal group was significantly younger than the cardiovascular (`r post_hocs_age[18,2]`) and cardiac group (`r post_hocs_age[13,2]`), with the latter presenting the oldest mean age (M = `r round(age_card_psy$age.pat[1],2)`; SD = `r round(age_card_psy$sd[1],2)`) and the psychogenic group the youngest (M = `r round(age_card_psy$age.pat[2],2)`; SD = `r round(age_card_psy$sd[2],2)`; see also figure 1). In `r N_dx_event$N[is.na(N_dx_event$dx.event)]` patients (`r N_dx_event$pct_tot[is.na(N_dx_event$dx.event)]`), the causes of the index event remained unknown. The most frequent reasons of lack of diagnosis were a) lost to follow-up, b) patients were not residents in the Geneva area. The frequency of the different diagnostic categories are given in Figure 1.

Appendix X: `r kable(as.data.frame(anova(model_age)))`

```{r Table 2}
sum_history <- sum(!is.na(data_full_cleaned$ATCD_specific))
table_2 <- data_full_cleaned%>%
  group_by(ATCD_specific)%>%
  summarise(N = n())%>%
  mutate( ATCD_specific = case_when(ATCD_specific == 'aucun' ~ 'No comorbidities',
                                    ATCD_specific == 'autres' ~ 'Other',
                                    ATCD_specific == 'cardiaque' ~ 'Cardiac',
                                    ATCD_specific == 'neurologique' ~ 'Neurologic',
                                    ATCD_specific == 'psychiatrique' ~ 'Psychiatric'))%>%
  filter(!is.na(ATCD_specific))%>%
  mutate(PCT = pct.fun(N, sum_history))%>%
  rename(`Relevant events in medical history` = ATCD_specific)

N_atcd_positive <- table_2%>%filter(`Relevant events in medical history` != "No comorbidities")%>%summarize(sum(N))
N_atcd <- table_2%>%summarize(sum(N))

data_atcd_age <- data_full_cleaned%>%
  filter(!is.na(ATCD_specific))%>%
  mutate(dicho_atcd = ifelse(ATCD_specific == "aucun", "none", "comorbidities"))%>%
  select(code.pat, age, dicho_atcd)

desc_age_atcd <- data_atcd_age%>%
  group_by(dicho_atcd)%>%
  summarise(mean_age = mean(age),
            sd_age = sd(age))

ttest_age <- lm(age ~ dicho_atcd, data = data_atcd_age)  
anova(ttest_age)
res_ttest_age <- report_results(ttest_age, "mainef_anova")[1,2]


```


Relevant elements in the medical history were found in `r sum_history` patients (`r pct.fun(sum_history, tot_pat)`; table 2). Patients with comorbidities (M = `r round(desc_age_atcd$mean_age[1],2)`; SD = `r round(desc_age_atcd$sd_age[1],2)`) were significantly older than patients without previously diagnosed conditions (M = `r round(desc_age_atcd$mean_age[2],2)`; SD = `r round(desc_age_atcd$sd_age[2],2)`; `r res_ttest_age`). 

`r kable(table_2)`

```{r Diagnosis evolution, warning=FALSE, message=FALSE, fig.height=5, fig.width=8}

# Evolution of the diagnosis --> all patients
delay_dx_all <- data_full_cleaned%>%
  filter(!is.na(date.1st.cs.su),!is.na(date.dx.final))%>%
  mutate(delay.1st_epi_dx_fin = as_date(date.dx.final) - as_date(date.1st.cs.su))%>%
  filter(delay.1st_epi_dx_fin >= 0)%>%
  summarise(MEAN = round(mean(delay.1st_epi_dx_fin, na.rm = T),2),
            SD = round(sd(delay.1st_epi_dx_fin, na.rm = T),2))

# Evolution of the diagnosis --> epi patients
delay_dx_epi <- data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  filter(!is.na(date.1st.cs.su),!is.na(date.dx.final))%>%
  mutate(delay.1st_epi_dx_fin = as_date(date.dx.final) - as_date(date.1st.cs.su))%>%
  filter(delay.1st_epi_dx_fin >= 0)%>%
  summarise(MEAN = round(mean(delay.1st_epi_dx_fin, na.rm = T),2),
            SD = round(sd(delay.1st_epi_dx_fin, na.rm = T),2))

# Evolution of the diagnosis --> non epi patients
delay_dx_non_epi <- data_full_cleaned%>%
  filter(dx.event != "Epilepsy" | is.na(dx.event))%>%
  filter(!is.na(date.1st.cs.su),!is.na(date.dx.final))%>%
  mutate(delay.1st_epi_dx_fin = as_date(date.dx.final) - as_date(date.1st.cs.su))%>%
  filter(delay.1st_epi_dx_fin >= 0)%>%
  mutate(dx_first_consult = ifelse(delay.1st_epi_dx_fin == 0, "first_cs", "later"))%>%
  summarise(MEAN = round(mean(delay.1st_epi_dx_fin, na.rm = T),2),
            SD = round(sd(delay.1st_epi_dx_fin, na.rm = T),2))

# Survival analysis investigating the differences in delay to reach the final diagnosis between epileptic and non-epileptic patients.

data_surv <- data_full_cleaned%>%
  select(code.pat, date.1st.cs.su, date.dx.final, dx.event, n.tot.recidives, motif_relapse, detail_relapse)%>%
  filter(!is.na(date.1st.cs.su), !is.na(date.dx.final))%>%
  mutate(date.1st.cs.su = as_date(date.1st.cs.su),
         date.dx.final  = as_date(date.dx.final),
         censored = ifelse(is.na(dx.event) | dx.event == "Unknown", "censored", "diagnosed"),
         dx.dicho = ifelse(dx.event == "Epilepsy", "epilepsy", "other"),
         delay_dx_final = date.dx.final-date.1st.cs.su)%>%
  filter(delay_dx_final >= 0)%>%
  select(-date.dx.final, -date.1st.cs.su, -dx.event)%>%
  mutate(detail_relapse = ifelse(is.na(detail_relapse), "other", detail_relapse),
         relapses = case_when(n.tot.recidives == 0 ~ "no relapse",
                              detail_relapse == "ttt ok et bonne compliance" | detail_relapse == "pas de ttt" | detail_relapse == "ttt ok taux infra ou ttt inadequat" ~ "relapse",
                              dx.dicho == "epilepsy" & n.tot.recidives > 0 & detail_relapse != "ttt ok et bonne compliance" ~ "no relapse",
                              TRUE ~ "relapse"))%>%
  select(-n.tot.recidives, -motif_relapse, -detail_relapse)%>%
  mutate(censored = as.factor(censored),
         dx.dicho = as.factor(dx.dicho),
         relapses = as.factor(relapses),
         delay_dx_final = as.numeric(delay_dx_final))%>%
  mutate(censored = as.numeric(censored),
         dx.dicho = as.numeric(dx.dicho),
         relapses = as.numeric(relapses))%>%
  filter(delay_dx_final <= 730)

# Fitting of the model
fit <- survfit(Surv(delay_dx_final, censored) ~ dx.dicho, data = data_surv)


# Plot
ggsurvplot(
  fit,                     # survfit object with calculated statistics.
  pval = FALSE,
  conf.int = TRUE,         # show confidence intervals for 
  # point estimaes of survival curves.
  conf.int.style = "step",  # customize style of confidence intervals
  xlab = "Time in days",   # customize X axis label.
  ggtheme = theme_light(), # customize plot and risk table with a theme.
  # in legend of risk table.
  ncensor.plot = FALSE,      # plot the number of censored subjects at time t
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = 
    c("Epilepsy", "Not epilepsy"),    # change legend labels.
  palette = 
    c("#E7B800", "#2E9FDF"), # custom color palettes.
  fun = "event"
  )

# Cox model
cox_model <- coxph(Surv(delay_dx_final, censored) ~ dx.dicho + relapses, data_surv)
results_survival <- summary(cox_model)

results_survival <- round_df(results_survival$coefficients,digits = 3)

# Assumptions of the Cox model
test.ph <- cox.zph(cox_model)
test.ph # Assumption violated !!!! HOW TO FIX IT ?

# Influential observations
ggcoxdiagnostics(cox_model, type = , linear.predictions = TRUE)
ggcoxdiagnostics(cox_model, type = "dfbeta", linear.predictions = TRUE) # OK --> magnitudes of the dfbetas
ggcoxdiagnostics(cox_model, type = "deviance", linear.predictions = TRUE)


#Impact of delay until the patients recieve their final diagnosis and the relapses


data_relapse_epi <- data_full_cleaned%>%
  select(code.pat, dx.event, dx.epi, type.epi.final, n.tot.recidives, motif_relapse, detail_relapse, date.1st.cs.su, date.dx.final)%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "Non epileptic", "Epileptic"), 
         relapses = case_when(n.tot.recidives == 0 ~ "No relapse",
                              dx.dicho == "Non epileptic" & n.tot.recidives > 0 ~ "Relapse",
                              detail_relapse == "pas de ttt" ~ "Relapse",
                              detail_relapse == "ttt ok et bonne compliance" ~ "Relapse",
                              detail_relapse == "Probleme de compliance" ~ "Relapse",
                              detail_relapse == "ttt ok taux infra ou ttt inadequat" ~ "Relapse",
                              motif_relapse == "pas de recidives trouvees" ~ "No relapse",
                              TRUE ~ "No relapse"),
         date.dx.final = as_date(date.dx.final),
         date.1st.cs.su = as_date(date.1st.cs.su),
         delay_dx = date.dx.final - date.1st.cs.su)%>%
  filter(dx.event == "Epilepsy",
         delay_dx != is.na(delay_dx),
         delay_dx >= 0,
         delay_dx < 730)

median_delay_epi <- median(data_relapse_epi$delay_dx)

data_chi_epi <- data_relapse_epi%>%
      mutate(delay_dicho = ifelse(delay_dx < median_delay_epi, "short", "long"))%>%
      select(code.pat, relapses, delay_dicho)%>%
  group_by(relapses, delay_dicho)%>%
  summarise(N = n())%>%
  spread(key = delay_dicho, value = N)
data_chi_epi <- as.data.frame(data_chi_epi[,2:3])

chi_epi <- chisq.test(data_chi_epi) # p-value = 0.2354


# Same but taking all patients together

data_relapse_all <- data_full_cleaned%>%
  select(code.pat, dx.event, dx.epi, type.epi.final, n.tot.recidives, motif_relapse, detail_relapse, date.1st.cs.su, date.dx.final)%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "Non epileptic", "Epileptic"), 
         relapses = case_when(n.tot.recidives == 0 ~ "No relapse",
                              dx.dicho == "Non epileptic" & n.tot.recidives > 0 ~ "Relapse",
                              detail_relapse == "pas de ttt" ~ "Relapse",
                              detail_relapse == "ttt ok et bonne compliance" ~ "Relapse",
                              detail_relapse == "Probleme de compliance" ~ "Relapse",
                              detail_relapse == "ttt ok taux infra ou ttt inadequat" ~ "Relapse",
                              motif_relapse == "pas de recidives trouvees" ~ "No relapse",
                              TRUE ~ "No relapse"),
         date.dx.final = as_date(date.dx.final),
         date.1st.cs.su = as_date(date.1st.cs.su),
         delay_dx = date.dx.final - date.1st.cs.su)%>%
  filter(delay_dx != is.na(delay_dx),
         delay_dx >= 0,
         delay_dx < 730)

median_delay_all <- median(data_relapse_all$delay_dx)

data_chi_all <- data_relapse_all%>%
  mutate(delay_dicho = ifelse(delay_dx < median_delay_all, "short", "long"))%>%
  select(code.pat, relapses, delay_dicho)%>%
  group_by(relapses, delay_dicho)%>%
  summarise(N = n())%>%
  spread(key = delay_dicho, value = N)
data_chi_all <- as.data.frame(data_chi_all[,2:3])

chi_all <- chisq.test(data_chi_all) # p-value = 0.001249

# Visualization 

plot_all <- data_relapse_all%>%
  mutate(delay_dicho = ifelse(delay_dx < median_delay_all, "short", "long"))%>%
  select(code.pat, relapses, delay_dicho)%>%
  group_by(relapses, delay_dicho)%>%
  summarise(N = n())

plot_epi <- data_relapse_epi%>%
  mutate(delay_dicho = ifelse(delay_dx < median_delay_epi, "short", "long"))%>%
  select(code.pat, relapses, delay_dicho)%>%
  group_by(relapses, delay_dicho)%>%
  summarise(N = n())


plot_all_pat <- plot_all%>%
  ggplot(aes(x = delay_dicho, y = N, fill = relapses))+
  geom_bar(stat = "identity", alpha = 0.8)+
  scale_fill_brewer(palette = "Greens")+
  theme_minimal()+
  labs(x = "Delay first seizure - final diagnosis", title = "All patients", fill = "Relapses")+
  coord_cartesian(ylim = c(0,135))

plot_epi_pat <- plot_epi%>%
  ggplot(aes(x = delay_dicho, y = N, fill = relapses))+
  geom_bar(stat = "identity", alpha = 0.8)+
  scale_fill_brewer(palette = "Reds")+
  theme_minimal()+
  labs(x = "Delay first seizure - final diagnosis", title = "Epileptic patients", fill = "Relapses")+
  coord_cartesian(ylim = c(0,135))

fig_delay_dx <- ggarrange(plot_all_pat, plot_epi_pat)


# Impact of the treatment delay
# epi

data_relapse_epi_ttt <- data_full_cleaned%>%
  select(code.pat, dx.event, dx.epi, type.epi.final, n.tot.recidives, motif_relapse, detail_relapse, date.1st.cs.su, date.debut.tt)%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "Non epileptic", "Epileptic"), 
         relapses = case_when(n.tot.recidives == 0 ~ "No relapse",
                              dx.dicho == "Non epileptic" & n.tot.recidives > 0 ~ "Relapse",
                              detail_relapse == "pas de ttt" ~ "Relapse",
                              detail_relapse == "ttt ok et bonne compliance" ~ "Relapse",
                              detail_relapse == "Probleme de compliance" ~ "Relapse",
                              detail_relapse == "ttt ok taux infra ou ttt inadequat" ~ "Relapse",
                              motif_relapse == "pas de recidives trouvees" ~ "No relapse",
                              TRUE ~ "No relapse"),
         date.debut.tt = as_date(date.debut.tt),
         date.1st.cs.su = as_date(date.1st.cs.su),
         delay_tt = date.debut.tt - date.1st.cs.su)%>%
  filter(dx.event == "Epilepsy",
         delay_tt != is.na(delay_tt),
         delay_tt >= 0,
         delay_tt < 730)

median_delay_epi_tt <- median(data_relapse_epi_ttt$delay_tt)

data_chi_epi_tt <- data_relapse_epi_ttt%>%
      mutate(delay_dicho = ifelse(delay_tt < median_delay_epi_tt, "short", "long"))%>%
      select(code.pat, relapses, delay_dicho)%>%
  group_by(relapses, delay_dicho)%>%
  summarise(N = n())%>%
  spread(key = delay_dicho, value = N)
data_chi_epi_tt <- as.data.frame(data_chi_epi_tt[,2:3])

chi_epi_tt <- chisq.test(data_chi_epi_tt) #  p-value = 0.07186


# Vizualisation treatment 

# plot_ttt_epi <- data_relapse_epi_ttt%>%
#       mutate(delay_dicho = ifelse(delay_tt < median_delay_epi_tt, "short", "long"))%>%
#       select(code.pat, relapses, delay_dicho)%>%
#   group_by(relapses, delay_dicho)%>%
#   summarise(N = n())
# 
# plot_ttt_epi%>%
#   ggplot(aes(x = delay_dicho, y = N, fill = relapses))+
#   geom_bar(stat = "identity")+
#   scale_fill_brewer(palette = "Blues")+
#   theme_minimal()+
#   labs(x = "Delay first seizure - treatment instauration", title = "Epileptic patients", fill = "Relapses")

```

Among all patients the delay between the first episode and the final diagnosis was on average of `r as.numeric(delay_dx_all$MEAN)` days (SD = `r as.numeric(delay_dx_all$SD)`). As shown in Figure 2 and Table X, a Cox regression showed that epileptic patients (M= `r as.numeric(delay_dx_epi$MEAN)`; SD= `r delay_dx_epi$SD`) tend to receive their final diagnosis earlier than non-epileptic patients (M = `r as.numeric(delay_dx_non_epi$MEAN)`; SD = `r delay_dx_non_epi$SD`) (ASSUMPTIONS VIOLATED; HOW TO FIX IT ?).

## Epileptic origin

```{r Epileptic origin}

# Chi2 frequency event sleep between epilepsy and non-epilepsy patients
data_chi <- data_full_cleaned%>%select(dx.general, veille.sommeil)%>%
  filter(veille.sommeil != "non documente")%>%
  mutate(dx.general = ifelse(dx.general == "Epileptic seizure", "epileptic seizure", "not epileptic event"))%>%
  group_by(dx.general, veille.sommeil)%>%
  summarise(N = n())%>%
  spread(key = veille.sommeil, N)

data_chi <- as.data.frame(data_chi)
row.names(data_chi) <- data_chi$dx_cat
data_chi <- data_chi[,2:3]

chi_sleep_wake <- chisq.test(data_chi)

# seizure occuring in sleep

sz_sleep <- data_full_cleaned%>%
  filter(veille.sommeil == "sommeil")%>%
  filter(dx.general == "Epileptic seizure") %>%
  summarise(N = n())

sz_sleep_epi <- data_full_cleaned%>%
  filter(veille.sommeil == "sommeil")%>%
  filter(!is.na(code.pat))%>%
  filter(dx.general == "Epileptic seizure") %>%
  filter(dx.event == "Epilepsy")%>%
  summarise(N = n())

# N per epilepsy types
N_epi_dx <- data_full_cleaned%>%
  group_by(dx.epi, type.epi.final)%>%
  summarise(N = n(),
            mean_age = mean(age, na.rm = T),
            sd_age = sd(age, na.rm = T))

tot_epi_disease <- nrow(data_full_cleaned%>%filter(dx.event == "Epilepsy"))

# % and N patients "operated" --> only the tumoral patients

N_pat_tumor <- data_full_cleaned%>%
  filter(type.epi.final == "lesionnelle")%>%
  filter(les.CT == "tumoral" | les.IRM == "tumoral")%>%
  summarise(N = n())

# post_hocs on the lm ANOVA investigating age differences among diagnoses

# ANOVA on age:


data_lm_age <- data_full_cleaned%>%
  mutate(more_1_event = ifelse(SBB.1 > 1, "many", "one"))%>%
  mutate(dx_paste = ifelse(dx.event == "Epilepsy", paste(dx.event, type.epi.final),dx.event))%>%
  select(code.pat, age, dx.event, dx.epi,  more_1_event, dx_paste, genre, les.epi)

hist(data_lm_age$age)

model_age_paste <- lm(age ~  dx_paste + more_1_event + genre + les.epi, data = data_lm_age)
vif(model_age_paste)

anova(model_age_paste)
post_hocs_age <- emmeans(model_age_paste, list(pairwise ~ dx_paste), adjust = "tukey")
post_hocs_age <- as.data.frame(post_hocs_age$`pairwise differences of dx_paste`)
post_hocs_age <- report_results(post_hocs_age, method = "emmeans")

res_mod_age <- report_results(model_age_paste, "mainef_anova")

```

If the event occurred during sleep, a chi-squared test showed that it was more likely to be of epileptic origin (`r report_chi(chi_sleep_wake)`). Seizures occurred during sleep in `r pct.fun(sz_sleep, tot_epi_disease)` (N = `r sz_sleep`/`r tot_epi_disease`) of the cases, and `r pct.fun(sz_sleep_epi, sz_sleep)` (N = `r sz_sleep_epi`/`r sz_sleep`) of these patients had later confirmed epilepsy.


```{r Epileptic origin 2}

dx_epi <- data_full_cleaned%>%group_by(dx.epi)%>%summarise(N = n())
N_epi_dx <- data_full_cleaned%>%group_by(dx.event)%>%summarise(N = n())%>%filter(dx.event == "Epilepsy")

# % and N patients "operated" --> only the tumoral patients

N_pat_tumor <- data_full_cleaned%>%
  filter(type.epi.final == "lesionnelle")%>%
  filter(les.CT == "tumoral" | les.IRM == "tumoral")%>%
  summarise(N = n())

# N per epilepsy types
N_epi_dx <- data_full_cleaned%>%
  group_by(dx.epi, type.epi.final)%>%
  summarise(N = n(),
            mean_age = mean(age, na.rm = T),
            sd_age = sd(age, na.rm = T))


```


In `r dx_epi$N[1]`/`r tot_pat` (`r pct.fun(dx_epi$N[1], tot_pat)`) the epilepsy was of focal origin, i.e. `r pct.fun(dx_epi$N[1], sum(N_epi_dx$N[1:3]))` (`r dx_epi$N[1]`/`r sum(N_epi_dx$N[1:3])`) of all epilepsy patients. Among the epileptic patients, `r N_pat_tumor`/`r tot_pat` (`r pct.fun(N_pat_tumor, tot_pat)`) were diagnosed with a brain tumor and were operated. Non-lesional focal epilepsy affected `r N_epi_dx$N[2]` patients (`r pct.fun(N_epi_dx$N[2], tot_pat)`). 

```{r Epileptic origin 3}

# Epileptic abnormalities on the EEG

N_epi_spikes <- nrow(data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  filter(EEG.result_resume == "pointes" | 
         EEG.result_resume == "pointes+slow"))


N_epi_EEG <- nrow(data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  filter(res.1st.EEG != "aucun" ,
         res.1st.EEG != "aucun mais propose"))


N_epi_abnormal <- nrow(data_full_cleaned%>%
                         filter(dx.event == "Epilepsy")%>%
                         filter(res.1st.EEG == "anormal"))

N_epi_abnormal_LT <- nrow(data_full_cleaned%>%
                         filter(dx.event == "Epilepsy")%>%
                         filter(res.lt.EEG == "anormal"))

N_LT_EEG_epi <- nrow(data_full_cleaned%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
    filter(dx.event == "Epilepsy"))

# Non-epileptic abnormalities on the EEG

N_non_epi_abn_EEG <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(EEG.result_resume == "slow"))


# Normal EEG among epileptic patients 

N_epi_norm_EEG <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(res.1st.EEG == "normal"))


# Delay EEG 

EEG_24 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay < 2)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_24_48 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 2 & eeg_delay < 3)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_48_72 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 3 & eeg_delay < 4)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_more_72 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 4)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

N_tot_EEG_time <- nrow(data_full_cleaned[!is.na(data_full_cleaned$date.1st.cs.su) & !is.na(data_full_cleaned$date.1st.EEG),])

# Chi squares efficacy EEG delay all patients 
data_chi <- data_full_cleaned%>%
  mutate(spikes.dicho = ifelse(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow", "pointes", "pas_pointes"),
         spikes.dicho = ifelse(is.na(spikes.dicho), "pas_pointes", spikes.dicho),
         eeg_delay = as.numeric(date.1st.EEG - date.1st.cs.su),
         cat_delay = case_when(eeg_delay < 2 ~ "24h",
                               eeg_delay > 1 & eeg_delay < 3 ~ "48h",
                               eeg_delay > 2 & eeg_delay <4 ~ "72h",
                               eeg_delay >=4 ~ "+72h"))%>%
           group_by(cat_delay, spikes.dicho)%>%
  summarise(N = n())%>%
  spread(cat_delay, N)


data_chi <- data_chi[,2:ncol(data_chi)]

chi2_EEG_all <- chisq.test(data_chi, simulate.p.value = T)

# Chi squares efficacy EEG delay epileptic patients 

data_chi <- data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  mutate(spikes.dicho = ifelse(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow", "pointes", "pas_pointes"),
         spikes.dicho = ifelse(is.na(spikes.dicho), "pas_pointes", spikes.dicho),
         eeg_delay = as.numeric(date.1st.EEG - date.1st.cs.su),
         cat_delay = case_when(eeg_delay < 2 ~ "24h",
                               eeg_delay > 1 & eeg_delay < 3 ~ "48h",
                               eeg_delay > 2 & eeg_delay <4 ~ "72h",
                               eeg_delay >=4 ~ "+72h"))%>%
           group_by(cat_delay, spikes.dicho)%>%
  summarise(N = n())%>%
  spread(cat_delay, N)

data_chi <- data_chi[,2:ncol(data_chi)]

chi2_EEG_epi <- chisq.test(data_chi, simulate.p.value = T)


juv_myo <- 13
grand_mal_awa <- 3
tot_IGE <- nrow(data_full_cleaned%>%filter(dx.epi == "Primary generalized epilepsy"))
non_classifiable <- tot_IGE - juv_myo - grand_mal_awa
```

`r N_epi_abnormal` (`r N_epi_abnormal`/`r N_epi_EEG`) patients showed EEG-abnormalities in the routine EEG (spikes or slowing), and `r N_epi_abnormal_LT` (`r pct.fun(N_epi_abnormal_LT, N_LT_EEG_epi)`; `r N_epi_abnormal_LT`/`r N_LT_EEG_epi`) in the LTM-EEG. One patient without MRI-lesion presented strongly suggestive semiology (post-ictal shoulder luxation) but had only unspecific focal EEG abnormalities.


We diagnosed idiopathic generalized (genetic) epilepsy in `r N_epi_dx$N[N_epi_dx$type.epi.final == "generalisee idiopathique"][1]` patients (`r pct.fun(N_epi_dx$N[N_epi_dx$type.epi.final == "generalisee idiopathique"][1], tot_pat)` of all patients, M = `r round(N_epi_dx$mean_age[N_epi_dx$type.epi.final == "generalisee idiopathique"][1],2)`; SD = `r round(N_epi_dx$sd_age[N_epi_dx$type.epi.final == "generalisee idiopathique"][1],2)`). The most frequent syndrome was juvenile myoclonic epilepsy (N = `r juv_myo`). The IGE group was significantly younger than the group of patients with focal epilepsy (IGE vs. SE: `r post_hocs_age$report[25]`; IGE vs. NLE: `r post_hocs_age$report[26]`).

```{r Psychogenic origin}
N_epi_non_dx <- data_full_cleaned%>%
  group_by(dx.event)%>%
  summarise(N = n(),
            mean_age = round(mean(age, na.rm = T),2),
            sd_age = round(sd(age, na.rm = T),2))

# N men in the PNES group
post_hoc_gender_PNES <- emmeans(model_age_paste, list(pairwise ~ genre|dx_paste), adjust = "tukey")
post_hoc_gender_PNES <- post_hoc_gender_PNES$`pairwise differences of genre | dx_paste`
post_hoc_gender_PNES <- as.data.frame(post_hoc_gender_PNES)
post_hoc_gender_PNES <- report_results(post_hoc_gender_PNES, "emmeans")

temp <- data_full_cleaned%>%
  filter(dx.event == "Psychogenic non epileptic seizure")%>%
  group_by(genre)%>%
  summarise(N = n())

N_H_psy <- temp$N[temp$genre == "H"]
N_psy <- sum(temp$N)

# ATCD psy
atcd_gender<- data_full_cleaned%>%
  group_by(genre, ATCD_specific)%>%
  summarise(N = n())%>%
  mutate( ATCD_specific = case_when(ATCD_specific == 'aucun' ~ 'No comorbidities',
                                    ATCD_specific == 'autres' ~ 'Other',
                                    ATCD_specific == 'cardiaque' ~ 'Cardiac',
                                    ATCD_specific == 'neurologique' ~ 'Neurologic',
                                    ATCD_specific == 'psychiatrique' ~ 'Psychiatric'))%>%
  filter(!is.na(ATCD_specific))%>%
  mutate(PCT = pct.fun(N, sum_history))%>%
  rename(`Relevant events in medical history` = ATCD_specific)

# age cardiac and cardiovascular

dx_event_desc <- data_full_cleaned%>%
  group_by(dx.event, dx.epi)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

ATCD <- data_full_cleaned%>%
  group_by(ATCD_specific)%>%
  summarise(N = n(),
            AGE = mean(age, na.rm = T),
            SD_AGE = sd(age, na.rm = T))%>%
  mutate(ATCD_specific = case_when(ATCD_specific == 'aucun' ~ 'No comorbidities',
                                    ATCD_specific == 'autres' ~ 'Other',
                                    ATCD_specific == 'cardiaque' ~ 'Cardiac',
                                    ATCD_specific == 'neurologique' ~ 'Neurologic',
                                    ATCD_specific == 'psychiatrique' ~ 'Psychiatric'))%>%
  filter(!is.na(ATCD_specific))%>%
  mutate(PCT = pct.fun_n(N,sum(table_2$N)))
```

## Non-epileptic origin

Even though women were significantly more likely to have psychogenic non-epileptic seizures compared to other non-epileptic diagnoses ( `r post_hoc_gender_PNES$report[8]`), the diagnosis was not rare in men (N = `r N_H_psy`/`r N_psy`; `r pct.fun(N_H_psy, N_psy)`).As shown in Table 2, psychiatric history was positive in `r table_2$N[5]` patients over `r sum(table_2$N)`, among whose `r pct.fun(atcd_gender$N[5], table_2$N[5])` were women and `r pct.fun(atcd_gender$N[10], table_2$N[5])` were males.

As described in Appendix X, patients with cardiovascular and cardiogenic origin were on average significantly older (M = `r round(dx_event_desc$age.pat[dx_event_desc$dx.event == "Cardiovascular"][1],2)`; SD = `r round(dx_event_desc$sd[dx_event_desc$dx.event == "Cardiovascular"][1],2)` and M = `r round(dx_event_desc$age.pat[dx_event_desc$dx.event == "Cardiac"][1],2)`; SD = `r round(dx_event_desc$sd[dx_event_desc$dx.event == "Cardiac"][1],2)`, respectively). In most of the patients (`r 100- ATCD$PCT[ATCD$ATCD_specific == "Cardiac"]`%), no prior cardiac problems were reported.

```{r vasovagal}
N_plus60_vaso <- nrow(data_full_cleaned%>%
  filter(dx.event == "Vaso-vagal and orthostatic syncopes")%>%
  filter(age > 60))

```


In `r pct.fun(dx_event_desc$N[dx_event_desc$dx.event == "Vaso-vagal and orthostatic syncopes"][1], tot_pat)` (`r dx_event_desc$N[dx_event_desc$dx.event == "Vaso-vagal and orthostatic syncopes"][1]`/ `r tot_pat`) the final diagnosis was vasovagal syncope. Long post-syncope confusion, the notion of clonic or asymmetric movements, or comorbidities affecting the CNS required in-depth investigations. `r pct.fun(N_plus60_vaso, dx_event_desc$N[dx_event_desc$dx.event == "Vaso-vagal and orthostatic syncopes"][1])` affected patients older than 60. 

```{r table 3}
table_3 <- data_full_cleaned%>%
  filter(dx.event == "Cardiovascular")%>%
  group_by(type.cardiovasculaire)%>%
  summarise(N = n())%>%
  mutate(type.cardiovasculaire = case_when(type.cardiovasculaire == "ACR" ~ "Cardiac arrest",
                   type.cardiovasculaire == "AIT" ~ "Transient ischemic attack",
                   type.cardiovasculaire == "AVC" ~ "Stroke",
                   type.cardiovasculaire == "multifactoriel" ~ "Multifactorial",
                   type.cardiovasculaire == "symptomes post-AVC" ~ "Post-stroke symptoms",
                   type.cardiovasculaire == "syncope" ~ "Syncope"))
```

`r kable(table_3)`

## Mortality

```{r Mortality}
# Proportion of patients who deceased in the 2 years follow-up

data_dead <- data_full_cleaned%>%
  dplyr::mutate(alive = ifelse(!is.na(date.deces) | !is.na(cause.deces), "dead", "alive"),
                dx.dicho = ifelse(dx.event == "Epilepsy", "epi", "non-epi"),
                dx.dicho = ifelse(is.na(dx.dicho), "non-epi", dx.dicho))%>%
  dplyr::group_by(alive)%>%
  dplyr::summarise(N = n(),
            mean_age = round(mean(age),2),
            sd_age = round(sd(age),2))


data_dead_HF <- data_full_cleaned%>%
  dplyr::mutate(alive = ifelse(!is.na(date.deces) | !is.na(cause.deces), "dead", "alive"),
                dx.dicho = ifelse(dx.event == "Epilepsy", "epi", "non-epi"),
                dx.dicho = ifelse(is.na(dx.dicho), "non-epi", dx.dicho))%>%
  dplyr::group_by(alive, genre)%>%
  dplyr::summarise(N = n(),
            mean_age = round(mean(age),2),
            sd_age = round(sd(age),2))

# Difference in proportion between epileptic and non-epileptic patients regarding the mortality rate

datachi <- data_full_cleaned%>%
  dplyr::mutate(alive = ifelse(!is.na(date.deces) | !is.na(cause.deces), "dead", "alive"),
                dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non-epi", "epi"))%>%
  dplyr::group_by(dx.dicho,alive)%>%
  summarise(N = n())%>%
  spread(key = alive, value = N)

datachi <- as.data.frame(datachi)
rownames(datachi) <- datachi$dx.dicho
datachi$dx.dicho <- NULL

chi_dead <- chisq.test(datachi) 

```


Among the entire sample, `r data_dead$N[data_dead$alive == "dead"]` patients deceased during the two year follow-up (`r pct.fun(data_dead$N[data_dead$alive == "dead"], tot_pat)`; mean age = `r data_dead$mean_age[data_dead$alive =="dead"]`; `r data_dead_HF$N[data_dead_HF$alive =="dead" & data_dead_HF$genre == "F"]` females and `r data_dead_HF$N[data_dead_HF$alive =="dead" & data_dead_HF$genre == "H"]` males). In the epileptic group (N = `r datachi$dead[1]`/`r tot_epi_disease`; `r pct.fun(datachi$dead[1],tot_epi_disease) `), this proportion is significantly larger than in the non-epileptic group (N = `r datachi$dead[2]`/`r tot_non_epi`; `r pct.fun(datachi$dead[2],tot_non_epi)`; `r report_chi(chi_dead)`), which is mainly due to patients with epilepsy and dementia or brain tumors. Two epileptic patients died from other causes (one of them from cardiac origin and the other one from severe hypernatremia and infection) and for six patients the cause of the death remained unclear. None of the patients experienced death related directly to an epileptic seizure. 

## Diagnostic tools

### MRI-CT
```{r MRI-CT}
N_les <- data_full_cleaned%>%
  filter(res.IRM != "aucun", res.IRM != "aucun mais propose")%>%
  group_by(les.epi)%>%
  summarise(N = n())

N_normal <- N_les$N[N_les$les.epi == "normal"]+N_les$N[N_les$les.epi == "lesion non epileptogene"]

post_hoc_les <- emmeans(model_age, list(pairwise ~ les.epi), adjust = "tukey")
post_hoc_les <- as.data.frame(post_hoc_les$`pairwise differences of les.epi`)
post_hoc_les <- report_emmeans(post_hoc_les)

# Among epileptic patients

N_les_epi <- data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  filter(res.IRM != "aucun", res.IRM != "aucun mais propose")%>%
  group_by(les.epi)%>%
  summarise(N = n())

N_normal_epi <- N_les_epi$N[N_les_epi$les.epi == "normal"]+N_les_epi$N[N_les_epi$les.epi == "lesion non epileptogene"]

```

Among all patients, `r N_normal` had a normal MRI or showed benign abnormalities (few small white matter lesions, developmental venous abnormalities, etc), while `r N_normal_epi` epileptic patients had normal MRI. `r N_les$N[N_les$les.epi == "douteux"]` of the `r sum(N_les$N)` patients with an MRI (`r pct.fun(N_les$N[N_les$les.epi == "douteux"], sum(N_les$N))`) belonged to the intermediate category. In `r N_les_epi$N[N_les_epi$les.epi == "lesion epileptogene"]` patients, an epileptogenic lesion was found (for details, see Table 4).

### Routine EEG

```{r Routine EEG}

N_EEG <- nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "pointes"))+nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "slow"))+nrow(data_full_cleaned%>%
  filter(res.1st.EEG == "normal"))+nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "pointes+slow"))

N_EEG_spikes <-nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "pointes" | 
         EEG.result_resume == "pointes+slow"))

N_EEG_slow <- nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "slow"))

N_EEG_normal <- nrow(data_full_cleaned%>%
  filter(res.1st.EEG == "normal"))

# EEG delay 

# Epileptic abnormalities on the EEG

N_epi_spikes <- nrow(data_full_cleaned%>%
  filter(!is.na(code.pat))%>%
  filter(dx.event == "Epilepsy")%>%
  filter(EEG.result_resume == "pointes" | 
         EEG.result_resume == "pointes+slow"))


N_epi_EEG <- nrow(data_full_cleaned%>%
  filter(!is.na(code.pat))%>%
  filter(dx.event == "Epilepsy")%>%
  filter(res.1st.EEG != "aucun" ,
         res.1st.EEG != "aucun mais propose"))

# Non-epileptic abnormalities on the EEG

N_non_epi_abn_EEG <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(EEG.result_resume == "slow"))


# Normal EEG among epileptic patients 

N_epi_norm_EEG <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(res.1st.EEG == "normal"))


# Delay EEG 

EEG_24 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay < 2)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_24_48 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 2 & eeg_delay < 3)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_48_72 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 3 & eeg_delay < 4)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_more_72 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 4)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

N_tot_EEG_time <- nrow(data_full_cleaned[!is.na(data_full_cleaned$date.1st.cs.su) & !is.na(data_full_cleaned$date.1st.EEG),])

# Chi squares efficacy EEG delay all patients 
data_chi <- data_full_cleaned%>%
  mutate(spikes.dicho = ifelse(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow", "pointes", "pas_pointes"),
         spikes.dicho = ifelse(is.na(spikes.dicho), "pas_pointes", spikes.dicho),
         eeg_delay = as.numeric(date.1st.EEG - date.1st.cs.su),
         cat_delay = case_when(eeg_delay < 2 ~ "24h",
                               eeg_delay > 1 & eeg_delay < 3 ~ "48h",
                               eeg_delay > 2 & eeg_delay <4 ~ "72h",
                               eeg_delay >=4 ~ "+72h"))%>%
           group_by(cat_delay, spikes.dicho)%>%
  summarise(N = n())%>%
  spread(cat_delay, N)

data_chi <- data_chi[,2:ncol(data_chi)]

chi2_EEG_all <- chisq.test(data_chi, simulate.p.value = T)

# Chi squares efficacy EEG delay epileptic patients 

data_chi <- data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  mutate(spikes.dicho = ifelse(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow", "pointes", "pas_pointes"),
         spikes.dicho = ifelse(is.na(spikes.dicho), "pas_pointes", spikes.dicho),
         eeg_delay = as.numeric(date.1st.EEG - date.1st.cs.su),
         cat_delay = case_when(eeg_delay < 2 ~ "24h",
                               eeg_delay > 1 & eeg_delay < 3 ~ "48h",
                               eeg_delay > 2 & eeg_delay <4 ~ "72h",
                               eeg_delay >=4 ~ "+72h"))%>%
           group_by(cat_delay, spikes.dicho)%>%
  summarise(N = n())%>%
  spread(cat_delay, N)


data_chi <- data_chi[,2:ncol(data_chi)]

chi2_EEG_epi <- chisq.test(data_chi, simulate.p.value = T)


```


`r ifelse(N_EEG == tot_pat, "All", N_EEG)` patients underwent a routine EEG. In `r N_EEG_spikes` patients epileptiform discharges were identified (`r pct.fun(N_EEG_spikes, N_EEG)`), in `r N_EEG_slow` (`r pct.fun(N_EEG_slow, N_EEG)`) unspecific abnormalities like slowing, and  `r N_EEG_normal` patients (`r pct.fun(N_EEG_normal, N_EEG)`) had a completely normal EEG. 

While we aimed at carrying out the EEG within 24h, this was not always possible. Among patients in whom timing of the routine EEG could be retrieved (N = `r N_tot_EEG_time`/`r N_EEG`), in `r EEG_24` (`r pct.fun(EEG_24, N_tot_EEG_time)`), the standard EEG was done within 24h. `r pct.fun(EEG_24_48, N_tot_EEG_time)` (N = `r EEG_24_48`/`r N_tot_EEG_time`) were realized between 24 and 48h, `r pct.fun(EEG_48_72, N_tot_EEG_time)` (N = `r EEG_48_72`/`r N_tot_EEG_time`) between 48h and 72h, and the reminder `r pct.fun(EEG_more_72, N_tot_EEG_time)` (N = `r EEG_more_72`/`r N_tot_EEG_time`) after 72h. There was a marginal tendency to pick up epileptiform abnormalities if the EEG was carried out within a short delay  (`r report_chi(chi2_EEG_all)`).

```{r Standard EEG 2}
temp <- data_full_cleaned%>%filter(dx.event != "Epilepsy" | is.na(dx.event))%>%
  filter(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow")%>%
  group_by(dx.general, dx.event, dx.epi)%>%
  summarise(N = n())

N_spikes_not_epi <- nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "pointes" | 
           EEG.result_resume == "pointes+slow")%>%
  filter(dx.event != "Epilepsy" & dx.event != "Acute symptomatic seizure" & dx.event != "Unknown")%>%
  select(code.pat, date.1st.cs.su, date.1st.EEG, res.1st.EEG, EEG.result_resume,  date.lt.EEG, res.lt.EEG, EEG.lt.result_resume, dx.final, type.epi.final, type.autre.final))

N_spikes_not_epi_lt_normal <- nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "pointes" | 
           EEG.result_resume == "pointes+slow")%>%
  filter(dx.event != "Epilepsy" & dx.event != "Acute symptomatic seizure" & dx.event != "Unknown")%>%
    filter(res.lt.EEG == "normal")%>%
  select(code.pat, date.1st.cs.su, date.1st.EEG, res.1st.EEG, EEG.result_resume,  date.lt.EEG, res.lt.EEG, EEG.lt.result_resume, dx.final, type.epi.final, type.autre.final))

rest_non_epi_spikes <- N_spikes_not_epi-N_spikes_not_epi_lt_normal


data_full_cleaned%>%
  filter(EEG.result_resume == "pointes" | 
           EEG.result_resume == "pointes+slow")%>%
  filter(dx.event != "Epilepsy" & dx.event != "Acute symptomatic seizure" & dx.event != "Unknown")%>%
    filter(res.lt.EEG == "anormal")%>%
  select(code.pat, date.1st.cs.su, date.1st.EEG, res.1st.EEG, EEG.result_resume,  date.lt.EEG, res.lt.EEG, EEG.lt.result_resume, dx.final, type.epi.final, type.autre.final)

not_epi_spikes <- data_full_cleaned%>%
  filter(dx.event != "Epilepsy")%>%
  filter(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow")%>%
  filter(dx.event != "Acute symptomatic seizure", dx.event != "Unknown")%>%
  select(code.pat, pointes.lt.EEG, res.lt.EEG, EEG.lt.result_resume, dx.event)%>%
  mutate(state = case_when(res.lt.EEG == "normal" ~ "normal", ))



```

EEG patterns suggestive of epileptiform abnormalities were found in `r number_to_word(N_spikes_not_epi)` patients out of `r tot_non_epi` presenting with non-epileptic events corresponding to `r pct.fun(N_spikes_not_epi, tot_non_epi)` of false positive results. For `r number_to_word(nrow(not_epi_spikes[not_epi_spikes$res.lt.EEG == "normal",]))` of them, the LT EEG was normal and the epileptogenic abnormality (sharper slow waves in all cases), seen in the routine EEG, could not be confirmed. In `r number_to_word(nrow(not_epi_spikes[not_epi_spikes$res.lt.EEG == "aucun",]))` other cases, no long-term EEG was proposed or patient refused (N = 1) or not proposed to the patient (N = 1), but the observed epileptiform discharges location was not concordant with the semiology of the event, leading to the exclusion of the diagnosis of epilepsy despite the observed electrical abnormalities. Finally, in `r number_to_word(nrow(not_epi_spikes[not_epi_spikes$res.lt.EEG == "anormal",]))` case, only a slowing was highlighted but no spikes were visible on the LTM-EEG.


```{r LT-EEG}

N_LT_EEG <- nrow(data_full_cleaned%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose"))

N_spikes_LTEEG <- nrow(data_full_cleaned%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
    filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow"))

N_spikes_LTEEG_epi <- nrow(data_full_cleaned%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
    filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow")%>%
    filter(dx.event == "Epilepsy"))

spikes_non_epi <- data_full_cleaned%>%
  filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow")%>%
  filter(dx.event != "Epilepsy")%>%
  group_by(dx.event)%>%
  summarise(N = n())

N_LT_EEG_norm_std <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(EEG.result_resume == "slow" | res.1st.EEG == "normal")%>%
         filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose"))

N_LT_EEG_norm_std_spikes <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(EEG.result_resume == "slow" | res.1st.EEG == "normal")%>%
         filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
         filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow"))

yield_LT_EEG <-pct.fun((N_EEG_spikes/N_EEG), (N_spikes_LTEEG/N_LT_EEG)) 

```

`r N_LT_EEG` patients underwent LTM-EEG. Overall, `r N_spikes_LTEEG` patients (`r pct.fun(N_spikes_LTEEG, N_LT_EEG)`) showed epileptiform discharges, leading to the diagnosis of epilepsy in `r N_spikes_LTEEG_epi` (`r pct.fun(N_spikes_LTEEG_epi, N_spikes_LTEEG)`). Among the remaining `r number_to_word(N_spikes_LTEEG - N_spikes_LTEEG_epi)`, `r number_to_word(spikes_non_epi$N[spikes_non_epi$dx.event == "Acute symptomatic seizure"][1])` of them were diagnosed as acute symptomatic seizures, and for `r number_to_word(spikes_non_epi$N[spikes_non_epi$dx.event == "Unknown"][1])` others, the pathological nature of the anomalies remained uncertain. 

Of the patients with epilepsy but normal EEG or non-epileptogenic abnormalities at the standard EEG (N = `r N_epi_norm_EEG + N_non_epi_abn_EEG`), `r N_LT_EEG_norm_std` (`r pct.fun(N_LT_EEG_norm_std, (N_epi_norm_EEG + N_non_epi_abn_EEG))`) underwent LTM-EEG which identified epileptiform discharges in an additional `r N_LT_EEG_norm_std_spikes` patients (`r pct.fun(N_LT_EEG_norm_std_spikes,N_LT_EEG_norm_std)`), which corresponds to a yield of `r yield_LT_EEG`.

## Multimodal information

```{r Multimodal information}
# Patients with all 3 negative exams

N_pat_all_normal <- nrow(data_full_cleaned%>%
  filter(pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" & res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
   filter(pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" & res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(les.epi == "normal" | les.epi == "lesion non epileptogene")%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose"))

N_pat_all_normal_suspicious_les <- nrow(data_full_cleaned%>%filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(EEG.result_resume == "slow" | is.na(EEG.result_resume))%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(EEG.lt.result_resume == "slow" | is.na(EEG.lt.result_resume))%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(les.epi != "lesion epileptogene")%>%
  select(pointes.1st.EEG, pointes.lt.EEG, res.IRM, les.epi)%>%
  filter(les.epi == "douteux"))

# N patients epileptic among these patients
N_pat_all_normal_epi <- nrow(data_full_cleaned%>%
  filter(pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" & res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" & res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(les.epi == "normal" | les.epi == "lesion non epileptogene")%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(dx.event == "Epilepsy"))

# Same but only with routine EEG and MRI
N_pat_all_normal_epi_lt_mri <- nrow(data_full_cleaned%>%
  filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" & res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(les.epi == "normal" | les.epi == "lesion non epileptogene")%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(dx.event == "Epilepsy"))

missed_patients <- nrow(data_full_cleaned%>%
  filter(res.1st.EEG != "normal" | EEG.result_resume == "slow")%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(les.epi != "lesion epileptogene")%>%
  filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow"))



```

While routine EEG, MRI and LTM-EEG are the key exams to diagnose or exclude epilepsy, we were wondering what the combined yield is. Among patients with all three negative exams (N = `r N_pat_all_normal`), `r number_to_word(N_pat_all_normal_epi)` patients were nevertheless diagnosed with epilepsy (`r pct.fun(N_pat_all_normal_epi,tot_pat)`) due to highly suggestive witness reports and/or postictal injuries. If only routine EEG and MRI are taken into account, `r missed_patients` patients would have been missed. Moreover, if only MRI and long-term EEG are negative, `r number_to_word(N_pat_all_normal_epi_lt_mri)` would be incorrectly diagnosed as non-epileptic (`r pct.fun((N_pat_all_normal_epi_lt_mri - N_pat_all_normal_epi), tot_epi_disease)` of the group of epileptic patients). 

## Relapses

```{r Relapse rate, echo=FALSE, warning=FALSE}

# What to consider as a relapse ? Here everything except acute seizures

# pas de ttt                        
#ttt ok et bonne compliance        
#Probleme de compliance            
#ttt ok taux infra ou ttt inadequat
#crise provoquee

data_relapse <- data_full_cleaned%>%
  select(code.pat, dx.event, dx.epi, type.epi.final, n.tot.recidives, motif_relapse, detail_relapse)%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "Non epileptic", "Epileptic"), 
         relapses = case_when(n.tot.recidives == 0 ~ "No relapse",
                              dx.dicho == "Non epileptic" & n.tot.recidives > 0 ~ "Relapse",
                              detail_relapse == "pas de ttt" ~ "Relapse",
                              detail_relapse == "ttt ok et bonne compliance" ~ "Relapse",
                              detail_relapse == "Probleme de compliance" ~ "Relapse",
                              detail_relapse == "ttt ok taux infra ou ttt inadequat" ~ "Relapse",
                              motif_relapse == "pas de recidives trouvees" ~ "No relapse",
                              TRUE ~ "No relapse"))%>%
  select(code.pat, dx.event, dx.epi, type.epi.final, relapses, detail_relapse, dx.dicho)

# Table of the relapse rate per diagnostis

relapse_table <- data_relapse%>%
  group_by(dx.event, dx.epi, type.epi.final, relapses)%>%
  summarise(N = n())%>%
  mutate()%>%
  spread(key = relapses, value = N)%>%
  mutate(percentage = pct.fun(Relapse, sum(`No relapse`, Relapse)),
         pct_n = pct.fun_n(Relapse, sum(`No relapse`, Relapse)))

# N and % of acutes symptomatic seizures as relapse

N_acute_relapses <- nrow(data_relapse%>%
  filter(detail_relapse == "crise provoquee"))

pct_acute_relapses <- pct.fun(N_acute_relapses, nrow(data_full_cleaned%>%filter(dx.event == "Epilepsy")))

# General relapse rate among all patients 

N_relapses_total <- nrow(data_relapse%>%filter(relapses == "Relapse"))

# N and % of relapse among epileptic patients
N_relapses_epi <- nrow(data_relapse%>%filter(dx.event == "Epilepsy", relapses == "Relapse"))

pct_relapses_epi <- pct.fun(N_relapses_epi, nrow(data_relapse%>%filter(dx.event == "Epilepsy")))

# N and % of relapse among non-epileptic patients

N_relapses_non_epi <- nrow(data_relapse%>%
                             filter(dx.event != "Epilepsy" | is.na(dx.event))%>%
                             filter(relapses == "Relapse"))

N_non_epi <- nrow(data_relapse%>%
                             filter(dx.event != "Epilepsy" | is.na(dx.event)))

pct_relapses_non_epi <- pct.fun(N_relapses_non_epi, N_non_epi)

# Chisq between the two
N_no_relapse_epi <- nrow(data_relapse%>%filter(dx.event == "Epilepsy", relapses == "No relapse"))
N_no_relapse_non_epi <-  nrow(data_relapse%>%
                             filter(dx.event != "Epilepsy" | is.na(dx.event))%>%
                             filter(relapses == "No relapse"))

epi_rel_no_rel <- c(N_relapses_epi, N_no_relapse_epi)
non_epi_rel_no_rel <- c(N_relapses_non_epi, N_no_relapse_non_epi)

chi_data <- data.frame(epi_rel_no_rel, non_epi_rel_no_rel)
result_chi_epi_non_epi <- chisq.test(chi_data)

# N and % of relapse in focal epilepsy patients vs. generalized
  # Focal
N_relapses_focal <- nrow(data_relapse%>%filter(dx.epi == "Focal epilepsy", relapses == "Relapse"))
N_focal <- nrow(data_relapse%>%filter(dx.epi == "Focal epilepsy"))

pct_relapses_focal <- pct.fun(N_relapses_focal, N_focal)

  # Generalized
N_relapses_generalized <- nrow(data_relapse%>%filter(dx.epi == "Primary generalized epilepsy", relapses == "Relapse"))
N_generalized <- nrow(data_relapse%>%filter(dx.epi == "Primary generalized epilepsy"))

pct_relapses_generalized <- pct.fun(N_relapses_generalized, N_generalized)

# Chisq on the relapse rate between focal and generalized
N_no_relapses_focal <- nrow(data_relapse%>%filter(dx.epi == "Focal epilepsy", relapses == "No relapse"))
N_no_relapses_generalized <- nrow(data_relapse%>%filter(dx.epi == "Primary generalized epilepsy", relapses == "No relapse"))

focal_rel_no_rel <- c(N_relapses_focal, N_no_relapses_focal)
gener_rel_no_rel <- c(N_relapses_generalized, N_no_relapses_generalized)

data_chi <- data.frame(focal_rel_no_rel, gener_rel_no_rel)
res_chi_focal_gen <- chisq.test(data_chi)

# N and % of relapses in lesional vs. non-lesional epilepsy
N_relapses_les <- nrow(data_relapse%>%filter(type.epi.final == "lesionnelle", relapses == "Relapse"))

N_les <- nrow(data_relapse%>%filter(type.epi.final == "lesionnelle"))

pct_relapses_les <- pct.fun(N_relapses_les, N_les)

N_relapses_non_les <- nrow(data_relapse%>%filter(type.epi.final == "non lesionnelle", relapses == "Relapse"))
N_non_les <- nrow(data_relapse%>%filter(type.epi.final == "non lesionnelle"))

pct_relapses_non_les <- pct.fun(N_relapses_non_les, N_non_les)

# Chisq on the relapse rate between lesional vs. non-lesional patients

N_non_relapses_les <- N_les - N_relapses_les
N_non_relapses_non_les <- N_non_les - N_relapses_non_les

les_rel_no_rel <- c(N_relapses_les, N_non_relapses_les)
non_les_rel_no_rel <- c(N_relapses_non_les, N_non_relapses_non_les)

data_chi <- data.frame(les_rel_no_rel, non_les_rel_no_rel)
res_chi_les_non_les <- chisq.test(data_chi)

# Cardiac RR vs. the other groups of non-epileptic patients
N_relapses_cardiac <- nrow(data_relapse%>%filter(dx.event == "Cardiac", relapses == "Relapse"))
N_cardiac <- nrow(data_relapse%>%filter(dx.event == "Cardiac"))

pct_relapses_cardiac <- pct.fun(N_relapses_cardiac, N_cardiac)

data_cardiac_relapse <- relapse_table%>%
  mutate(cardiac.dicho = case_when(dx.event == "Cardiac" ~ "Cardiac",
                                   TRUE ~ "non cardiac"),
         cardiac.dicho = ifelse(dx.event == "Epilepsy", NA, cardiac.dicho),
         cardiac.dicho = ifelse(is.na(dx.event), "non cardiac", cardiac.dicho))


data_cardiac_relapse <- as.data.frame(data_cardiac_relapse)
N_relapses_non_cardiac <- data_cardiac_relapse%>%filter(cardiac.dicho == "non cardiac")%>%
  summarise(total = sum(Relapse))
N_relapses_non_cardiac <-  N_relapses_non_cardiac$total[1]

N_non_cardiac <- data_cardiac_relapse%>%filter(cardiac.dicho == "non cardiac")%>%
  summarise(total = sum(Relapse, `No relapse`))

data_cardiac_relapse <- as.data.frame(data_cardiac_relapse)

# Chisq between cardiac and non-cardiac diagnoses
N_non_relapses_non_cardiac <- as.data.frame(data_cardiac_relapse%>%filter(cardiac.dicho == "non cardiac")%>%summarise(total = sum(`No relapse`)))
N_non_relapses_non_cardiac <- N_non_relapses_non_cardiac$total

N_non_relapses_cardiac <- N_cardiac - N_relapses_cardiac
cardiac_rel_no_rel <- c(N_relapses_cardiac, N_non_relapses_cardiac)
non_cardiac_rel_no_rel <- c(N_relapses_non_cardiac, N_non_relapses_non_cardiac)
data_chi <- data.frame(cardiac_rel_no_rel, non_cardiac_rel_no_rel)

res_chi_cardiac <- chisq.test(data_chi)

table_5 <- relapse_table

```

Among all patients, `r N_relapses_total` (`r pct.fun(N_relapses_total, nrow(data_full_cleaned))`) relapsed. The proportion was significantly higher for epileptic patients (N = `r N_relapses_epi`/`r nrow(data_full_cleaned%>%filter(dx.event == "Epilepsy"))`; `r pct_relapses_epi`), compared to non epileptic patients (N = `r N_relapses_non_epi`/`r N_non_epi`; `r pct_relapses_non_epi`; `r report_results(result_chi_epi_non_epi, method = "chisq")`). There was no difference between focal and generalized epilepsy (`r report_results(res_chi_focal_gen, "chisq")`). However, within the focal epilepsy group, patients with non-lesional epilepsy (N = `r N_relapses_non_les`/`r N_non_les` ; `r pct_relapses_non_les`) are significantly more likely to relapse compared to patients with lesional epilepsy (N = `r N_relapses_les`/`r N_les`; `r pct_relapses_les`; `r report_results(res_chi_les_non_les, method = "chisq")`).

Regarding patients with a non-epileptic diagnosis, cardiac patients have the highest relapse rate compared to the other non-epileptic groups (N = `r N_relapses_cardiac`/`r N_cardiac`; `r pct_relapses_cardiac`), however, this difference did not reach significance (`r report_results(res_chi_cardiac, "chisq")`). Interestingly, we observed `r relapse_table$percentage[relapse_table$dx.event == "Acute symptomatic seizure"][1]` of relapse in the group of acute symptomatic seizures, which is as high as the focal lesional epilepsy group and the cardiac group, suggesting a review of current driving regulations. See Table 5 for a complete description of the relapse rate per diagnosis.

`r kable(table_5)`

data show that patients who receive their final diagnosis faster are less prone to relapse (STATS METHOD NEED TO BE DEFINED).

```{r relapses II}
# Table of the reason of relapse among the epileptic patients
N_epi <- nrow(data_full_cleaned%>%filter(dx.event == "Epilepsy"))

type_relapse_table <- data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  group_by(detail_relapse)%>%
  summarise(N = n(),
            PCT = pct.fun_n(N, N_epi))%>%
  mutate(detail_relapse = case_when(detail_relapse == "crise provoquee" ~ "Acute symptomatic seizure",
                                    detail_relapse == "pas de ttt" ~ "No treatment",
                                    detail_relapse == "Probleme de compliance" ~ "Compliance problem",
                                    detail_relapse == "ttt ok et bonne compliance" ~ "Adequate treatment and good compliance",
                                    detail_relapse == "ttt ok taux infra ou ttt inadequat" ~ "Infra-therapeutic drug-level or suboptimal treatment ",
                                    is.na(detail_relapse) ~ "no relapse"))

# Acute relapses 
N_acute <- 4
OH <- 2
sevr_ttt <- 2

```

Among epileptic patients, we investigated the most likely cause of the relapse following the index event. In `r type_relapse_table$N[type_relapse_table ==  "Adequate treatment and good compliance"]`, another seizure occurred despite an adequate treatment and no compliance problems, suggestive of early onset pharmacoresistent epilepsy (N = `r type_relapse_table$N[type_relapse_table ==  "Adequate treatment and good compliance"]`/`r N_epi`; `r type_relapse_table$PCT[type_relapse_table == "Adequate treatment and good compliance"]`%). In `r type_relapse_table$N[type_relapse_table == "No treatment"]` patients (`r pct.fun(type_relapse_table$N[type_relapse_table == "No treatment"], N_epi)`), antiepileptic treatment was refused. In `r type_relapse_table$N[type_relapse_table == "Compliance problem"]`, non-compliance was identified as the most likely cause (`r pct.fun(type_relapse_table$N[type_relapse_table == "Compliance problem"], N_epi)`). In the remaining patients, relapses occurred while treatment was progressively introduced and thus, due to insufficient drug levels. In four patients with a diagnosis of epilepsy, a second seizure turned out to be of acute symptomatic origin (`r number_to_word(OH)` with alcohol and `r number_to_word(sevr_ttt)` with benzodiazepine withdrawal). 

## Predictive models

### Model predicting the diagnosis

```{r predictive logistic regression}

data_reg_log <- data_full_cleaned%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non-epileptic", "epileptic"),
         EEG = case_when(!is.na(EEG.result_resume) ~ EEG.result_resume,
                         res.1st.EEG == "aucun" | res.1st.EEG == "aucun mais propose" ~ "aucun",
                         TRUE ~ "normal"),
         les.epi = ifelse(les.epi == "aucun", NA, les.epi),
         status.neuro = ifelse(status.neuro == "aucun" | status.neuro == "aucun mais propose", NA, status.neuro),
         veille.sommeil = ifelse(veille.sommeil == "non documente", NA, veille.sommeil),
         EEG = ifelse(EEG == "aucun", NA, EEG),
         atcd.famille = ifelse(atcd.famille == "aucun/autre", "aucun", atcd.famille),
         dx.dicho = as.factor(dx.dicho),
         genre = as.factor(genre),
         atcd.famille = as.factor(atcd.famille),
         EEG = as.factor(EEG),
         les.epi = as.factor(les.epi),
         status.neuro = as.factor(status.neuro),
         veille.sommeil = as.factor(veille.sommeil))%>%
  select(code.pat, dx.dicho, age, genre, atcd.famille, EEG, les.epi, status.neuro, veille.sommeil)

mod_log <- glm(dx.dicho ~ age + genre + atcd.famille + EEG + les.epi + status.neuro + veille.sommeil, family = "binomial", data = data_reg_log)

Anova_reg_log <- as.data.frame(Anova(mod_log))
anova_reg_log <- as.data.frame(anova(mod_log))
anova_reg_log <- anova_reg_log[2:nrow(anova_reg_log),]

res_reg_log <- cbind(anova_reg_log, Anova_reg_log)
res_reg_log <- res_reg_log[,-6]
res_reg_log$Predictor <- row.names(res_reg_log)
res_reg_log <- res_reg_log%>%
  arrange(desc(Deviance))%>%
  mutate(Deviance = round(Deviance, 2),
         `Resid. Dev` = round(`Resid. Dev`,2),
         `LR Chisq` = round(`LR Chisq`,2),
         `Pr(>Chisq)` = round(`Pr(>Chisq)`, 3),
         `Pr(>Chisq)` = ifelse(`Pr(>Chisq)` < 0.001, "<0.001", `Pr(>Chisq)`))%>%
  select(Predictor, Df, Deviance, `Resid. Df`, `Resid. Dev`, `LR Chisq`, `Pr(>Chisq)`)

table_6 <- res_reg_log

```

To determine how much each clinical and paraclinical information contribute to the elaboration of the diagnosis, a logistic regression was performed, including as dependent variable the diagnosis (epileptic/not epileptic), and as predictors the patient's age, its gender, the familial history, results of the standard EEG (spikes/slow/spikes and slow/ normal), the presence of an epileptogenic lesion (normal/uncertain/epileptogenic lesion/non-epileptogenic lesion), the results or the neuro status (normal/abnormal), and if the event happened during wake or sleep. Results (see Table X) show that the presence of an epileptogenic lesion and the results of the EEG predict the best the diagnosis. All the other factors seem to play a role, except for the results of the status neuro and the familial history for which no main effect were highlighted.

`r kable(res_reg_log)`

*Table X: results table of the logistic regression model investigating the effect of each variable on the ability to predict the diagnosis. Factors are arranged by deviance.*

### Estimation of the yield of LTM-EEG over routine EEG

```{r interest of LT EEG}
data_LT_over_std <- data_full_cleaned%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non-epileptic", "epileptic"),
         EEG = case_when(!is.na(EEG.result_resume) ~ EEG.result_resume,
                         res.1st.EEG == "aucun" | res.1st.EEG == "aucun mais propose" ~ "aucun",
                         TRUE ~ "normal"),
         les.epi = ifelse(les.epi == "aucun", NA, les.epi),
         status.neuro = ifelse(status.neuro == "aucun" | status.neuro == "aucun mais propose", NA, status.neuro),
         veille.sommeil = ifelse(veille.sommeil == "non documente", NA, veille.sommeil),
         EEG = ifelse(EEG == "aucun", NA, EEG),
         atcd.famille = ifelse(atcd.famille == "aucun/autre", "aucun", atcd.famille),
         EEG_LT = case_when(!is.na(EEG.lt.result_resume) ~ EEG.lt.result_resume,
                            res.lt.EEG == "aucun" | res.lt.EEG == "aucun mais propose" ~ "aucun",
                            TRUE ~ "normal"),
         dx.dicho = as.factor(dx.dicho),
         genre = as.factor(genre),
         atcd.famille = as.factor(atcd.famille),
         EEG = as.factor(EEG),
         les.epi = as.factor(les.epi),
         status.neuro = as.factor(status.neuro),
         veille.sommeil = as.factor(veille.sommeil))%>%
  filter(res.lt.EEG != "aucun", res.lt.EEG != "aucun mais propose")%>%
  select(code.pat, dx.dicho, EEG_LT, age, genre, atcd.famille, EEG, les.epi, status.neuro, veille.sommeil)


# Logistic regression model with the LT EEG information

mod_w_LT <- glm(dx.dicho ~ EEG_LT + age + genre + atcd.famille + EEG + les.epi + status.neuro + veille.sommeil, family = "binomial", data = data_LT_over_std)


# Results table

Anova_reg_log_LT <- as.data.frame(Anova(mod_w_LT))
anova_reg_log_LT <- as.data.frame(anova(mod_w_LT))
anova_reg_log_LT <- anova_reg_log_LT[2:nrow(anova_reg_log_LT),]

res_reg_log_LT <- cbind(anova_reg_log_LT, Anova_reg_log_LT)
res_reg_log_LT <- res_reg_log_LT[,-6]
res_reg_log_LT$Predictor <- row.names(res_reg_log_LT)
res_reg_log_LT <- res_reg_log_LT%>%
  arrange(desc(Deviance))%>%
  mutate(Deviance = round(Deviance, 2),
         `Resid. Dev` = round(`Resid. Dev`,2),
         `LR Chisq` = round(`LR Chisq`,2),
         `Pr(>Chisq)` = round(`Pr(>Chisq)`, 3),
         `Pr(>Chisq)` = ifelse(`Pr(>Chisq)` < 0.001, "<0.001", `Pr(>Chisq)`))%>%
  select(Predictor, Df, Deviance, `Resid. Df`, `Resid. Dev`, `LR Chisq`, `Pr(>Chisq)`)

table_7 <- res_reg_log_LT

```

A second logistic regression model aimed at assessing the relevance of the overnight EEG. For this analysis, only patients with a standard and LT-EEG were retained (N = `r nrow(data_LT_over_std)`). The same predictors as the previous model were entered, adding the LT-EEG information (spikes/slow/spikes and slow/ normal). As shown in Table X, in this particular pool of patients LT-EEG appeared to be the main predictor of the diagnosis, much better than the presence of an epileptogenic lesion. Moreover, only these two parameters appeard to be significantly contributing to the patients diagnosis prediction.

`r kable(res_reg_log_LT)`

*Table X: results of the logistic regression model including the LT-EEG information as predictor of the diagnosis. Factors are arranged by deviance.*


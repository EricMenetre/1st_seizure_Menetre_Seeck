---
title: "The first seizure, a monocentric study"
author: 'Version: V3'
output:
  html_document:
    toc: yes
    toc_depth: 3
  word_document:
    toc: yes
    toc_depth: '3'
---

```{r Libraries and functions, include=FALSE}
# Libraries 

library(dplyr)
library(ggplot2)
library(tidyr)
library(writexl)
library(emmeans)
library(tidyr)
library(lubridate)
library(car)
library(knitr)
library(randomForest)
library(ROCR)
library(NPL) # from https://github.com/EricMenetre/NPL -> Follow instruction on the README regarding installation

# functions

## Function to calculate percentages
pct.fun <- function(sub_sample, full_sample) {
  pct <- round((sub_sample * 100)/full_sample,2)
  return(paste(pct,"%", sep = ""))
}
pct.fun_n <- function(sub_sample, full_sample) {
  pct <- round((sub_sample * 100)/full_sample,2)
  return(pct)
}

# Function to create an output to report results from an lm model in the text
report_mainef_lm <- function(model){
  anova_table <- anova(model)
  
  effects <- paste("F(", anova_table$Df,") = ", round(anova_table$`F value`,2), " p = ", sep = "")
  names_eff <- rownames(anova_table)
  output <- data.frame(names_eff, effects)
  output$p <- round(anova_table$`Pr(>F)`,3)
  output$p <- ifelse(output$p == 0.000, "<0.001", output$p)
  output <-output[1:(nrow(output)-1),]
  output$effects <- paste(output$effects, output$p, sep = "")
  output$p <- NULL
  return(output)
}

# Function to create a text output for a chi2 model
report_chi <- function(chi_model){
  if(chi_model$p.value < 0.001){
    return(paste("X2 = ",round(chi_model$statistic,2), "; p<0.001", sep = ""))
  } else {
    return(paste( "X2 = ",round(chi_model$statistic,2), "; p = ", round(chi_model$p.value,3), sep = ""))
  }
  
}

# Function to create a text output for a emmeans model
report_emmeans <- function(mod_emmeans){
  post_hoc <- mod_emmeans
  if(colnames(post_hoc)[5] == "t.ratio"){
    output <- data.frame(post_hoc$contrast)
    output$report <- paste("t(", post_hoc$df,") = ", round(post_hoc$t.ratio,2), "; p ", sep = "")
    output$p <- post_hoc$p.value
    output$p <- ifelse(post_hoc$p.value < 0.001, "<0.001", paste("= ",round(post_hoc$p.value,3)))
    output$report <- paste(output$report, output$p)
    output$p <- NULL
    return(output)
    } else if(colnames(post_hoc[5]) == "z.ratio"){
    output <- data.frame(post_hoc$contrast)
    output$report <- paste("z = ", round(post_hoc$z.ratio,2), "; p", sep = "")
    output$p <- post_hoc$p.value
    output$p <- ifelse(post_hoc$p.value < 0.001, "<0.001", paste("= ", round(post_hoc$p.value,3), sep = ""))
    output$report <- paste(output$report, output$p)
    output$p <- NULL
    return(output)
    } else{
    print("Unknown format, only results from z and t distributions are available")
  }
  
}

# Function to convert numbers to words --> 1 -> one
number_to_word <- function(number){
  if(number == 0){
    return("zero")
  } else if(number == 1){
    return("one")
  }else if(number == 2){
    return("two")
  } else if(number == 3){
    return("three")
  } else if(number == 4){
    return("four")
  } else if(number == 5){
    return("five")
  } else if(number == 6){
    return("six")
  } else if(number == 7){
    return("seven")
  } else if(number == 8){
    return("eight")
  } else if(number == 9){
    return("nine")
  } else if(number == 10){
    return("ten")
  } else if(number > 10 | number < 0){
    return(number)
  } 
}

# Function to create a text output for a glm model
report_glm <- function(glm_model){
  sum_glm <- summary(glm_model)
  sum_glm <- sum_glm$coefficients
  
  names_eff <- rownames(sum_glm)
  output <- data.frame(names_eff)
  
  output$report <- paste("Z = ", round(sum_glm[,3],2), "; p ", ifelse(round(sum_glm[,4],3) < 0.001, "<0.001", paste("= ", round(sum_glm[,4],3), sep = "")), sep = "")
  output <- output[-1,]
  return(output)
}

# Function to prepare the data to be entered in the first Random Forest model

data_RF_outcome_single_tree <- function(data){
  
  library(dplyr)
  temp <- data%>%
    filter(res.1st.EEG != "aucun" )%>%
    filter(res.1st.EEG != "aucun mais propose" & res.1st.EEG != "aucun mais  propose")%>%
    filter(les.epi != "aucun" & res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
    filter(!is.na(dx.event),
           dx.event != "Unknown")%>%
    filter(type.epi.final == "lesionnelle" | type.epi.final == "non lesionnelle" | type.epi.final == "generalisee idiopathique" | is.na(type.epi.final))%>%
    filter(veille.sommeil != "non documente")%>%
    filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
    mutate(std_eeg = ifelse(res.1st.EEG == "normal", "normal", EEG.result_resume),
           std_eeg = case_when(pointes.1st.EEG == "focale" ~ "focale",
                               pointes.1st.EEG == "diffuse"~ "diffuse",
                               pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" ~ std_eeg))%>%
    mutate(res.dx.final = dx.event)%>%
    mutate(res.dx.final = ifelse(res.dx.final == "Epilepsy", "epilepsy", "non-epileptic"))%>%
    mutate(age = case_when(age >= 16 & age <= 25 ~ "16_25",
                           age > 25 & age <= 35 ~ "26_35",
                           age > 35 & age <= 45 ~ "36_45",
                           age > 45 & age <= 55 ~ "46_55",
                           age > 55 & age <= 65 ~ "56_65",
                           age > 65 & age <= 75 ~ "66_75",
                           age > 75 & age <= 85 ~ "76_85",
                           age > 85 ~ "85_plus"))%>%
    select(age, genre, atcd.famille, std_eeg, les.epi, status.neuro, veille.sommeil, res.dx.final)
  
  temp <- temp%>%
    dplyr::mutate(std_eeg = ifelse(std_eeg == "focale" | std_eeg == "diffuse", "Spikes", "No spikes"),
                  atcd.famille = ifelse(atcd.famille == "epilepsie", "Epilepsy", "other or none"),
                  les.epi = ifelse(les.epi == "lesion epileptogene", "Epileptogenic lesion", "No lesion or probably not epileptogenic"),
                  age = case_when(age == "16_25" | age == "26_35" | age == "36_45" | age == "46_55" ~ "<55",
                                  age == "56_65" | age == "66_75" | age == "76_85" | age == "85_plus" ~ ">55"),
                  status.neuro = ifelse(status.neuro == "anormal", "Abnormal", "Normal or none"),
                  res.dx.final = case_when(res.dx.final == "epilepsy" ~ "Epileptic",
                                           res.dx.final == "non-epileptic" ~ "Non epileptic"))
  
  
  
  
  temp <- as.data.frame(temp)
  
  for (i in 1:ncol(temp)){
    temp[,i] <- factor(temp[,i])
  }
  
  data_RF <<- as.data.frame(temp)
  
  # Division in training and test dataframes
  
  train_index <- sample(nrow(temp), nrow(temp)*0.75)
  data_RF_train <<- temp[train_index,]
  data_RF_test <- temp[-train_index,]
  data_RF_test <<- data_RF_test[,1:ncol(data_RF_test)-1]
  
  labels_final <- temp[,ncol(temp)]
  
  temp_labels_final <- data%>%
    filter(res.1st.EEG != "aucun" )%>%
    filter(res.1st.EEG != "aucun mais propose" & res.1st.EEG != "aucun mais  propose")%>%
    filter(les.epi != "aucun" & res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
    filter(!is.na(dx.event),
           dx.event != "Unknown")%>%
    filter(type.epi.final == "lesionnelle" | type.epi.final == "non lesionnelle" | type.epi.final == "generalisee idiopathique" | is.na(type.epi.final))%>%
    filter(veille.sommeil != "non documente")%>%
    filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
    mutate(std_eeg = ifelse(res.1st.EEG == "normal", "normal", EEG.result_resume),
           std_eeg = case_when(pointes.1st.EEG == "focale" ~ "focale",
                               pointes.1st.EEG == "diffuse"~ "diffuse",
                               pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" ~ std_eeg))%>%
    mutate(res.dx.final = dx.event)%>%
    mutate(res.dx.final = ifelse(res.dx.final == "Epilepsy", "epilepsy", "non-epileptic"))%>%
    mutate(age = case_when(age >= 16 & age <= 25 ~ "16_25",
                           age > 25 & age <= 35 ~ "26_35",
                           age > 35 & age <= 45 ~ "36_45",
                           age > 45 & age <= 55 ~ "46_55",
                           age > 55 & age <= 65 ~ "56_65",
                           age > 65 & age <= 75 ~ "66_75",
                           age > 75 & age <= 85 ~ "76_85",
                           age > 85 ~ "85_plus"))%>%
    select(age, genre,  atcd.famille, std_eeg, les.epi, status.neuro,  veille.sommeil, res.dx.final)
  
  
  labels_final_train_RF <<- labels_final[train_index]
  labels_final_test_RF <<- labels_final[-train_index]
  
  labels_initial_train_RF <<- temp_labels_final[train_index,ncol(temp_labels_final)]
  labels_initial_test_RF <<- temp_labels_final[-train_index,ncol(temp_labels_final)]
  
  labels_initial_global <<- temp$res.dx.initial
  
}

# Function to prepare the data to be entered in the second and third Random Forest models
data_RF_outcome_single_tree_LT <- function(data){
  
  library(dplyr)
  temp <- data%>%
    filter(res.1st.EEG != "aucun" )%>%
    filter(res.1st.EEG != "aucun mais propose" & res.1st.EEG != "aucun mais  propose")%>%
    filter(les.epi != "aucun" & res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
    filter(!is.na(dx.event),
           dx.event != "Unknown")%>%
    filter(type.epi.final == "lesionnelle" | type.epi.final == "non lesionnelle" | type.epi.final == "generalisee idiopathique" | is.na(type.epi.final))%>%
    filter(veille.sommeil != "non documente")%>%
    filter(res.lt.EEG != "aucun")%>%
    filter(res.lt.EEG != "aucun mais propose" & res.lt.EEG != "aucun mais  propose")%>%
    filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
    mutate(std_eeg = ifelse(res.1st.EEG == "normal", "normal", EEG.result_resume),
           std_eeg = case_when(pointes.1st.EEG == "focale" ~ "focale",
                               pointes.1st.EEG == "diffuse"~ "diffuse",
                               pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" ~ std_eeg))%>%
    mutate(lt_eeg = ifelse(res.lt.EEG == "normal", "normal", EEG.lt.result_resume),
           lt_eeg = case_when(pointes.lt.EEG == "focale" ~ "focale",
                               pointes.lt.EEG == "diffuse"~ "diffuse",
                               pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" ~ lt_eeg))%>%
    mutate(res.dx.final = dx.event)%>%
    mutate(res.dx.final = ifelse(res.dx.final == "Epilepsy", "epilepsy", "non-epileptic"))%>%
    mutate(age = case_when(age >= 16 & age <= 25 ~ "16_25",
                           age > 25 & age <= 35 ~ "26_35",
                           age > 35 & age <= 45 ~ "36_45",
                           age > 45 & age <= 55 ~ "46_55",
                           age > 55 & age <= 65 ~ "56_65",
                           age > 65 & age <= 75 ~ "66_75",
                           age > 75 & age <= 85 ~ "76_85",
                           age > 85 ~ "85_plus"))%>%
    select(age, genre,  atcd.famille, std_eeg, lt_eeg, les.epi, status.neuro, veille.sommeil, res.dx.final)
  
  temp <- temp%>%
    dplyr::mutate(std_eeg = ifelse(std_eeg == "focale" | std_eeg == "diffuse", "Spikes", "No spikes"),
                  lt_eeg = ifelse(lt_eeg == "focale" | lt_eeg == "diffuse", "Spikes", "No spikes"),
                  atcd.famille = ifelse(atcd.famille == "epilepsie", "Epilepsy", "other or none"),
                  les.epi = ifelse(les.epi == "lesion epileptogene", "Epileptogenic lesion", "No lesion or probably not epileptogenic"),
                  age = case_when(age == "16_25" | age == "26_35" | age == "36_45" | age == "46_55" ~ "<55",
                                  age == "56_65" | age == "66_75" | age == "76_85" | age == "85_plus" ~ ">55"),
                  status.neuro = ifelse(status.neuro == "anormal", "Abnormal", "Normal or none"),
                  res.dx.final = case_when(res.dx.final == "epilepsy" ~ "Epileptic",
                                           res.dx.final == "non-epileptic" ~ "Non epileptic"))
  
  
  temp <- as.data.frame(temp)
  
  for (i in 1:ncol(temp)){
    temp[,i] <- factor(temp[,i])
  }
  
  data_RF <<- as.data.frame(temp)
  
  # Division in training and test dataframes
  
  train_index <- sample(nrow(temp), nrow(temp)*0.75)
  data_RF_train <<- temp[train_index,]
  data_RF_test <- temp[-train_index,]
  data_RF_test <<- data_RF_test[,1:ncol(data_RF_test)-1]
  
  labels_final <- temp[,ncol(temp)]
  
  temp_labels_final <- data%>%
    filter(res.1st.EEG != "aucun" )%>%
    filter(res.1st.EEG != "aucun mais propose" & res.1st.EEG != "aucun mais  propose")%>%
    filter(les.epi != "aucun" & res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
    filter(!is.na(dx.event),
           dx.event != "Unknown")%>%
    filter(type.epi.final == "lesionnelle" | type.epi.final == "non lesionnelle" | type.epi.final == "generalisee idiopathique" | is.na(type.epi.final))%>%
    filter(veille.sommeil != "non documente")%>%
    filter(res.lt.EEG != "aucun")%>%
    filter(res.lt.EEG != "aucun mais propose" & res.lt.EEG != "aucun mais  propose")%>%
    filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
    mutate(std_eeg = ifelse(res.1st.EEG == "normal", "normal", EEG.result_resume),
           std_eeg = case_when(pointes.1st.EEG == "focale" ~ "focale",
                               pointes.1st.EEG == "diffuse"~ "diffuse",
                               pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" ~ std_eeg))%>%
    mutate(lt_eeg = ifelse(res.lt.EEG == "normal", "normal", EEG.lt.result_resume),
           lt_eeg = case_when(pointes.lt.EEG == "focale" ~ "focale",
                              pointes.lt.EEG == "diffuse"~ "diffuse",
                              pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" ~ lt_eeg))%>%
    mutate(res.dx.final = dx.event)%>%
    mutate(res.dx.final = ifelse(res.dx.final == "Epilepsy", "epilepsy", "non-epileptic"))%>%
    mutate(age = case_when(age >= 16 & age <= 25 ~ "16_25",
                           age > 25 & age <= 35 ~ "26_35",
                           age > 35 & age <= 45 ~ "36_45",
                           age > 45 & age <= 55 ~ "46_55",
                           age > 55 & age <= 65 ~ "56_65",
                           age > 65 & age <= 75 ~ "66_75",
                           age > 75 & age <= 85 ~ "76_85",
                           age > 85 ~ "85_plus"))%>%
    select(age, genre,atcd.famille, std_eeg, lt_eeg, les.epi, status.neuro, veille.sommeil, res.dx.final)
  
  temp_labels_final <- temp_labels_final%>%
    dplyr::mutate(std_eeg = ifelse(std_eeg == "focale" | std_eeg == "diffuse", "Spikes", "No spikes"),
                  lt_eeg = ifelse(lt_eeg == "focale" | lt_eeg == "diffuse", "Spikes", "No spikes"),
                  atcd.famille = ifelse(atcd.famille == "epilepsie", "Epilepsy", "other or none"),
                  les.epi = ifelse(les.epi == "lesion epileptogene", "Epileptogenic lesion", "No lesion or probably not epileptogenic"),
                  age = case_when(age == "16_25" | age == "26_35" | age == "36_45" | age == "46_55" ~ "<55",
                                  age == "56_65" | age == "66_75" | age == "76_85" | age == "85_plus" ~ ">55"),
                  status.neuro = ifelse(status.neuro == "anormal", "Abnormal", "Normal or none"),
                  res.dx.final = case_when(res.dx.final == "epilepsy" ~ "Epileptic",
                                           res.dx.final == "non-epileptic" ~ "Non epileptic"))
  
  labels_final_train_RF <<- labels_final[train_index]
  labels_final_test_RF <<- labels_final[-train_index]
  
  labels_initial_train_RF <<- temp_labels_final[train_index,ncol(temp_labels_final)]
  labels_initial_test_RF <<- temp_labels_final[-train_index,ncol(temp_labels_final)]
  
  labels_initial_global <<- temp$res.dx.initial
  
}

```

```{r data importation, include=FALSE}

##################################################################
##                       DATA IMPORTATION                       ##
##################################################################

library(readxl)
data_full_cleaned <- read_xlsx("data_full_cleaned_ok.xlsx")


data_full_cleaned$date.1st.EEG <- as_date(data_full_cleaned$date.1st.EEG)
data_full_cleaned$date.1st.cs.su <- as_date(data_full_cleaned$date.1st.cs.su)
data_full_cleaned$date.1st.1st.sz <- as_date(data_full_cleaned$date.1st.1st.sz)
data_full_cleaned$date.2nd.1st.sz <- as_date(data_full_cleaned$date.2nd.1st.sz)
data_full_cleaned$date.dern.1st.sz <- as_date(data_full_cleaned$date.dern.1st.sz)
data_full_cleaned$date.lt.EEG <- as_date(data_full_cleaned$date.lt.EEG)
data_full_cleaned$date.1st.1st.sz <- as_date(data_full_cleaned$date.1st.1st.sz)
data_full_cleaned$date.2nd.1st.sz <- as_date(data_full_cleaned$date.2nd.1st.sz)
data_full_cleaned$date.dern.1st.sz <- as_date(data_full_cleaned$date.dern.1st.sz)
data_full_cleaned$date.IRM <- as_date(data_full_cleaned$date.IRM)

```

# Data dictionary

1. **database**: The data acquisition was done in two steps, this variable specifies to which of the steps the data point belongs, type character
2. **ordre**: Order in which the patients were entered in the database, type numeric
3. **code.pat**: code attributed to each patient, type character 
4. **age**: Patient's age, type numeric
5. **genre**: Patient's gender, type character
6. **atcd.enfance**: Relevant medical history of the patient during his childhood, type character
7. **atcd.famille**: Relevant medical history of the patient's close family, type character
8. **date.1st.EEG**: Date of the first standard EEG after the index event, type Date (lubridate)
9. **res.1st.EEG**: Result of the first EEG (normal, abnormal, none, none but proposed), type character
10. **pointes.1st.EEG**: Presence of epileptic spikes on the standard EEG (focal, generalised, NA), type character
11. **slow.1st.EEG**: Presence of a slowing or non-epileptic abnormalities on the standard EEG (focal, generalised, NA), type character
12. **tt.1st.EEG**: Drugs active during the standard EEG that could have reduce the spike detection (none, BZD, AED, antidepressant, neuroleptics, other, none/other, NA), type character
13. **res.lt.EEG**: Result of the first long-term EEG (normal, abnormal, none, none but proposed), type character
14. **pointes.lt.EEG**: Presence of epileptic spikes on the LT EEG (focal, generalised, NA), type character
15. **slow.lt.EEG**: Presence of a slowing or non-epileptic abnormalities on the LT EEG (focal, generalised, NA), type character
16. **tt.lt.EEG**: Drugs active during the LT EEG that could have reduce the spike detection (none, BZD, AED, antidepressant, neuroleptics, other, none/other, NA), type character
17. **normal.1st.lt.EEG**: Combination of the normality information of the standard and LT EEG, type character
18. **date.CT**: Date of the realisation of the first CT after the index event, type Date(lubridate)
19. **res.CT**: Result of the brain CT (normal, abnormal, none, none but proposed). abnromal CT contain all types of abnormalities: epileptogenic or not, type character
20. **les.CT**: Type of abnormalities (dementia, vascular, tumor, malformation, unknown, none, NA), type = character
21. **res.IRM**: Result of the brain MRI (normal, abnormal, none, none but proposed). abnromal MRI contain all types of abnormalities: epileptogenic or not, type character
22. **date.IRM**: date of the first MRI after first event, type Date (lubridate)
23.**les.IRM**: Type of abnormalities (dementia, vascular, tumor, malformation, unknown, none, NA), type = character
24. **les.epi**: Combined information of CT and MRI specifying if the lesion is epileptogenic, non-epileptogenic, suspicious, or normal
25. **date.1st.cs.su**: Date of the first consultation to the emergency department (ED) after the index event, type POSIXct
26. **date.1st.cs.epi**: Date of the first consultation in the epileptology unit of the HUG, type POSIXct
27. **dx.final**: Final diagnosis (Acute symptomatic seizure (crise provoquee), unknown, cardiovascular origin, psychogenic, other, epilepsy (crise epilepsie) vaso-vagal syncopes, cardiac origin, cardiac) retained after 2 years follow-up (for patients for whom the follow-up information was available), type character
28. **type.epi.final**: For patients with dx.final == crise epilepsie, specification of the epilepsy type (NA, non-lesional, idiopathic generalised (IGE), unknown), type character
29. **dx.final.margitta**: Correction of the diagnosis a posteriori by MS, type character
30. **cat.dx.final**: To be removed, type logical
31. **resident**: to understand why patients were lost in follow-up, infromation of where the patients are living (TRUE = Geneva's area, FALSE = other canton or country), type logical
32. **veille.sommeil**: Did the event happened during sleep or wake time, type character 
33. **status.neuro**: Results of the neuro status (normal, abnormal, none, none but proposed), type character
34. **commentaire**: Brief description of the cases in french, type character
35. **n.ret.SU**: Number of times a patient came back to the ED for a relapse, type numeric
36. **n.recidives.rapp**: Number of reported relapses in consultations, type numeric
37. **n.tot.recidives**: Number of total relapses combining reported and ED consultations, type numeric
38. **type.resident**: Description if the patient lives in another canton, country, had the first seizure while traveling..., type character
39. **SBB.1**: Number of seizures before the index event (1 = first seizure, 2 = one seizure before the index event, 3 = more than one seizure before the index event), type = numeric
40. **SBB.2**: Trajectory of the patients after the ED (1 = hospitalisation, 2 = ambulatory cares or lost, 4 = hospitalisation but with an admission in the intensive care unit before), type = numeric
41.  **SBB.3**: Trajectory of patients after the ED (1 = hospitalisation in epileptology, 2 = hospitalisation in neurology, 3 = hospitalised in the intensive care unit and lost, 4 = hospitalised in neurosurgery, 5 = hospitalised in psychiatry, 6 = hospitalised in another service, 7 = specialised ambulatory cares, 8 = followed outside the hospital or lost), type numeric
42. **SBB.4**: Long term follow-up information for patients with SBB.3 = 7 (1 = other specialised follow-up, 2 = epileptology, 3 = neurology, 4 = neurosurgery, 5 = psychatry), type = numeric
43. **SBB.5**: Trajectory of patients followed-up in epileptology 
  1. follow-up of 12 to 24 months
  2. follow-up by a private neurologist after a 3 months follow-up in the epileptology unit
  3. follow-up by the neurology service after a 3 months follow-up in the epileptology unit
  4. follow-up of 3 to 6 months in the epileptology unit and then stop because not needed
  5. follow-up of 3 to 6 months in the epileptology unit and then followed-up by a private neurologist
  6. follow-up of 6 to 12 months in the epileptology unit and then follow-up not needed anymore
  7. follow-up of 6 to 12 months in the epileptology unit and then followed-up by a private neurologist
  8. follow-up of 6 to 12 months in the epileptology unit and then followed-up by another service
  9. follow-up of 3 to 6 months in the epileptology unit and then followed-up by another service
  10. follow-up by the neurosurgery service after a 3 months follow-up in the epileptology unit
  11. follow-up by another service after a 3 months follow-up in the epileptology unit
  12. 3 months follow-up in the epileptology unit and then lost
  13. 3 months follow-up in the epileptology unit and then follow-up not needed anymore
  14. follow-up of 3 to 6 months in the epileptology unit and then patient lost 
  15. follow-up of 3 to 6 months in the epileptology unit and then follow-up not needed 
  16. follow-up of 6 to 12 months in the epileptology unit and then patient lost 
  17. follow-up of 6 to 12 months in the epileptology unit and then follow-up not needed  
  18. after a follow-up of 12 to 24 months in epileptology, follow-up scheduled
  19. after a follow-up of 12 to 24 months in epileptology, patient lost
  20. after a follow-up of 12 to 24 months in epileptology, follow-up not needed
  21. Follow-up in epileptology at 3 months and then the patient deceased
  22. Follow-up in epileptology at 3 to 6 months and then the patient deceased
  23. Follow-up in epileptology at 6 to 12 months and then the patient deceased
  24. Follow-up in epileptology at 12 to 24 months and then the patient deceased
44. **doute.critere**: Patients for whom the inclusion criteria have been discussed, type logical
45. **date.1st.1st.sz**: Date of the first event event before the index event, type Date (lubridate)
46. **date.2nd.1st.sz**: Date of an eventual second event before the index event, type POSIXct
47. **date.dern.1st.sz**: In case of more than 2 seizures before the index event, date of the last event before the index one, type POSIXct
48. **date.adm.si**: Date of hospitalisation in the intensive care unit, type POSIXct
49. **date.sortie.si**: Date of the end of hospitalisation in the intensive care unit, type Date (lubridate)
50. **date.1st.cs.neuro**: Date of the first consultation in the neurology service, type POSIXct
51. **date.dern.cs.neuro**: Date of the last consultation in the neurology service, type POSIXct
52. **raison_stop_suivi.neuro**: Motive of the interruption of follow-up by the neurology service, type character
53. **date.1st.cs.neurochir**: Date of the first consultation in the neurosurgery service, type POSIXct
54. **date.dern.cs.neurochir**: Date of the last consultation in the neurosurgery service, type POSIXct
55. **raison_stop_suivi.neurochir**: Motive of the interruption of follow-up by the neurosurgery service, type character
56. **date.1st.cs.psy**: Date of the first consultation in the psychiatry service, type POSIXct
57. **date.dern.cs.psy**: Date of the last consultation in the psychiatry service, type POSIXct
58. **raison_stop_suivi.psy**: Motive of the interruption of follow-up by the psychiatry service, type character
59. **date.1st.cs.autre**: Date of the first consultation in another service, type POSIXct
60. **date.dern.cs.autre**: Date of the last consultation in anothers ervice, type POSIXct
61. **raison_stop_suivi.autre**: Motive of the interruption of follow-up by another service, type character
62. **type_suivi.autre**: By which other service the patient was followed-up, type character
63. **date.dern.cs.epi**: Date of the last consultation in the epileptology unit, type POSIXct
64. **date.entree.1st.hospit**: Date of hospitalisation of the patient, type POSIXct
65. **srv.1st.hospit.si_autre**: If SBB.3 = 6, in which service the patient was hospitalised, type character
66. **date.debut.tt**: Date at which the anti-epileptic drug was prescribed, type POSIXct
67. **date.fin.tt**: Date of the end of treatment, type POSIXct
68. **date.dx.final**: Date at which the final diagnosis was announced to the patient, type Date (lubridate)
69. **date.deces**: Date of decease, type POSIXct
70. **cause.deces**: Origin of the death, type character
71. **date.entree.2nd.hospit**: In case of a second hospitalisation after the seizure (seizure --> emergency dept. --> hospitalisation --> 2nd hospitalisation), date of entry in the service, type POSIXct
72. **date.sortie.2nd.hospit**: In case of a second hospitalisation after the first seizure, date of release from the hospital, type POSIXct
73. **srv.2nd.hospit**: Medical service in which the second hospitalisation took place, type character
74. **type.1st.sz**: type of the first seizure (secondary generalized seizures; focals, generalized, acute symptomatic, unknown), type character
75. **type.principal.seizure**: Main type of seizure experienced by a patient, type character
76. **dx.initial**: diagnosis proposed after the first consultation, type character
77. **type.epi.initial**: Epilepsy type proposed after the first consultation, type character
78. **type.autre.initial**: For patients who recieved the diagnosis other, specification of the origin of the episode after the first consultation, type character
79. **type.autre.final**: For patients who recieved the diagnosis other, specification of the origin of the episode after 2 years follow-up, type character
80. **type.cardiovasculaire**: For the patients who recived the diagnosis of cardiovascular origin to their first event, description of the type of cardiovascular disease, type character
81. **date.sortie.1st.hospit**: Date of release after the first hospitalisation, type POSIXct
82. **review.dx**: Patients for whom the diagnosis needed a review, irrelevant column, type logical
83. **AED**: Is the patient under anti-epileptic drug ? type logical
84. **EEG.result_resume**: Summary column groupping the information of the different modalities of pointes.1st.EEG and slow.1st.EEG, type character
85. **EEG.lt.result_resume**: Summary column groupping the information of the different modalities of pointes.lt.EEG and slow.lt.EEG, type character
86. **operated**: Has the patient been operated ? type logical
87. **ATCD_specific**: Description of the medical history before the first event, type character
88. **les.progressive**: For patients who showed a brain lesion, specification if the lesion was progressive or not, type character
89. **type_EGI**: For patients with generalized epilepsy, specification of the type of generalized epilepsy, type character
90. **dx.general**: Reformulation of the column dx.final (Epileptic seizure, non-epileptic event, unknown), type character
91. **dx.event**: Reformulation of the column dx.final (Acute syptomatic seizure, Epilepsy, cardiovascular...), type character
92. **dx.epi**: Reformulation of the column dx.final and type.epi.final (focal vs. generalized), type character
  

# Method

```{r Method 1}
# Not the first event
tot_pat <- nrow(data_full_cleaned%>%filter(!is.na(code.pat)))
N_not_first_event <- nrow(data_full_cleaned%>%filter(SBB.1 > 1))
pct_not_first_event <- pct.fun(nrow(data_full_cleaned%>%filter(SBB.1 > 1)), nrow(data_full_cleaned%>%filter(!is.na(code.pat))))

# N patients admited in the ED
N_pat_adm_ED <- nrow(data_full_cleaned%>%filter(!is.na(date.1st.cs.su)))

pct_pat_adm_ED <- pct.fun(nrow(data_full_cleaned%>%filter(!is.na(date.1st.cs.su))), nrow(data_full_cleaned%>%filter(!is.na(code.pat))))

```


In `r pct_not_first_event` (N = `r N_not_first_event`/`r tot_pat`) detailed patient history showed that the index event was not the first one. Most of the patients were admitted in the ED (`r pct_pat_adm_ED`; N = `r N_pat_adm_ED`/`r tot_pat`), the remainder on the ward outside the neurology clinic. 

```{r Method2}
# Delay EEG

N_EEG_24h <- nrow(data_full_cleaned%>%
  mutate(delay_EEG = date.1st.EEG - date.1st.cs.su)%>%
  select(delay_EEG)%>%
  filter(delay_EEG < 2))

N_EEG <- nrow(data_full_cleaned%>%filter(!is.na(res.1st.EEG)))

pct_N_EEG_24h <- pct.fun(N_EEG_24h, N_EEG)

# N CT
N_CT <- nrow(data_full_cleaned%>%
  filter(res.CT != "aucun" & res.CT != "aucun mais propose"))

pct_CT <- pct.fun(N_CT, tot_pat)

# Delays
delays <- data_full_cleaned%>%filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  mutate(delay_mri = as.numeric(date.IRM - date.1st.cs.su),
         delay_lt_eeg = as.numeric(date.lt.EEG - date.1st.cs.su))%>%
  filter(delay_mri >= 0 | delay_lt_eeg >= 0)%>%
  select(delay_mri, delay_lt_eeg, date.IRM, date.lt.EEG, date.1st.cs.su)%>%
  summarise(median_delay_mri = median(delay_mri, na.rm = T),
            median_delay_lt_eeg= median(delay_lt_eeg, na.rm = T))
```


For all patients, routine EEG within 24 h was organized, and obtained in `r pct_N_EEG_24h` (N = `r N_EEG_24h`/`r N_EEG`) of the cases. CT was carried out in `r pct_CT` (N = `r N_CT`/`r tot_pat`) of the cases. As an effect of our preliminary analysis of the yield of long-term EEG (LT-EEG) and MRI from the study of Fisch et al (JOON), both exams were often already organized by the colleague in the ED and obtained on median within `r delays[,2]` and `r delays[,1]` days, respectively.

```{r cleaning_methods, include=FALSE}

rm(delays, N_CT, N_EEG, N_EEG_24h, N_not_first_event, N_pat_adm_ED, pct_CT, pct_N_EEG_24h, pct_not_first_event, pct_pat_adm_ED)

```


# Results

```{r Results 1}
# N female patients
N_fem <- nrow(data_full_cleaned[data_full_cleaned$genre == "F",])

# Mean age
M_SD_age <- data_full_cleaned%>%summarise(M_age = round(mean(age),1),
                                          SD_age = round(sd(age),1))
#range age
range_age <- range(data_full_cleaned$age)

# N patients with epileptic seizure
N_epi_sz <- data_full_cleaned%>%
  filter(dx.general == "Epileptic seizure")%>%
  summarise(N_epi_sz = n(),
            pct_epi_sz = pct.fun(N_epi_sz, tot_pat))

# N patients acute symptomatic seizure

tot_epi_sz <- nrow(data_full_cleaned[data_full_cleaned$dx.general == "Epileptic seizure",])

N_acute <- data_full_cleaned%>%
  filter(dx.event == "Acute symptomatic seizure")%>%
   summarise(N_acute = n(),
            pct_acute_tot = pct.fun(N_acute, tot_pat),
            pct_acute_epi = pct.fun(N_acute, tot_epi_sz))

# cause non-epileptic nature
non_epi <- data_full_cleaned%>%
  filter(dx.general == "Non epileptic event")%>%
  summarise(N_non_epi = n(),
            pct_non_epi = pct.fun(N_non_epi, tot_pat))

# N pat_per dx
tot_non_epi <- nrow(data_full_cleaned%>%filter(dx.event != "Epilepsy" | is.na(dx.event)))

N_dx_event <- data_full_cleaned%>%
  group_by(dx.event)%>%
  summarise(N = n(),
            pct_tot = pct.fun(N,tot_pat),
            pct_non_epi = pct.fun(N,tot_non_epi))

```


We included `r tot_pat` patients, `r N_fem` women, with a mean age of `r M_SD_age[1]` (SD= `r M_SD_age[2]`) years, ranging from `r range_age[1]` to `r range_age[2]`. Most patients were finally diagnosed with an epileptic event (`r N_epi_sz[2]`, N = `r N_epi_sz[1]`/`r tot_pat`), of which `r N_acute[1]` suffered from an acute symptomatic seizure (`r N_acute[2]` of the total sample or `r N_acute[3]` of all patients with an epileptic seizure). The cause was of non-epileptic nature in `r non_epi[2]` (`r non_epi[1]`/`r tot_pat`) of the cases, of which most had a cardiovascular origin (`r N_dx_event$pct_non_epi[N_dx_event$dx.event == "Cardiovascular"][1]`; `r N_dx_event$N[N_dx_event$dx.event == "Cardiovascular"][1]`/`r tot_non_epi`). A psychogenic origin was diagnosed in `r N_dx_event$N[N_dx_event$dx.event == "Psychogenic non epileptic seizure"][1]` subjects (`r N_dx_event$pct_tot[N_dx_event$dx.event == "Psychogenic non epileptic seizure"][1]` of the total sample).
In `r N_dx_event$N[is.na(N_dx_event$dx.event)]` patients (`r N_dx_event$pct_tot[is.na(N_dx_event$dx.event)]`), the causes of the index event remained unknown. The most frequent reasons of lack of diagnosis were a) lost to follow-up, b) patients with undetermined diagnosis were not residents in the Geneva area. 

**Distribution of the diagnoses in the tree**

```{r diagnostic tree}
##-----------------------------------------------------------------------
##  Creation of the summary tables for each step of the diagnostic tree  
##-----------------------------------------------------------------------

# first step

data_full_cleaned%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))
data_full_cleaned%>% group_by(genre)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))


# second step

data_full_cleaned%>%
  group_by(dx.general)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))
data_full_cleaned%>% group_by(dx.general, genre)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

# Third step 

data_full_cleaned%>%
  group_by(dx.general,dx.event)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

data_full_cleaned%>%
  group_by(dx.general,dx.event, genre)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

# Fourth step 

data_full_cleaned%>%
  group_by(dx.event, dx.epi)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))


data_full_cleaned%>%
  group_by(dx.event, dx.epi, genre)%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

# Fifth step 

data_full_cleaned%>%
  filter(type.epi.final == "lesionnelle")%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

data_full_cleaned%>%
  filter(type.epi.final == "non lesionnelle")%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))


data_full_cleaned%>%
  group_by(genre)%>%
  filter(type.epi.final == "lesionnelle")%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))

data_full_cleaned%>%
  group_by(genre)%>%
  filter(type.epi.final == "non lesionnelle")%>%
  summarise(N = n(), age.pat = mean(age), sd = sd(age))
```

**END of Distribution of the diagnoses in the tree**


```{r Results 2}
# Not the first event

N_not_first_event <- nrow(data_full_cleaned%>%filter(SBB.1 > 1))
pct_not_first_event <- pct.fun(nrow(data_full_cleaned%>%filter(SBB.1 > 1)), nrow(data_full_cleaned%>%filter(!is.na(code.pat))))

# ANOVA on age:


data_lm_age <- data_full_cleaned%>%
  mutate(more_1_event = ifelse(SBB.1 > 1, "many", "one"))%>%
  mutate(dx_paste = ifelse(dx.event == "Epilepsy", paste(dx.event, type.epi.final),dx.event))%>%
  select(code.pat, age, dx.event, dx.epi,  more_1_event, dx_paste, genre, les.epi)

hist(data_lm_age$age)

model_age <- lm(age ~  dx_paste + more_1_event + genre + les.epi, data = data_lm_age)
vif(model_age)

```
An ANOVA was performed to investigate age differences among the different diagnoses, the patients for whom the index event was the first one or not, genders, and patients with or without an epileptogenic lesion (observed either at CT or MRI). Results suggest a main effect of diagnosis (`r report_mainef_lm(model_age)[1,2]`), implying age differences among the different diagnoses, no main effect of the number of events before the index one (`r report_mainef_lm(model_age)[2,2]`), a main effect of gender (`r report_mainef_lm(model_age)[3,2]`), suggesting that male patients are significantly older than female patients. Moreover, the model showed a significant main effect of the presence or absence of an epileptogenic lesion (`r report_mainef_lm(model_age)[4,2]`), suggesting that patients who show epileptogenic lesions tend to be older. 

```{r Table 3}
temp <- data_full_cleaned%>%
  group_by(ATCD_specific)%>%
  summarise(N = n())%>%
  mutate( ATCD_specific = case_when(ATCD_specific == 'aucun' ~ 'No comorbidities',
                                    ATCD_specific == 'autres' ~ 'Other',
                                    ATCD_specific == 'cardiaque' ~ 'Cardiac',
                                    ATCD_specific == 'neurologique' ~ 'Neurologic',
                                    ATCD_specific == 'psychiatrique' ~ 'Psychiatric'))%>%
  filter(!is.na(ATCD_specific))%>%
  mutate(PCT = pct.fun_n(N, 777))%>%
  rename(`Relevant events in medical history` = ATCD_specific)

N_atcd_positive <- temp%>%filter(`Relevant events in medical history` != "No comorbidities")%>%summarize(sum(N))
N_atcd <- temp%>%summarize(sum(N))

```

In `r pct_not_first_event` (N = `r N_not_first_event`/`r tot_pat`) of the patients, the index event (both epileptic and non-epileptic) was not the first. As described above, the mean age of these was not significantly different from the true FS patients (`r report_mainef_lm(model = model_age)[2,2]`). Table X summarizes the medical history which was positive in `r pct.fun(N_atcd_positive, N_atcd)`. 

`r kable(temp)`

*Table 3: description of the medical history of patients included in the study. This information was available only for `r sum(temp$N)` patients over the entire sample of `r tot_pat` patients.*

## Diagnoses

### Epilepsy

```{r epilepsy}

# Chi2 frequency event sleep between epilepsy and non-epilepsy patients
data_chi <- data_full_cleaned%>%select(dx.general, veille.sommeil)%>%
  filter(veille.sommeil != "non documente")%>%
  mutate(dx.general = ifelse(dx.general == "Epileptic seizure", "epileptic seizure", "not epileptic event"))%>%
  group_by(dx.general, veille.sommeil)%>%
  summarise(N = n())%>%
  spread(key = veille.sommeil, N)

data_chi <- as.data.frame(data_chi)
row.names(data_chi) <- data_chi$dx_cat
data_chi <- data_chi[,2:3]

chi_sleep_wake <- chisq.test(data_chi)

# seizure occuring in sleep

sz_sleep <- data_full_cleaned%>%
  filter(veille.sommeil == "sommeil")%>%
  filter(dx.general == "Epileptic seizure") %>%
  summarise(N = n())

sz_sleep_epi <- data_full_cleaned%>%
  filter(veille.sommeil == "sommeil")%>%
  filter(!is.na(code.pat))%>%
  filter(dx.general == "Epileptic seizure") %>%
  filter(dx.event == "Epilepsy")%>%
  summarise(N = n())

# N per epilepsy types
N_epi_dx <- data_full_cleaned%>%
  group_by(dx.epi, type.epi.final)%>%
  summarise(N = n(),
            mean_age = mean(age, na.rm = T),
            sd_age = sd(age, na.rm = T))

tot_epi_disease <- nrow(data_full_cleaned%>%filter(dx.event == "Epilepsy"))

# % and N patients "operated" --> only the tumoral patients

N_pat_tumor <- data_full_cleaned%>%
  filter(type.epi.final == "lesionnelle")%>%
  filter(les.CT == "tumoral" | les.IRM == "tumoral")%>%
  summarise(N = n())

# post_hocs on the lm ANOVA investigating age differences among diagnoses
post_hoc_dx <- emmeans(model_age, list(pairwise ~ dx_paste), adjust = "tukey")
post_hoc_dx <- as.data.frame(post_hoc_dx$`pairwise differences of dx_paste`)
post_hoc <- report_emmeans(post_hoc_dx)
```


If the event occurred during sleep, it was more likely to be of epileptic origin (`r report_chi(chi_sleep_wake)`). Seizures occurred during sleep in `r pct.fun(sz_sleep, tot_epi_disease)` (N = `r sz_sleep`/`r tot_epi_disease`) of the cases, and `r pct.fun(sz_sleep_epi, sz_sleep)` (N = `r sz_sleep_epi`/`r sz_sleep`) of these patients had later confirmed epilepsy. `r N_epi_dx$N[N_epi_dx$type.epi.final == "lesionnelle"][1]`/`r tot_pat` (`r pct.fun(N_epi_dx$N[N_epi_dx$type.epi.final == "lesionnelle"][1], tot_pat)`) had SE, i.e. 80.6% (`r N_epi_dx$N[N_epi_dx$type.epi.final == "lesionnelle"][1]`/`r tot_epi_disease`) of all epilepsy patients. Among the epileptic patients, `r N_pat_tumor`/`r N_epi_dx$N[N_epi_dx$type.epi.final == "lesionnelle"][1]` (`r pct.fun(N_pat_tumor, N_epi_dx$N[N_epi_dx$type.epi.final == "lesionnelle"][1])`) were diagnosed with a tumor and were operated. Non-lesional focal epilepsy affected `r N_epi_dx$N[N_epi_dx$type.epi.final == "non lesionnelle"][1]` patients (`r pct.fun(N_epi_dx$N[N_epi_dx$type.epi.final == "non lesionnelle"][1], tot_pat)` of all patients, or `r pct.fun(N_epi_dx$N[N_epi_dx$type.epi.final == "non lesionnelle"][1], tot_epi_disease)` of epileptic patients). The mean age (`r round(N_epi_dx$mean_age[N_epi_dx$type.epi.final == "non lesionnelle"][1],1)`, SD = `r round(N_epi_dx$sd_age[N_epi_dx$type.epi.final == "non lesionnelle"][1],1)`) was lower than that of SE patients (Mean = `r round(N_epi_dx$mean_age[N_epi_dx$type.epi.final == "lesionnelle"][1],1)`; SD = `r round(N_epi_dx$sd_age[N_epi_dx$type.epi.final == "lesionnelle"][1],1)`), but the difference did not reach significance (`r post_hoc$report[31]`). Because only patients older than 16 years were included, we diagnosed IGE only in `r N_epi_dx$N[N_epi_dx$type.epi.final == "generalisee idiopathique"][1]` patients (`r pct.fun(N_epi_dx$N[N_epi_dx$type.epi.final == "generalisee idiopathique"][1], tot_pat)` of all patients or `r pct.fun(N_epi_dx$N[N_epi_dx$type.epi.final == "generalisee idiopathique"][1], tot_epi_disease)` of epileptic patients, mean age: `r round(N_epi_dx$mean_age[N_epi_dx$type.epi.final == "generalisee idiopathique"][1],2)`; SD = `r round(N_epi_dx$sd_age[N_epi_dx$type.epi.final == "generalisee idiopathique"][1],2)` ). The most frequent syndrome was juvenile myoclonic epilepsy (N = 13) and grand mal on awakening (N = 3). In 17 patients, the precise syndrome was not clear despite generalized epileptogenic abnormalities in the EEG, except for one patient with normal EEG but strongly suggestive semiology. Not surprisingly, the IGE group was significantly younger than the group of patients with focal epilepsy (IGE vs. SE: `r post_hoc$report[25]`; IGE vs. NLE: `r post_hoc$report[26]`). 

### Psychogenic origin

```{r Psychogenic origin}
N_epi_non_dx <- data_full_cleaned%>%
  group_by(dx.event)%>%
  summarise(N = n(),
            mean_age = round(mean(age, na.rm = T),2),
            sd_age = round(sd(age, na.rm = T),2))

# N men in the PNES group
post_hoc_gender_PNES <- emmeans(model_age, list(pairwise ~ genre|dx_paste), adjust = "tukey")
post_hoc_gender_PNES <- post_hoc_gender_PNES$`pairwise differences of genre | dx_paste`
post_hoc_gender_PNES <- as.data.frame(post_hoc_gender_PNES)

temp <- data_full_cleaned%>%
  filter(dx.event == "Psychogenic non epileptic seizure")%>%
  group_by(genre)%>%
  summarise(N = n())

N_H_psy <- temp$N[temp$genre == "H"]
N_psy <- sum(temp$N)

```


In `r N_epi_non_dx$N[N_epi_non_dx$dx.event == "Psychogenic non epileptic seizure"][1]` patients, seizures were of psychogenic origin (`r pct.fun(N_epi_non_dx$N[N_epi_non_dx$dx.event == "Psychogenic non epileptic seizure"][1], tot_pat)` of the whole sample). These patients were significantly younger than those from the other groups (mean age: `r N_epi_non_dx$mean_age[N_epi_non_dx$dx.event == "Psychogenic non epileptic seizure"][1]`; SD = `r N_epi_non_dx$sd_age[N_epi_non_dx$dx.event == "Psychogenic non epileptic seizure"][1]`),  i.e. the cardiac group (`r post_hoc$report[15]`), the cardiovascular group (`r post_hoc$report[22]`), SE (`r post_hoc$report[33]`) and compared to the other diagnoses (`r post_hoc$report[40]`). Even though women were significantly more likely to have psychogenic non-epileptic seizures (t(919) = 2.78; p = 0.005) compared to other non-epileptic diagnoses, men also presented psychogenic events (`r pct.fun(N_H_psy, N_psy)`, N = `r N_H_psy`/`r N_psy`).

### Cardiovascular origin

```{r cardiovascular origin}
ATCD <- data_full_cleaned%>%
  group_by(ATCD_specific)%>%
  summarise(N = n(),
            AGE = mean(age, na.rm = T),
            SD_AGE = sd(age, na.rm = T))%>%
  mutate(ATCD_specific = case_when(ATCD_specific == 'aucun' ~ 'No comorbidities',
                                    ATCD_specific == 'autres' ~ 'Other',
                                    ATCD_specific == 'cardiaque' ~ 'Cardiac',
                                    ATCD_specific == 'neurologique' ~ 'Neurologic',
                                    ATCD_specific == 'psychiatrique' ~ 'Psychiatric'))%>%
  filter(!is.na(ATCD_specific))%>%
  mutate(PCT = pct.fun_n(N,777))

temp <- data_full_cleaned%>%
  mutate(cat_age = ifelse(age < 60, '<60', '>60'))%>%
  filter(dx.event == "Cardiovascular")%>%
  group_by(cat_age)%>%
  summarise(N = n(),
    mean_age = round(mean(age, na.rm = T),2),
            sd_age = round(sd(age, na.rm = T),2))
  N_less_60 <- temp$N[temp$cat_age == "<60"]

# age range Cardiovascular
  
  age_range_cardio <- range(data_full_cleaned$age[data_full_cleaned$dx.event == "Cardiovascular"], na.rm = T)

# description types cardiovascular
types_cardiovasc <- data_full_cleaned%>%
  filter(dx.event == "Cardiovascular")%>%
  group_by(type.cardiovasculaire)%>%
  summarise(N = n())%>%
  mutate(type.cardiovasculaire = case_when(type.cardiovasculaire == "ACR" ~ "Cardiac arrest",
                   type.cardiovasculaire == "AIT" ~ "Transient ischemic attack",
                   type.cardiovasculaire == "AVC" ~ "Stroke",
                   type.cardiovasculaire == "multifactoriel" ~ "Multifactorial",
                   type.cardiovasculaire == "symptomes post-AVC" ~ "Post-stroke symptoms",
                   type.cardiovasculaire == "syncope" ~ "Syncope"))

```


Not surprisingly, patients (N= `r N_epi_non_dx$N[N_epi_non_dx == "Cardiovascular"][1]`) were on average significantly older than the vasovagal and orthostatic syncope group (`r post_hoc$report[24]`), the NLE group (`r post_hoc$report[20]`), the IGE group (`r post_hoc$report[18]`), as well as the psychogenic group (`r post_hoc$report[22]`). In most of the patients (`r 100- ATCD$PCT[ATCD$ATCD_specific == "Cardiac"]`%) of the patients, no prior cardiac problems were reported. The mean age of these patients was `r N_epi_non_dx$mean_age[N_epi_non_dx == "Cardiovascular"][1]` (SD = `r N_epi_non_dx$sd_age[N_epi_non_dx == "Cardiovascular"][1]`), with `r pct.fun(N_less_60,N_epi_non_dx$N[N_epi_non_dx == "Cardiovascular"][1])` younger than 60 years (range: `r age_range_cardio[1]` to `r age_range_cardio[2]` years old).

`r kable(types_cardiovasc)`

*Table 4: description of the diagnosis embedded on the cardiovascular group of patients *

### Vaso-vagal and orthostatic syncopes

Overall, `r pct.fun(N_epi_non_dx$N[N_epi_non_dx$dx.event == "Vaso-vagal and orthostatic syncopes"][1], tot_pat)` of the patients in the total sample were diagnosed with non-cardiac syncopes. Predictably, they were significantly younger than those with cardiac syncopes (`r post_hoc$report[17]`). Long post-syncope confusion, the notion of clonic or asymmetric movements, or certain comorbidities affecting the CNS required in-depth investigations.

## Diagnostic tools

### MRI - CT

```{r MRI-CT}
N_les <- data_full_cleaned%>%
  filter(res.IRM != "aucun", res.IRM != "aucun mais propose")%>%
  group_by(les.epi)%>%
  summarise(N = n())

N_normal <- N_les$N[N_les$les.epi == "normal"]+N_les$N[N_les$les.epi == "lesion non epileptogene"]

post_hoc_les <- emmeans(model_age, list(pairwise ~ les.epi), adjust = "tukey")
post_hoc_les <- as.data.frame(post_hoc_les$`pairwise differences of les.epi`)
post_hoc_les <- report_emmeans(post_hoc_les)

# Among epileptic patients

N_les_epi <- data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  filter(res.IRM != "aucun", res.IRM != "aucun mais propose")%>%
  group_by(les.epi)%>%
  summarise(N = n())

N_normal_epi <- N_les_epi$N[N_les_epi$les.epi == "normal"]+N_les_epi$N[N_les_epi$les.epi == "lesion non epileptogene"]

```


Among all patients, `r N_normal` had a normal MRI or showed benign abnormalities (few small white matter lesions, developmental venous abnormalities, etc), while `r N_normal_epi` epileptic patients showed normal or non-epileptogenic lesions. `r N_les$N[N_les$les.epi == "douteux"]` of the `r sum(N_les$N)` patients with an MRI (`r pct.fun(N_les$N[N_les$les.epi == "douteux"], sum(N_les$N))`) belonged to the intermediate category. Among the epileptic patients, the proportion is relatively similar (`r pct.fun(N_les_epi$N[N_les_epi$les.epi == "douteux"], sum(N_les_epi$N))`  or `r N_les_epi$N[N_les_epi$les.epi == "douteux"]` of the `r sum(N_les_epi$N)` patients). Regarding age, patients with an epileptogenic lesion and intermediate lesion were significantly older than the patients without lesion (epileptogenic lesion: `r post_hoc_les$report[9]`; intermediate: `r post_hoc_les$report[7]`).

### Standard EEG

```{r Standard EEG 1}

# Epileptic abnormalities on the EEG

N_epi_spikes <- nrow(data_full_cleaned%>%
  filter(!is.na(code.pat))%>%
  filter(dx.event == "Epilepsy")%>%
  filter(EEG.result_resume == "pointes" | 
         EEG.result_resume == "pointes+slow"))


N_epi_EEG <- nrow(data_full_cleaned%>%
  filter(!is.na(code.pat))%>%
  filter(dx.event == "Epilepsy")%>%
  filter(res.1st.EEG != "aucun" ,
         res.1st.EEG != "aucun mais propose"))

# Non-epileptic abnormalities on the EEG

N_non_epi_abn_EEG <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(EEG.result_resume == "slow"))


# Normal EEG among epileptic patients 

N_epi_norm_EEG <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(res.1st.EEG == "normal"))


# Delay EEG 

EEG_24 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay < 2)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_24_48 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 2 & eeg_delay < 3)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_48_72 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 3 & eeg_delay < 4)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

EEG_more_72 <- nrow(data_full_cleaned%>%
  mutate(eeg_delay = date.1st.EEG - date.1st.cs.su)%>%
  filter(eeg_delay >= 4)%>%
  select(EEG.result_resume, eeg_delay, dx.final, type.epi.final))

N_tot_EEG_time <- nrow(data_full_cleaned[!is.na(data_full_cleaned$date.1st.cs.su) & !is.na(data_full_cleaned$date.1st.EEG),])

# Chi squares efficacy EEG delay all patients 
data_chi <- data_full_cleaned%>%
  mutate(spikes.dicho = ifelse(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow", "pointes", "pas_pointes"),
         spikes.dicho = ifelse(is.na(spikes.dicho), "pas_pointes", spikes.dicho),
         eeg_delay = as.numeric(date.1st.EEG - date.1st.cs.su),
         cat_delay = case_when(eeg_delay < 2 ~ "24h",
                               eeg_delay > 1 & eeg_delay < 3 ~ "48h",
                               eeg_delay > 2 & eeg_delay <4 ~ "72h",
                               eeg_delay >=4 ~ "+72h"))%>%
           group_by(cat_delay, spikes.dicho)%>%
  summarise(N = n())%>%
  spread(cat_delay, N)

rownames <- data_chi$EEG_delay_cat
data_chi <- data_chi[,2:ncol(data_chi)]
data_chi <- as.data.frame(data_chi, row.names =rownames)
data_chi <- as.data.frame(data_chi, row.names =rownames)

chi2_EEG_all <- chisq.test(data_chi, simulate.p.value = T)

# Chi squares efficacy EEG delay epileptic patients 

data_chi <- data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  mutate(spikes.dicho = ifelse(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow", "pointes", "pas_pointes"),
         spikes.dicho = ifelse(is.na(spikes.dicho), "pas_pointes", spikes.dicho),
         eeg_delay = as.numeric(date.1st.EEG - date.1st.cs.su),
         cat_delay = case_when(eeg_delay < 2 ~ "24h",
                               eeg_delay > 1 & eeg_delay < 3 ~ "48h",
                               eeg_delay > 2 & eeg_delay <4 ~ "72h",
                               eeg_delay >=4 ~ "+72h"))%>%
           group_by(cat_delay, spikes.dicho)%>%
  summarise(N = n())%>%
  spread(cat_delay, N)

rownames <- data_chi$EEG_delay_cat
data_chi <- data_chi[,2:ncol(data_chi)]
data_chi <- as.data.frame(data_chi, row.names =rownames)
data_chi <- as.data.frame(data_chi, row.names =rownames)

chi2_EEG_epi <- chisq.test(data_chi, simulate.p.value = T)

```


In `r N_epi_spikes` epileptic patients (over `r N_epi_EEG` who underwent an EEG; `r pct.fun(N_epi_spikes, N_epi_EEG)`), the EEG showed epileptiform abnormalities, and in another `r N_non_epi_abn_EEG` (`r pct.fun(N_non_epi_abn_EEG, N_epi_EEG)`) unspecific abnormalities were identified, leaving `r N_epi_norm_EEG` (`r pct.fun(N_epi_norm_EEG, N_epi_EEG)`) with a completely normal EEG. While we aimed at carrying out the EEG within 24h, this was not always possible. Among all diagnoses, in `r EEG_24` (`r pct.fun(EEG_24, N_tot_EEG_time)`) out of `r N_tot_EEG_time` patients for whom the timing information could be retrieved, the standard EEG was done within 24h. `r pct.fun(EEG_24_48, N_tot_EEG_time)` (N = `r EEG_24_48`/`r N_tot_EEG_time`) of the EEG were realised between 24 and 48h, while `r pct.fun(EEG_48_72, N_tot_EEG_time)` (N = `r EEG_48_72`/`r N_tot_EEG_time`) were done between 48h and 72h, and the reminder `r pct.fun(EEG_more_72, N_tot_EEG_time)` (N = `r EEG_more_72`/`r N_tot_EEG_time`) after 72h. There was no difference in the occurrence of epileptiform or any abnormal finding between the different delays of the whole group (`r report_chi(chi2_EEG_all)`) or of the group of epileptic patients taken separately (`r report_chi(chi2_EEG_epi)`). 

```{r Standard EEG 2}
temp <- data_full_cleaned%>%filter(dx.event != "Epilepsy" | is.na(dx.event))%>%
  filter(EEG.result_resume == "pointes" | EEG.result_resume == "pointes+slow")%>%
  group_by(dx.general, dx.event, dx.epi)%>%
  summarise(N = n())

N_spikes_not_epi <- nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "pointes" | 
           EEG.result_resume == "pointes+slow")%>%
  filter(dx.event != "Epilepsy" & dx.event != "Acute symptomatic seizure" & dx.event != "Unknown")%>%
  select(code.pat, date.1st.cs.su, date.1st.EEG, res.1st.EEG, EEG.result_resume,  date.lt.EEG, res.lt.EEG, EEG.lt.result_resume, dx.final, type.epi.final, type.autre.final))

N_spikes_not_epi_lt_normal <- nrow(data_full_cleaned%>%
  filter(EEG.result_resume == "pointes" | 
           EEG.result_resume == "pointes+slow")%>%
  filter(dx.event != "Epilepsy" & dx.event != "Acute symptomatic seizure" & dx.event != "Unknown")%>%
    filter(res.lt.EEG == "normal")%>%
  select(code.pat, date.1st.cs.su, date.1st.EEG, res.1st.EEG, EEG.result_resume,  date.lt.EEG, res.lt.EEG, EEG.lt.result_resume, dx.final, type.epi.final, type.autre.final))

```


Except from acute symptomatic seizures (N = `r temp$N[temp$dx.event == "Acute symptomatic seizure"][1]`) unknown diagnosis (N= `r temp$N[temp$dx.general == "Unknown"][1]`) and unknown epilepsy type (N = `r temp$N[temp$dx.event == "Unknown"][1]`), epileptiform abnormalities were found in `r N_spikes_not_epi` patients out of `r tot_non_epi` without a diagnosis of epilepsy on the standard EEG, corresponding to `r pct.fun(N_spikes_not_epi, tot_non_epi)` of false positive results. For `r N_spikes_not_epi_lt_normal` of them, the LT EEG was normal and the epileptogenic abnormality (sharper slow waves in all cases) was not confirmed. Regarding the 4 *(!!!fixed number !!!!)* other cases, LT EEG was either refused or not proposed to the patient, but the observed epileptiform discharges location was not concordant with the semiology of the event, leading to the exclusion of the diagnosis of epilepsy despite the observed electrical abnormalities.

Note: check corrections Pia

### Long-term EEG

```{r LT-EEG}

N_LT_EEG <- nrow(data_full_cleaned%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose"))

N_spikes_LTEEG <- nrow(data_full_cleaned%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
    filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow"))

N_spikes_LTEEG_epi <- nrow(data_full_cleaned%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
    filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow")%>%
    filter(dx.event == "Epilepsy"))

spikes_non_epi <- data_full_cleaned%>%
  filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow")%>%
  filter(dx.event != "Epilepsy")%>%
  group_by(dx.event)%>%
  summarise(N = n())

N_LT_EEG_norm_std <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(EEG.result_resume == "slow" | res.1st.EEG == "normal")%>%
         filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose"))

N_LT_EEG_norm_std_spikes <- nrow(data_full_cleaned%>%
       filter(!is.na(code.pat))%>%
       filter(dx.event == "Epilepsy")%>%
       filter(EEG.result_resume == "slow" | res.1st.EEG == "normal")%>%
         filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
         filter(EEG.lt.result_resume == "pointes" | EEG.lt.result_resume == "pointes+slow"))

```


`r N_LT_EEG` patients underwent LTM-EEG. Overall, `r N_spikes_LTEEG` patients (`r pct.fun(N_spikes_LTEEG, N_LT_EEG)`) showed epileptiform discharges, and `r N_spikes_LTEEG_epi` (`r pct.fun(N_spikes_LTEEG_epi, N_spikes_LTEEG)`) of them were finally diagnosed with epilepsy. Among the remaining `r N_spikes_LTEEG - N_spikes_LTEEG_epi`, `r number_to_word(spikes_non_epi$N[spikes_non_epi$dx.event == "Acute symptomatic seizure"][1])` of them were diagnosed as acute symptomatic seizures, and for `r number_to_word(spikes_non_epi$N[spikes_non_epi$dx.event == "Unknown"][1])` others, the pathological nature of the anomalies remained uncertain. For `r number_to_word(spikes_non_epi$N[spikes_non_epi$dx.event == "Other"][1])` patient, the diagnosed was considered other, namely....
Of the patients with epilepsy but normal EEG or non-epileptogenic abnormalities at the standard EEG (N = `r N_epi_norm_EEG + N_non_epi_abn_EEG`), `r N_LT_EEG_norm_std` (`r pct.fun(N_LT_EEG_norm_std, (N_epi_norm_EEG + N_non_epi_abn_EEG))`) underwent LTM-EEG which identified epileptiform discharges in an additional `r N_LT_EEG_norm_std_spikes` patients (`r pct.fun(N_LT_EEG_norm_std_spikes,N_LT_EEG_norm_std)`).

### Multimodal information

```{r Multimodal information}
# Patients with all 3 negative exams

N_pat_all_normal <- nrow(data_full_cleaned%>%
  filter(pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" & res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
   filter(pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" & res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(les.epi == "normal" | les.epi == "lesion non epileptogene")%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose"))

N_pat_all_normal_suspicious_les <- nrow(data_full_cleaned%>%filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(EEG.result_resume == "slow" | is.na(EEG.result_resume))%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(EEG.lt.result_resume == "slow" | is.na(EEG.lt.result_resume))%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(les.epi != "lesion epileptogene")%>%
  select(pointes.1st.EEG, pointes.lt.EEG, res.IRM, les.epi)%>%
  filter(les.epi == "douteux"))

# N patients epileptic among these patients
N_pat_all_normal_epi <- nrow(data_full_cleaned%>%
  filter(pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" & res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" & res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(les.epi == "normal" | les.epi == "lesion non epileptogene")%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(dx.event == "Epilepsy"))

# Same but only with routine EEG and MRI
N_pat_all_normal_epi_lt_mri <- nrow(data_full_cleaned%>%
  filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" & res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(les.epi == "normal" | les.epi == "lesion non epileptogene")%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(dx.event == "Epilepsy"))


```


While routine EEG, MRI and LTM-EEG are the hallmark exams to diagnose epilepsy, we were wondering what the combined yield is. Among patients with all three negative exams (N = `r N_pat_all_normal`), `r number_to_word(N_pat_all_normal_epi)` patients were nevertheless diagnosed with epilepsy (`r pct.fun(N_pat_all_normal_epi,N_pat_all_normal)` without taking into account the `r N_pat_all_normal_suspicious_les` patients with intermediate lesions). If only MRI and long-term EEG are negative, this number rises to `r number_to_word(N_pat_all_normal_epi_lt_mri)` i.e. `r number_to_word(N_pat_all_normal_epi_lt_mri - N_pat_all_normal_epi)` patients (`r pct.fun((N_pat_all_normal_epi_lt_mri - N_pat_all_normal_epi), tot_epi_disease)` of the group of epileptic patients) would be incorrectly diagnosed as non-epileptic. 

These patients presented a semiology... 

Note: Add a probability tree with the three exams to see probabilities among the different exams

```{r probability tree multimodal information}

data_tree_exams <- data_full_cleaned%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  #filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(les.epi != "douteux")%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non-epileptic", "epileptic"),
         les.epi = ifelse(les.epi == "lesion epileptogene", "epileptogenic lesion", "no epileptogenic lesion"),
         EEG.result_resume = ifelse(is.na(EEG.result_resume) | EEG.result_resume == "slow", "no spikes", "spikes"),
         EEG.lt.result_resume = ifelse(is.na(EEG.lt.result_resume) | EEG.lt.result_resume == "slow", "no spikes", "spikes"))%>%
  mutate(EEG_LT_y_n <- ifelse(res.lt.EEG == "aucun" | res.lt.EEG == "aucun mais propose", "no", "yes"),
         to_remove = ifelse(EEG.result_resume == "no spikes" & EEG_LT_y_n == "no", "remove", "keep"))%>%
  filter(to_remove == "keep")%>% 
  select(code.pat, dx.dicho, les.epi, EEG.result_resume, EEG.lt.result_resume, pointes.1st.EEG, pointes.lt.EEG, dx.event)


# Probability of being epileptic without any exam in the sample
data_tree_exams%>%
  group_by(dx.dicho)%>%
  summarise(N = n())

# Probability of being epileptic according to epileptogenic lesion
data_tree_exams%>%
  group_by(les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion")

data_tree_exams%>%
  group_by(les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion")

# Probability of being epileptic according to epileptogenic lesion and Std EEG
data_tree_exams%>%
  group_by(EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion" & EEG.result_resume == "no spikes")

data_tree_exams%>%
  group_by(EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion" & EEG.result_resume == "spikes")

data_tree_exams%>%
  group_by(EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion" & EEG.result_resume == "no spikes")

data_tree_exams%>%
  group_by(EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion" & EEG.result_resume == "spikes")

# Probability of being epileptic according to epileptogenic lesion, Std EEG and LT EEG

data_tree_exams%>%
  group_by(EEG.lt.result_resume, EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion" & EEG.result_resume == "no spikes" & EEG.lt.result_resume == "no spikes")

data_tree_exams%>%
  group_by(EEG.lt.result_resume, EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion" & EEG.result_resume == "no spikes" & EEG.lt.result_resume == "spikes")


data_tree_exams%>%
  group_by(EEG.lt.result_resume, EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion" & EEG.result_resume == "no spikes" & EEG.lt.result_resume == "no spikes")

data_tree_exams%>%
  group_by(EEG.lt.result_resume, EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion" & EEG.result_resume == "no spikes" & EEG.lt.result_resume == "spikes")

```



## Evolution of the diagnosis over time

```{r Diagnosis evolution, warning=FALSE, message=FALSE, fig.height=4, fig.width=4}

# Evolution of the diagnosis --> all patients
delay_dx_all <- data_full_cleaned%>%
  filter(!is.na(date.1st.cs.su),!is.na(date.dx.final))%>%
  mutate(delay.1st_epi_dx_fin = as_date(date.dx.final) - as_date(date.1st.cs.su))%>%
  filter(delay.1st_epi_dx_fin >= 0)%>%
  summarise(MEAN = round(mean(delay.1st_epi_dx_fin, na.rm = T),2),
            SD = round(sd(delay.1st_epi_dx_fin, na.rm = T),2))

# Evolution of the diagnosis --> epi patients
delay_dx_epi <- data_full_cleaned%>%
  filter(dx.event == "Epilepsy")%>%
  filter(!is.na(date.1st.cs.su),!is.na(date.dx.final))%>%
  mutate(delay.1st_epi_dx_fin = as_date(date.dx.final) - as_date(date.1st.cs.su))%>%
  filter(delay.1st_epi_dx_fin >= 0)%>%
  summarise(MEAN = round(mean(delay.1st_epi_dx_fin, na.rm = T),2),
            SD = round(sd(delay.1st_epi_dx_fin, na.rm = T),2))

# Evolution of the diagnosis --> non epi patients
delay_dx_non_epi <- data_full_cleaned%>%
  filter(dx.event != "Epilepsy" | is.na(dx.event))%>%
  filter(!is.na(date.1st.cs.su),!is.na(date.dx.final))%>%
  mutate(delay.1st_epi_dx_fin = as_date(date.dx.final) - as_date(date.1st.cs.su))%>%
  filter(delay.1st_epi_dx_fin >= 0)%>%
  mutate(dx_first_consult = ifelse(delay.1st_epi_dx_fin == 0, "first_cs", "later"))%>%
  summarise(MEAN = round(mean(delay.1st_epi_dx_fin, na.rm = T),2),
            SD = round(sd(delay.1st_epi_dx_fin, na.rm = T),2))


# Model difference in the delay between epileptic and non-epileptic patients
data_glm_delay <- data_full_cleaned%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non_epi", "epi"))%>%
  filter(!is.na(date.1st.cs.su),!is.na(date.dx.final))%>%
  mutate(delay.1st_epi_dx_fin = as_date(date.dx.final) - as_date(date.1st.cs.su),
         delay.1st_epi_dx_fin = as.numeric(delay.1st_epi_dx_fin))%>%
  filter(delay.1st_epi_dx_fin >= 0)%>%
  select(code.pat, delay.1st_epi_dx_fin, dx.dicho)

ggplot(data_glm_delay, aes(x = delay.1st_epi_dx_fin))+geom_histogram() # Count data with typical Poisson distribution --> fig not included in the paper

mdelay_dx <- glm(delay.1st_epi_dx_fin ~ dx.dicho, data = data_glm_delay, family = "poisson")
output_res_delay <- report_glm(mdelay_dx)

# Does the delay until the final diagnosis impacts the relapse rate ?
data_glm_RR <- data_full_cleaned%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non_epi", "epi"))%>%
  filter(!is.na(date.1st.cs.su),!is.na(date.dx.final))%>%
  mutate(delay.1st_epi_dx_fin = as_date(date.dx.final) - as_date(date.1st.cs.su),
         delay.1st_epi_dx_fin = as.numeric(delay.1st_epi_dx_fin))%>%
  filter(delay.1st_epi_dx_fin >= 0)%>%
  mutate(dx_first_consult = ifelse(delay.1st_epi_dx_fin == 0, "first_cs", "later"))%>%
  select(code.pat, delay.1st_epi_dx_fin, dx.dicho, n.tot.recidives, dx_first_consult)


mdelay_RR <- glm(n.tot.recidives ~ delay.1st_epi_dx_fin*dx.dicho, data = data_glm_RR, family = "poisson")
output_res_RR <- report_glm(mdelay_RR)

ggplot(data_glm_RR, aes(x = delay.1st_epi_dx_fin, y = n.tot.recidives, color = dx.dicho))+geom_point()+geom_smooth(method = "lm", se = F) # Not included in the paper

```


Among all patients the delay between the first episode and the final diagnosis was on average of `r as.numeric(delay_dx_all$MEAN)` days (SD = `r as.numeric(delay_dx_all$SD)`). According to a generalized linear model following a Poisson distribution, epileptic patients (M= `r as.numeric(delay_dx_epi$MEAN)`; SD= `r delay_dx_epi$SD`) were diagnosed significantly faster compared to non-epileptic patients (M = `r as.numeric(delay_dx_non_epi$MEAN)`; SD = `r delay_dx_non_epi$SD`; `r output_res_delay$report`). Moreover, as shown in Table/Appendix 7/1, a second generalized linear model fitting a Poisson distribution suggested a main effect of the delay until the final diagnosis (`r output_res_RR$report[1]`), stressing that the faster the diagnosis, the lower the relapse rate. There was moreover a main effect of diagnosis (epileptic; non-epileptic;  `r output_res_RR$report[2]`), implying a higher relapse rate for epileptic than for non-epileptic patients, and a significant interaction between the diagnosis and the delay until the final diagnosis is reached (`r output_res_RR$report[3]`). The latter explains the fact that epileptic patients tend to have more relapses than non-epileptic patients, but the incrase in relapse rate according to the delay until the final diagnosis is not as dramatic as for non-epileptic patients. 

`r kable(round(summary(mdelay_RR)$coefficients,3))`

*Table 7/Appendix X: summary table of the generalized linear model built to investigate the effect of the delay between first episode and final diagnosis, as well as the dichotomic diagnosis (epileptic vs. non-epileptic) on the number of relapses. Given the distribution of the number of relapses, the model was fitted according to a Poisson distribution.*

## Mortality

```{r Mortality}
# Proportion of patients who deceased in the 2 years follow-up

data_dead <- data_full_cleaned%>%
  dplyr::mutate(alive = ifelse(!is.na(date.deces) | !is.na(cause.deces), "dead", "alive"),
                dx.dicho = ifelse(dx.event == "Epilepsy", "epi", "non-epi"),
                dx.dicho = ifelse(is.na(dx.dicho), "non-epi", dx.dicho))%>%
  dplyr::group_by(alive)%>%
  dplyr::summarise(N = n(),
            mean_age = round(mean(age),2),
            sd_age = round(sd(age),2))


data_dead_HF <- data_full_cleaned%>%
  dplyr::mutate(alive = ifelse(!is.na(date.deces) | !is.na(cause.deces), "dead", "alive"),
                dx.dicho = ifelse(dx.event == "Epilepsy", "epi", "non-epi"),
                dx.dicho = ifelse(is.na(dx.dicho), "non-epi", dx.dicho))%>%
  dplyr::group_by(alive, genre)%>%
  dplyr::summarise(N = n(),
            mean_age = round(mean(age),2),
            sd_age = round(sd(age),2))

# Difference in proportion between epileptic and non-epileptic patients regarding the mortality rate

datachi <- data_full_cleaned%>%
  dplyr::mutate(alive = ifelse(!is.na(date.deces) | !is.na(cause.deces), "dead", "alive"),
                dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non-epi", "epi"))%>%
  dplyr::group_by(dx.dicho,alive)%>%
  summarise(N = n())%>%
  spread(key = alive, value = N)

datachi <- as.data.frame(datachi)
rownames(datachi) <- datachi$dx.dicho
datachi$dx.dicho <- NULL

chi_dead <- chisq.test(datachi) 

```


Among the entire sample, `r data_dead$N[data_dead$alive == "dead"]` patients deceased during the two year follow-up (`r pct.fun(sum(data_dead_HF$N[data_dead$alive == "dead"]), tot_pat)`; mean age = `r data_dead$mean_age[data_dead$alive =="dead"]`, `r data_dead_HF$N[data_dead_HF$alive =="dead" & data_dead_HF$genre == "F"]` females and `r data_dead_HF$N[data_dead_HF$alive =="dead" & data_dead_HF$genre == "H"]` males). In the epileptic group (N = `r datachi$dead[1]`/`r tot_epi_disease`; `r pct.fun(datachi$dead[1],tot_epi_disease) `), this proportion is significantly larger than in the non-epileptic group (N = `r datachi$dead[2]`/`r tot_non_epi`; `r pct.fun(datachi$dead[2],tot_non_epi)`; `r report_chi(chi_dead)`), which is mainly due to patients with epilepsy and dementia or brain tumors. Two epileptic patients died from other causes (one of them from cardiac origin and the other one from severe hypernatremia and infection) and for six patients the cause of the death remained unclear. None of the patients experienced death related directly to an epileptic seizure. 


## Relapse rate

```{r Relapse rate, fig.height= 4, fig.width= 4}
# Descriptive statistics

mean_RR <- round(mean(data_full_cleaned$n.tot.recidives, na.rm = T),2)
sd_RR <- round(sd(data_full_cleaned$n.tot.recidives, na.rm = T),2)

mean_RR_epi <- round(mean(data_full_cleaned$n.tot.recidives[data_full_cleaned$dx.event == "Epilepsy"], na.rm = T),2)
sd_RR_epi <- round(sd(data_full_cleaned$n.tot.recidives[data_full_cleaned$dx.event == "Epilepsy"], na.rm = T),2)

mean_RR_non_epi <- round(mean(data_full_cleaned$n.tot.recidives[data_full_cleaned$dx.event != "Epilepsy"| is.na(data_full_cleaned$dx.event)], na.rm = T),2)
sd_RR_non_epi <- round(sd(data_full_cleaned$n.tot.recidives[data_full_cleaned$dx.event != "Epilepsy" | is.na(data_full_cleaned$dx.event)], na.rm = T),2)


data_lm_RR <- data_full_cleaned%>%
  mutate(more_1_event = ifelse(SBB.1 > 1, "many", "one"))%>%
  filter(!is.na(code.pat))%>%
  mutate(dx_paste = ifelse(dx.final == "crise epilepsie", paste(dx.final, type.epi.final),dx.final),
         tumoral = ifelse(les.CT == "tumoral" | les.IRM == "tumoral","operated", "not_operated"))%>%
  select(code.pat, n.tot.recidives, dx.final, type.epi.final, more_1_event, dx_paste, dx.final, operated)

RR_per_dx <- data_lm_RR%>%
  group_by(dx_paste)%>%
  summarise(mean_RR = round(mean(n.tot.recidives, na.rm = T),2),
            sd_RR = round(sd(n.tot.recidives, na.rm = T),2))

N_event_data_RR <-  data_full_cleaned%>%
  mutate(more_1_event = ifelse(SBB.1 > 1, "many", "one"))%>%
  filter(!is.na(code.pat))%>%
  mutate(dx_paste = ifelse(dx.final == "crise epilepsie", paste(dx.final, type.epi.final),dx.final),
         tumoral = ifelse(les.CT == "tumoral" | les.IRM == "tumoral","operated", "not_operated"))%>%
  select(code.pat, n.tot.recidives, dx.final, type.epi.final, more_1_event, dx_paste, dx.final, operated)%>%
  group_by(more_1_event)%>%
  summarise(mean_RR =  round(mean(n.tot.recidives, na.rm = T),2),
            sd_RR = round(sd(n.tot.recidives, na.rm = T),2))%>%
  filter(!is.na(more_1_event))


# Definition of the data for the glm model

hist(data_full_cleaned$n.tot.recidives)
model_RR <- glm(n.tot.recidives ~ dx_paste + more_1_event, family = "poisson", data = data_lm_RR)
library(car)
vif(model_RR)
post_hocs_RR<- emmeans(model_RR, list(pairwise ~ dx_paste), adjust = "tukey")
post_hocs_RR <- as.data.frame(post_hocs_RR$`pairwise differences of dx_paste`)
report_post_hoc_RR <- report_emmeans(post_hocs_RR)

res_model_RR <- report_glm(model_RR)
```

The average relapse rate (RR), i.e. the mean number of relapses among all patients is `r mean_RR` (SD = `r sd_RR`). Among epileptic patients, the rate was in average `r mean_RR_epi` (SD = `r sd_RR_epi`), while non-epiltptic patients presented a rate of `r mean_RR_non_epi` (SD = `r sd_RR_non_epi`). More precisely among diagnoses, the RR for patients with IGE was on average `r RR_per_dx$mean_RR[2]` (SD = `r RR_per_dx$sd_RR[2]`), and was significantly lower that that of NLE (RR = `r RR_per_dx$mean_RR[5]`; SD =  `r RR_per_dx$sd_RR[5]`; `r report_post_hoc_RR$report[13]`), who showed the highest RR, but significantly higher than the vagal (RR = `r RR_per_dx$mean_RR[8]`; SD = `r RR_per_dx$sd_RR[8]`; `r report_post_hoc_RR$report[37]`) and cardiovascular groups (RR = `r RR_per_dx$mean_RR[10]`; SD = `r RR_per_dx$sd_RR[10]`; `r report_post_hoc_RR$report[39]`). The SE group (RR = `r RR_per_dx$mean_RR[4]`; SD = `r RR_per_dx$sd_RR[4]`) showed higher RR than several non-epilepsy patients, namely the vasovagal syncopes (RR = `r RR_per_dx$mean_RR[8]`; SD = `r RR_per_dx$sd_RR[8]`; `r report_post_hoc_RR$report[31]`), cardiovascular (RR = `r RR_per_dx$mean_RR[11]`; SD = `r RR_per_dx$sd_RR[11]`; `r report_post_hoc_RR$report[33]`), and PNES groups (RR = `r RR_per_dx$mean_RR[11]`; SD = `r RR_per_dx$sd_RR[11]`; `r report_post_hoc_RR$report[34]`). Nevertheless, the SE group showed a lower RR compared to the NLE group (RR = `r RR_per_dx$mean_RR[5]`; SD = `r RR_per_dx$sd_RR[5]`; `r report_post_hoc_RR$report[28]`). As expected, the latter showed a higher RR than the acute seizures (RR = `r RR_per_dx$mean_RR[6]`; SD = `r RR_per_dx$sd_RR[6]`; `r report_post_hoc_RR$report[35]`), vaso-vagal syncopes (RR = `r RR_per_dx$mean_RR[8]`; SD = `r RR_per_dx$sd_RR[8]`; `r report_post_hoc_RR$report[37]`), cardiac (RR = `r RR_per_dx$mean_RR[9]`; SD = `r RR_per_dx$sd_RR[9]`; `r report_post_hoc_RR$report[38]`), cardiovascular (RR = `r RR_per_dx$mean_RR[10]`; SD = `r RR_per_dx$sd_RR[10]`; `r report_post_hoc_RR$report[39]`), and PNES groups (RR = `r RR_per_dx$mean_RR[11]`; SD = `r RR_per_dx$sd_RR[11]`; `r report_post_hoc_RR$report[40]`). Finally, patients who presented acute symptomatic seizures had higher RR than vaso-vagal syncopes (RR = `r RR_per_dx$mean_RR[8]`; SD = `r RR_per_dx$sd_RR[8]`; `r report_post_hoc_RR$report[42]`), cardiovascular (RR = `r RR_per_dx$mean_RR[10]`; SD = `r RR_per_dx$sd_RR[10]`; `r report_post_hoc_RR$report[44]`), and PNES patients (RR = `r RR_per_dx$mean_RR[11]`; SD = `r RR_per_dx$sd_RR[11]`; `r report_post_hoc_RR$report[45]`). 
Interestingly, patients for whom the index of the event was not the first one also significantly tend to have a higher RR (first event: RR = `r N_event_data_RR$mean_RR[N_event_data_RR$more_1_event == "one"]`; SD = `r N_event_data_RR$sd_RR[N_event_data_RR$more_1_event == "one"]`; not the first event: RR = `r N_event_data_RR$mean_RR[N_event_data_RR$more_1_event == "many"]`; SD = `r N_event_data_RR$sd_RR[N_event_data_RR$more_1_event == "many"]`; `r res_model_RR$report[11]`), stressing again the importance of a swift intervention after the first event.

```{r plot relapses, fig.height= 6, fig.width= 16}

# Plot number of relapses per diagnosis

plot.RR <- data_lm_RR %>%
  group_by(dx_paste)%>%
  summarise(MEAN = round(mean(n.tot.recidives, na.rm = T),2),
            Std_err = round(std_error(n.tot.recidives, na.rm = T),2))%>%
  mutate(good_dx = case_when(dx_paste == "autres" ~ "Other",
                             dx_paste == "crise epilepsie generalisee idiopathique" ~ "IGE",
                             dx_paste == "crise epilepsie indetermine" ~ "Unknown epilepsy type",
                             dx_paste == "crise epilepsie lesionnelle" ~ "Lesional epilepsy",
                             dx_paste == "crise epilepsie non lesionnelle" ~ "Non-lesional epilepsy",
                             dx_paste == "crise provoquee" ~ "Acute symptomatic seizure",
                             dx_paste == "indetermine" ~ "Unknown",
                             dx_paste == "malaise vagal" ~ "Vasovagal syncope",
                             dx_paste == "origine cardiaque" ~ "Cardiac",
                             dx_paste == "origine cardiovasculaire" ~ "Cardiovascular",
                             dx_paste == "psychogene" ~ "PNES"))%>%
  filter(dx_paste != "cardiaque")%>%
  ggplot(aes(x = good_dx, y = MEAN)) + 
  geom_bar(stat = "identity", alpha = 0.7)+
  geom_errorbar(aes(x = good_dx, ymin = MEAN-Std_err, ymax = MEAN+Std_err), col = "gray47", width = 0.5)+
  geom_text(aes(label = paste(round(MEAN,2), " (", round(Std_err,2),')', sep = '')), vjust = -1)+
  theme_minimal()+
  labs(x = "Diagnosis", y = "Mean relapse rate per patient")

data_operated_RR <- data_lm_RR%>%
  group_by(operated)%>%
  summarise(MEAN_RR = mean(n.tot.recidives, na.rm = T),
            SD_RR = sd(n.tot.recidives, na.rm = T),
            MEDIAN = median(n.tot.recidives, na.rm = T))


plot.RR
```

*Figure 2: average relapse rate in terms of number of reported events and number of ED consultations from the first seizure among all diagnoses.*

## Predictive models

### A classifier to identify the best predictors of epilepsy diagnosis

```{r First classifier}

set.seed(2020)

# Preparation of the data
data_RF_outcome_single_tree(data_full_cleaned)

# Random forest model
# Definition of the model
RF_model <- randomForest(res.dx.final ~ ., data = data_RF_train, 
                         ntree = 2000)

# Estimation of the mean decrease gini
gini <- importance(RF_model)
gini <- data.frame(rownames(gini), gini)
gini$MeanDecreaseGini <- round(gini$MeanDecreaseGini,2) 
gini <- arrange(gini,desc( MeanDecreaseGini))

# Prediction, confusion matrix and accuracy
prediction <- predict(RF_model, newdata = data_RF_test, type = "class")
conf_mat <- table(prediction, labels_final_test_RF)
acc <- round(mean(labels_final_test_RF == prediction),4)*100

# ROC curve
# Calculate the probability of new observations belonging to each class
# prediction_for_roc_curve will be a matrix with dimensions data_set_size x number_of_classes
prediction_for_roc_curve <- predict(RF_model,data_RF_test,type="prob")
# Use pretty colours:
pretty_colours <- c("#F8766D","#00BA38")
# Specify the different classes 
classes <- levels(data_RF$res.dx.final)
# For each class
save_auc <- as.numeric()
for (i in 1:2){
  # Define which observations belong to class[i]
  true_values <- ifelse(labels_final_test_RF==classes[i],1,0)
  # Assess the performance of classifier for class[i]
  pred <- prediction(prediction_for_roc_curve[,i],true_values)
  perf <- performance(pred, "tpr", "fpr")
  if (i==1)
  {
    plot(perf,main="ROC Curve",col=pretty_colours[i]) 
  }
  else
  {
    plot(perf,main="ROC Curve",col=pretty_colours[i],add=TRUE) 
  }
  # Calculate the AUC and print it to screen
  auc.perf <- performance(pred, measure = "auc")
  save_auc[i] <- auc.perf@y.values
}

legend(x = 0.8, y= 0.8, legend = classes, fill = pretty_colours, col = pretty_colours)

save_auc <- do.call(rbind, save_auc)
res_auc <- data.frame(classes, save_auc)

# Predictive ability of an MD in the ER
data_MD <- data_full_cleaned%>%
  mutate(type.epi.initial = case_when(type.epi.initial == "cryptogenique" ~ "non lesionnelle",
                                      type.epi.initial == "focale symptomatique" ~ "lesionnelle",
                                      TRUE ~ type.epi.initial))%>%
  mutate(dx_ini_paste = paste(dx.initial, type.epi.initial),
         dx_fin_paste = paste(dx.final, type.epi.final))%>%
  filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(les.epi != "aucun")%>%
  filter(status.neuro != "aucun" &  status.neuro != "aucun mais propose" & status.neuro != "non documente")%>%
  filter(veille.sommeil != "non documente")%>%
  select(dx_ini_paste, dx_fin_paste)

# confusion matrix and accuracy
conf_mat_MD <- table(data_MD$dx_ini_paste, data_MD$dx_fin_paste)
acc_MD <- round(mean(data_MD$dx_ini_paste == data_MD$dx_fin_paste),4)*100

N_first_RF_model <- nrow(data_RF)

```


The average accuracy of the Random Forest model was `r acc`%, while the area under the curve was `r round(res_auc$save_auc[1],2)` (see the ROC curve in Figure 3). The ability of the model to predict a diagnosis, was `r pct.fun(conf_mat[1,1],sum(conf_mat[1,1], conf_mat[2,1]))` (`r conf_mat[1,1]`/`r sum(conf_mat[1,1], conf_mat[2,1])`) patients correctly classified in the test dataset) of true positive for the epileptic patients and `r pct.fun(conf_mat[2,2], sum(conf_mat[2,2], conf_mat[1,2]))` (`r conf_mat[2,2]`/`r conf_mat[1,2]` patients correctly classified in the test dataset) for the non-epileptic patients. As a comparison point, if confronting the initially suggested diagnosis in the ED compared to the final diagnosis after at maximum two years of follow-up, the predictive ability of a clinician in the ED was `r acc_MD`% (to predict if a patient is epileptic or not), among which the percentage of true positives for epileptic patients was `r pct.fun(conf_mat_MD[1,1], sum(conf_mat_MD[1,1], conf_mat_MD[2,1]))` (`r conf_mat_MD[1,1]`/`r sum(conf_mat_MD[1,1], conf_mat_MD[2,1])` patients correctly classified) and `r pct.fun(conf_mat_MD[2,2], sum(conf_mat_MD[2,2], conf_mat_MD[1,2]))` (`r conf_mat_MD[2,2]`/ `r sum(conf_mat_MD[2,2], conf_mat_MD[1,2])` patients correctly classified) for non-epileptic patients.

`r kable(gini)`

*Table 8: Mean Decrease Gini indexes among the predictors. The higher the score, the higher the importance of the factor for the model. The Gini scores are standardized in percent.*


**Probability tree based on the three best factors explained by the model**

```{r decision tree diagnosis RF model}

# Decision tree based on the 3 highest mean decrease gini
data_tree_RF <- data_full_cleaned%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(les.epi != "douteux")%>%
  filter(veille.sommeil != "non documente")%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non-epileptic", "epileptic"),
         les.epi = ifelse(les.epi == "lesion epileptogene", "epileptogenic lesion", "no epileptogenic lesion"),
         EEG.result_resume = ifelse(is.na(EEG.result_resume) | EEG.result_resume == "slow", "no spikes", "spikes"))%>%
  select(code.pat, dx.dicho, les.epi, EEG.result_resume, veille.sommeil)

# P of being epileptic without other information
data_tree_RF%>%
  group_by(dx.dicho)%>%
  summarise(N = n())

# P of being epileptic given MRI results
data_tree_RF%>%
  group_by(les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion")

data_tree_RF%>%
  group_by(les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion")

# P of being epileptic given MRI and std EEG results
data_tree_RF%>%
  group_by(EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion", EEG.result_resume == "no spikes")

data_tree_RF%>%
  group_by(EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion", EEG.result_resume == "spikes")

data_tree_RF%>%
  group_by(EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion", EEG.result_resume == "no spikes")

data_tree_RF%>%
  group_by(EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion", EEG.result_resume == "spikes")

# P of being epileptic given MRI, std EEG results and time of the event

data_tree_RF%>%
  group_by(veille.sommeil, EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion", EEG.result_resume == "no spikes", veille.sommeil == "veille")

data_tree_RF%>%
  group_by(veille.sommeil, EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion", EEG.result_resume == "no spikes", veille.sommeil == "sommeil")

data_tree_RF%>%
  group_by(veille.sommeil, EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion", EEG.result_resume == "spikes", veille.sommeil == "veille")

data_tree_RF%>%
  group_by(veille.sommeil, EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion", EEG.result_resume == "spikes", veille.sommeil == "sommeil")

data_tree_RF%>%
  group_by(veille.sommeil, EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion", EEG.result_resume == "no spikes", veille.sommeil == "veille")

data_tree_RF%>%
  group_by(veille.sommeil, EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion", EEG.result_resume == "no spikes", veille.sommeil == "sommeil")

data_tree_RF%>%
  group_by(veille.sommeil, EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion", EEG.result_resume == "spikes", veille.sommeil == "veille")

data_tree_RF%>%
  group_by(veille.sommeil, EEG.result_resume, les.epi, dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "epileptogenic lesion", EEG.result_resume == "spikes", veille.sommeil == "sommeil")

```

**END Probability tree based on the three best factors explained by the model**


### Yield of the LT EEG in the diagnosis of epilepsy

```{r LT-EEG classifier}
# Data importation 
data_RF_outcome_single_tree_LT(data_full_cleaned)

# prediction on all variable except LT EEG
data_RF_wo_LT <- data_RF%>%
  select(-lt_eeg)
data_RF_train_wo_LT <- data_RF_train%>%
  select(-lt_eeg)
data_RF_test_wo_LT <- data_RF_test%>%
  select(-lt_eeg)

# Model without the LT EEG
model_wo_LT <- randomForest(res.dx.final ~ ., data = data_RF_train_wo_LT, ntree = 2000)
prediction_wo_LT <- predict(model_wo_LT, newdata = data_RF_test_wo_LT, type = "class")
conf_mat_wo_LT <- table(prediction_wo_LT, labels_final_test_RF)
acc_wo_lt <- round(mean(prediction_wo_LT == labels_final_test_RF),4)*100

gini_wo_LT <- importance(model_wo_LT)
gini_wo_LT <- data.frame(rownames(gini_wo_LT), gini_wo_LT)
gini_wo_LT$MeanDecreaseGini <- round(gini_wo_LT$MeanDecreaseGini,2) 
gini_wo_LT <- arrange(gini_wo_LT,desc(MeanDecreaseGini))

# Model with the LT EEG
model_w_LT <- randomForest(res.dx.final ~ ., data = data_RF_train, ntree = 2000)
prediction_w_LT <- predict(model_w_LT, newdata = data_RF_test, type = "class")
conf_mat_w_LT <- table(prediction_w_LT, labels_final_test_RF)
acc_w_lt <- round(mean(prediction_w_LT == labels_final_test_RF),4)*100

gini_w_LT <- importance(model_w_LT)
gini_w_LT <- data.frame(rownames(gini_w_LT), gini_w_LT)
gini_w_LT$MeanDecreaseGini <- round(gini_w_LT$MeanDecreaseGini,2) 
gini_w_LT <- arrange(gini_w_LT,desc(MeanDecreaseGini))

```


To overcome this difficulty, we proposed to include the same patients as for the first predictive model, but filtering only patients with a LT EEG (N = `r nrow(data_RF)`). 

`r  kable(gini_wo_LT)` `r kable(gini_w_LT)` 

*Table 9: Mean Decrease Gini of two Random Forest algorithms. The first one does not include the results of the LT EEG as a predictor while the second one does.*

The accuracy of the model which did not include the results of the LT EEG among the predictors is `r acc_wo_lt`%. The model including the LT EEG results performed much better, with an accuracy rate of `r acc_w_lt`%, which suggests an impressive yield in the predictive abilities of the model by `r acc_w_lt-acc_wo_lt`%. 




A REGARDER DEMAIN AVEC LES IDEES CLAIRES
```{r}
temp <- data_full_cleaned%>%
  filter(pointes.1st.EEG != "focale" & pointes.1st.EEG != "diffuse" & res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(pointes.lt.EEG != "focale" & pointes.lt.EEG != "diffuse" & res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(les.epi == "normal" | les.epi == "lesion non epileptogene")%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")

data_full_cleaned%>%filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(EEG.result_resume == "slow" | is.na(EEG.result_resume))%>%
  filter(res.lt.EEG != "aucun" & res.lt.EEG != "aucun mais propose")%>%
  filter(EEG.lt.result_resume == "slow" | is.na(EEG.lt.result_resume))%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(les.epi != "lesion epileptogene")%>%
  select(pointes.1st.EEG, pointes.lt.EEG, res.IRM, les.epi)%>%
  filter(les.epi == "douteux")


data_tree_exams <- data_full_cleaned%>%
  filter(res.IRM != "aucun" & res.IRM != "aucun mais propose")%>%
  filter(res.1st.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(res.lt.EEG != "aucun" & res.1st.EEG != "aucun mais propose")%>%
  filter(les.epi != "douteux")%>%
  mutate(dx.dicho = ifelse(dx.event != "Epilepsy" | is.na(dx.event), "non-epileptic", "epileptic"),
         les.epi = ifelse(les.epi == "lesion epileptogene", "epileptogenic lesion", "no epileptogenic lesion"),
         EEG.result_resume = ifelse(is.na(EEG.result_resume) | EEG.result_resume == "slow", "no spikes", "spikes"),
         EEG.lt.result_resume = ifelse(is.na(EEG.lt.result_resume) | EEG.lt.result_resume == "slow", "no spikes", "spikes"))%>%
  select(code.pat, dx.dicho, les.epi, EEG.result_resume, EEG.lt.result_resume, pointes.1st.EEG, pointes.lt.EEG, dx.event)

data_tree_exams%>%
  group_by(EEG.lt.result_resume, EEG.result_resume, les.epi,dx.dicho)%>%
  summarise(N = n())%>%
  filter(les.epi == "no epileptogenic lesion" & EEG.result_resume == "no spikes" & EEG.lt.result_resume == "no spikes")

```

